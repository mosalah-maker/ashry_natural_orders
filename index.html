<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ashry Natural - نظام إدارة الطلبات</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
  <style>
    :root {
      --p: #1e3c72;
      --s: #2a5298;
      --d: #e74c3c;
      --g: #27ae60;
      --o: #f39c12;
      --l: #f8fbff;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Tajawal', sans-serif;
    }
    
    body {
      background: #f0f2f5;
      color: #333;
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .sidebar {
      width: 280px;
      background: var(--p);
      color: #fff;
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      padding: 20px;
      z-index: 1000;
      transition: .35s;
      box-shadow: -5px 0 20px rgba(0,0,0,.15);
      overflow-y: auto;
    }
    
    .sidebar h2 {
      text-align: center;
      font-size: 26px;
      margin-bottom: 40px;
      font-weight: 900;
    }
    
    .sidebar a {
      display: block;
      color: #fff;
      padding: 16px 20px;
      border-radius: 12px;
      margin: 8px 0;
      text-decoration: none;
      font-weight: 500;
      transition: .3s;
      cursor: pointer;
    }
    
    .sidebar a i {
      margin-left: 12px;
    }
    
    .sidebar a:hover,
    .sidebar a.active {
      background: var(--s);
      transform: translateX(-8px);
    }
    
    .main {
      margin-right: 280px;
      padding: 20px;
      width: 100%;
      transition: .35s;
      min-height: 100vh;
    }
    
    .card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,.1);
      padding: 25px;
      margin-bottom: 25px;
    }
    
    input, select, button, textarea {
      width: 100%;
      padding: 14px 18px;
      margin: 12px 0;
      border-radius: 12px;
      border: 1px solid #ddd;
      font-size: 16px;
      transition: .3s;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--p);
      box-shadow: 0 0 0 3px rgba(30,60,114,.15);
    }
    
    button {
      background: var(--p);
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: bold;
      padding: 15px;
      border-radius: 12px;
      transition: .3s;
    }
    
    button:hover {
      background: var(--s);
    }
    
    button.danger {
      background: var(--d);
    }
    
    button.success {
      background: var(--g);
    }
    
    button.orange {
      background: var(--o);
      color: #fff;
    }
    
    button.print-btn {
      background: #16a085;
      color: #fff;
    }
    
    button.small {
      padding: 8px 15px;
      font-size: 14px;
      margin: 5px;
    }
    
    button:disabled {
      background: #999;
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 25px 0;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 20px rgba(0,0,0,.08);
    }
    
    th {
      background: var(--p);
      color: #fff;
      padding: 16px;
      text-align: center;
    }
    
    td {
      padding: 14px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }
    
    tr:hover {
      background: var(--l);
    }
    
    .badge {
      padding: 6px 16px;
      border-radius: 50px;
      font-size: 13px;
      font-weight: bold;
    }
    
    .badge.new {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .badge.processing {
      background: #fff3e0;
      color: #f57c00;
    }
    
    .badge.delivered {
      background: #e8f5e8;
      color: #27ae60;
    }
    
    .searchable-select {
      position: relative;
    }
    
    .searchable-select input {
      width: 100%;
      padding: 14px 40px 14px 18px;
    }
    
    .searchable-select i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #777;
    }
    
    .cart-item {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 12px;
      margin: 10px 0;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      position: relative;
      padding-right: 80px;
    }
    
    .cart-item img {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 8px;
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
    }
    
    .cart-total {
      background: var(--p);
      color: #fff;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      font-size: 26px;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .discount-toggle {
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 18px;
      background: #fff8e1;
      padding: 15px;
      border-radius: 12px;
      flex-wrap: wrap;
    }
    
    .switch {
      position: relative;
      display: inline-block;
      width: 70px;
      height: 34px;
    }
    
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background: var(--o);
    }
    
    input:checked + .slider:before {
      transform: translateX(36px);
    }
    
    .action-btns button {
      margin: 5px;
    }
    
    #menuBtn {
      display: none;
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 9999;
      background: var(--p);
      color: #fff;
      border: none;
      padding: 12px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,.2);
    }
    
    .export-btn {
      margin: 10px 5px;
      padding: 14px 25px;
      font-size: 16px;
    }
    
    .product-img-preview {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    .product-img-table {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
    }
    
    .loading {
      color: #1976d2;
      font-weight: bold;
      text-align: center;
      margin: 20px 0;
      font-size: 18px;
      display: none;
    }
    
    .remove-item-btn {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: #e74c3c;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }
    
    .barcode-section {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
      border: 2px dashed #ddd;
    }
    
    .barcode-container {
      position: relative;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }
    
    .barcode-scanner {
      width: 100%;
      height: 400px;
      background: #000;
      border-radius: 12px;
      object-fit: cover;
    }
    
    .barcode-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 18px;
      border-radius: 12px;
      z-index: 10;
    }
    
    .barcode-controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }
    
    .barcode-controls button {
      width: auto;
      padding: 10px 20px;
    }
    
    .barcode-result {
      background: #e8f5e8;
      padding: 15px;
      border-radius: 12px;
      margin-top: 15px;
      text-align: center;
      display: none;
    }
    
    .barcode-result.success {
      background: #e8f5e8;
      color: #27ae60;
    }
    
    .barcode-result.error {
      background: #ffeaea;
      color: #e74c3c;
    }
    
    .barcode-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      cursor: pointer;
      padding: 10px;
      background: #fff;
      border-radius: 8px;
    }
    
    .barcode-toggle i {
      transition: transform 0.3s;
    }
    
    .barcode-toggle.active i {
      transform: rotate(180deg);
    }
    
    .barcode-input-group {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }
    
    .barcode-input-group input {
      flex: 1;
      margin: 0;
    }
    
    .barcode-input-group button {
      width: auto;
      padding: 10px 15px;
    }
    
    .scan-area {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 250px;
      border: 3px solid #fff;
      border-radius: 12px;
      box-shadow: 0 0 0 4000px rgba(0,0,0,0.5);
      z-index: 5;
      transition: all 0.3s ease;
    }
    
    .scan-area.scanning {
      border-color: #ffeb3b;
      animation: pulse 1.5s infinite;
    }
    
    .scan-area.success {
      border-color: #27ae60;
      background: rgba(39,174,96,0.1);
    }
    
    .scan-area.error {
      border-color: #e74c3c;
      background: rgba(231,76,60,0.1);
    }
    
    .scan-area-line {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: #27ae60;
      animation: scanLine 2s linear infinite;
      display: none;
    }
    
    .scan-area.scanning .scan-area-line {
      display: block;
    }
    
    .zoom-indicator {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      z-index: 10;
    }
    
    .scan-instructions {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 12px;
      z-index: 10;
      text-align: center;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 4000px rgba(0,0,0,0.5), 0 0 0 0 rgba(255,235,59,0.7); }
      70% { box-shadow: 0 0 0 4000px rgba(0,0,0,0.5), 0 0 0 10px rgba(255,235,59,0); }
      100% { box-shadow: 0 0 0 4000px rgba(0,0,0,0.5), 0 0 0 0 rgba(255,235,59,0); }
    }
    
    @keyframes scanLine {
      0% { top: 0; }
      100% { top: 100%; }
    }
    
    @media (max-width: 992px) {
      .sidebar {
        transform: translateX(100%);
        width: 280px;
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      .main {
        margin-right: 0;
        padding: 15px;
      }
      
      #menuBtn {
        display: block;
      }
    }
    
    @media (max-width: 576px) {
      .card {
        padding: 18px;
      }
      
      .main {
        padding: 10px;
      }
      
      .cart-item {
        flex-direction: column;
        text-align: center;
        padding-right: 15px;
        padding-left: 15px;
      }
      
      .cart-item img {
        position: static;
        transform: none;
        margin: 0 auto 10px;
      }
      
      .remove-item-btn {
        position: static;
        transform: none;
        margin-top: 10px;
      }
      
      table {
        font-size: 14px;
      }
      
      th, td {
        padding: 10px 6px;
      }
      
      .export-btn, .action-btns button {
        width: 100%;
        margin: 6px 0;
        display: block;
      }
      
      .discount-toggle {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .barcode-controls {
        flex-direction: column;
      }
      
      .barcode-controls button {
        width: 100%;
      }
      
      .barcode-input-group {
        flex-direction: column;
      }
      
      .barcode-input-group button {
        width: 100%;
      }
      
      .scan-area {
        width: 90%;
        height: 200px;
      }
      
      .barcode-scanner {
        height: 350px;
      }
    }
    
    #invoice {
      display: none;
      background: white;
      padding: 30px;
      border: 2px solid #333;
      border-radius: 12px;
      max-width: 800px;
      margin: 20px auto;
      box-shadow: 0 0 30px rgba(0,0,0,.3);
      font-size: 18px;
    }
    
    .invoice-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .invoice-header h1 {
      font-size: 36px;
      color: var(--p);
      margin-bottom: 10px;
      font-weight: 900;
    }
    
    .invoice-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 30px 0;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 12px;
    }
    
    .invoice-table {
      width: 100%;
      border-collapse: collapse;
      margin: 30px 0;
    }
    
    .invoice-table th {
      background: var(--p);
      color: white;
      padding: 15px;
      font-size: 18px;
    }
    
    .invoice-table td {
      padding: 15px;
      border-bottom: 1px solid #ddd;
      text-align: center;
      font-size: 17px;
    }
    
    .invoice-total {
      text-align: left;
      font-size: 28px;
      font-weight: bold;
      margin-top: 30px;
      padding: 25px;
      background: linear-gradient(135deg, #f8fbff, #e3f2fd);
      border-radius: 12px;
      color: var(--p);
    }
    
    .copyright-footer {
      text-align: center;
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #ddd;
      font-size: 14px;
      color: #666;
    }
    
    @media print {
      @page { margin: 1cm; }
      body * { visibility: hidden !important; }
      #invoice, #invoice * { visibility: visible !important; }
      #invoice {
        position: absolute !important;
        left: 0 !important;
        top: 0 !important;
        width: 100% !important;
      }
      .invoice-table, .invoice-table th, .invoice-table td {
        border: 1px solid black !important;
      }
      .invoice-table th {
        background: #1e3c72 !important;
        color: white !important;
      }
      .copyright-footer {
        color: #000 !important;
        font-size: 12px !important;
      }
    }
    
    .debug-info {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      font-size: 14px;
    }
    
    .debug-success {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    
    .debug-error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
  </style>
</head>
<body>

<button id="menuBtn" onclick="document.querySelector('.sidebar').classList.toggle('active')">
  <i class="fas fa-bars"></i>
</button>

<div class="sidebar">
  <h2>Ashry Natural</h2>
  <a onclick="window.showPage('dashboard')" class="active">الرئيسية</a>
  <a onclick="window.showPage('add-order')">طلب جديد</a>
  <a onclick="window.showPage('orders')">الطلبات</a>
  <a onclick="window.showPage('products')">المنتجات</a>
  <a onclick="window.logout()">تسجيل الخروج</a>
</div>

<div class="main">

  <div id="invoice">
    <div class="invoice-header">
      <h1>Ashry Natural</h1>
      <p>فاتورة رسمية</p>
    </div>
    <div class="invoice-details">
      <div><strong>اسم العميل:</strong> <span id="inv_name"></span></div>
      <div><strong>رقم الواتساب:</strong> <span id="inv_phone"></span></div>
      <div><strong>العنوان:</strong> <span id="inv_addr"></span></div>
      <div><strong>تاريخ الفاتورة:</strong> <span id="inv_date"></span></div>
    </div>
    <table class="invoice-table">
      <thead><tr><th>المنتج</th><th>الكمية</th><th>سعر الوحدة</th><th>الإجمالي</th></tr></thead>
      <tbody id="inv_items"></tbody>
    </table>
    <div class="invoice-total">
      الإجمالي النهائي: <span id="inv_total">0</span> جنيه مصري
    </div>
    <div style="text-align:center;margin-top:50px;font-size:22px;color:#27ae60">
      شكراً لثقتكم بنا<br><strong>Ashry Natural - صحتك تهمنا</strong>
    </div>
    <!-- إضافة حقوق الملكية في الفاتورة -->
    <div class="copyright-footer">
      تم تطوير النظام بواسطة المهندس محمد صلاح الزهيري<br>
      للتواصل: 01029149379
    </div>
  </div>

  <div id="login" class="card" style="max-width:420px;margin:100px auto;text-align:center">
    <h2 style="color:var(--p);margin-bottom:30px">Ashry Natural</h2>
    <form id="loginForm">
      <input type="email" id="email" placeholder="الإيميل" required>
      <input type="password" id="pass" placeholder="كلمة المرور" required>
      <button type="submit">دخول</button>
    </form>
  </div>

  <div id="dashboard" class="card" style="display:none">
    <h2>لوحة التحكم</h2>
    <p style="font-size:22px;color:var(--p);margin:20px 0" id="currentTime"></p>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:25px">
      <div class="stat" style="background:linear-gradient(135deg,var(--p),var(--s));color:#fff;padding:30px;border-radius:16px;text-align:center"><h3>إجمالي الطلبات</h3><h2 id="totalOrders">0</h2></div>
      <div class="stat" style="background:linear-gradient(135deg,#8e44ad,#9b59b6);color:#fff;padding:30px;border-radius:16px;text-align:center"><h3>طلبات اليوم</h3><h2 id="todayOrders">0</h2></div>
      <div class="stat" style="background:linear-gradient(135deg,var(--g),#2ecc71);color:#fff;padding:30px;border-radius:16px;text-align:center"><h3>تم التوصيل</h3><h2 id="completedOrders">0</h2></div>
      <div class="stat" style="background:linear-gradient(135deg,var(--o),#e67e22);color:#fff;padding:30px;border-radius:16px;text-align:center"><h3>إجمالي المبيعات</h3><h2 id="totalSales">0 جنيه</h2></div>
    </div>
    <!-- إضافة حقوق الملكية في لوحة التحكم -->
    <div class="copyright-footer">
      تم تطوير النظام بواسطة المهندس محمد صلاح الزهيري - للتواصل: 01029149379
    </div>
  </div>

  <div id="add-order" class="card" style="display:none">
    <h2>إضافة طلب جديد</h2>
    <form id="customerForm">
      <input type="text" placeholder="اسم العميل" id="cname" required>
      <input type="tel" placeholder="رقم الواتساب (مثلاً: 01029149379)" id="cphone" required>
      <input type="text" placeholder="العنوان كامل" id="caddr" required>
      <select id="status">
        <option value="جديد">جديد</option>
        <option value="تحت التجهيز">تحت التجهيز</option>
        <option value="تم التوصيل">تم التوصيل</option>
      </select>
    </form>
    <div class="discount-toggle">
      <label class="switch">
        <input type="checkbox" id="applyDiscount">
        <span class="slider"></span>
      </label>
      <span>تفعيل الخصم على كل المنتجات في هذا الطلب</span>
    </div>
    <hr style="margin:30px 0">
    
    <!-- قسم الباركود - محسن للدقة -->
    <div class="barcode-section">
      <div class="barcode-toggle" id="barcodeToggle">
        <i class="fas fa-barcode"></i>
        <span style="font-weight:bold">مسح الباركود بالكاميرا</span>
        <i class="fas fa-chevron-down" style="margin-right:auto"></i>
      </div>
      
      <div id="barcodeContent" style="display:none">
        <div class="barcode-container">
          <video id="barcode-scanner" class="barcode-scanner"></video>
          <div class="scan-area" id="scanArea">
            <div class="scan-area-line"></div>
          </div>
          <div class="scan-instructions" id="scanInstructions">
            <i class="fas fa-info-circle"></i> قرب الباركود من الكاميرا
          </div>
          <div class="zoom-indicator" id="zoomIndicator">
            <i class="fas fa-search"></i> المسافة المثالية: 15-20 سم
          </div>
          <div class="barcode-overlay" id="barcodeOverlay">
            <div style="text-align:center">
              <i class="fas fa-camera" style="font-size:48px;margin-bottom:15px;display:block"></i>
              جاري تشغيل الكاميرا...
              <div style="margin-top:15px;font-size:14px;color:#ddd">
                ضع الباركود داخل المستطيل ليتم التعرف عليه تلقائياً
              </div>
            </div>
          </div>
        </div>
        
        <div class="barcode-controls">
          <button id="flashToggle" class="orange">
            <i class="fas fa-lightbulb"></i> تشغيل الفلاش
          </button>
          <button id="focusCamera" class="orange">
            <i class="fas fa-crosshairs"></i> ضبط التركيز
          </button>
        </div>
        
        <div style="background:#f0f8ff;padding:15px;border-radius:12px;margin:15px 0;border-right:4px solid #1e3c72">
          <h4 style="color:#1e3c72;margin-bottom:10px"><i class="fas fa-lightbulb"></i> نصائح للمسح الدقيق:</h4>
          <ul style="color:#555;margin:0;padding-right:20px">
            <li>تأكد من إضاءة جيدة على الباركود</li>
            <li>حافظ على مسافة 15-20 سم بين الكاميرا والباركود</li>
            <li>اجعل الباركود موازياً للكاميرا</li>
            <li>تجنب الظلال على الباركود</li>
            <li>استخدم زر "ضبط التركيز" إذا كانت الصورة غير واضحة</li>
            <li>استخدم زر "تشغيل الفلاش" في الأماكن المظلمة</li>
          </ul>
        </div>
        
        <div id="barcodeResult" class="barcode-result"></div>
        
        <div style="text-align:center;margin-top:15px;color:#666;font-size:14px">
          <i class="fas fa-info-circle"></i>
          قم بتوجيه الكاميرا نحو الباركود وسيتم التعرف عليه تلقائياً
        </div>
      </div>
    </div>
    
    <h3>إضافة منتجات</h3>
    <div style="display:grid;grid-template-columns:1fr 120px auto;gap:15px;align-items:end">
      <div class="searchable-select">
        <input type="text" id="prodSearch" placeholder="اكتب اسم المنتج أو الباركود..." autocomplete="off">
        <i class="fas fa-search"></i>
        <select id="prodSelect" size="8" style="display:none;position:absolute;top:100%;left:0;right:0;z-index:99;background:#fff;border:1px solid #ddd;border-radius:12px;max-height:300px;overflow-y:auto"></select>
      </div>
      <input type="number" id="qtyInput" value="1" min="1">
      <button type="button" id="addToCartBtn" class="success">إضافة</button>
    </div>
    <div id="cartItems" style="margin:20px 0"></div>
    <div class="cart-total" id="cartTotal">الإجمالي: 0 جنيه</div>
    <button id="saveOrderBtn" style="margin-top:20px;padding:18px;font-size:18px">حفظ الطلب وإرسال واتساب</button>
    <div id="orderLoading" class="loading">جاري الحفظ والإرسال...</div>
  </div>

  <div id="edit-order" class="card" style="display:none">
    <h2>تعديل الطلب</h2>
    <form id="editCustomerForm">
      <input type="hidden" id="editOrderId">
      <input type="text" placeholder="اسم العميل" id="editCname" required>
      <input type="tel" placeholder="رقم الواتساب (مثلاً: 01029149379)" id="editCphone" required>
      <input type="text" placeholder="العنوان كامل" id="editCaddr" required>
      <select id="editStatus">
        <option value="جديد">جديد</option>
        <option value="تحت التجهيز">تحت التجهيز</option>
        <option value="تم التوصيل">تم التوصيل</option>
      </select>
    </form>
    <div class="discount-toggle">
      <label class="switch">
        <input type="checkbox" id="editApplyDiscount">
        <span class="slider"></span>
      </label>
      <span>تفعيل الخصم على كل المنتجات في هذا الطلب</span>
    </div>
    <hr style="margin:30px 0">
    <h3>إضافة منتجات</h3>
    <div style="display:grid;grid-template-columns:1fr 120px auto;gap:15px;align-items:end">
      <div class="searchable-select">
        <input type="text" id="editProdSearch" placeholder="اكتب اسم المنتج..." autocomplete="off">
        <i class="fas fa-search"></i>
        <select id="editProdSelect" size="8" style="display:none;position:absolute;top:100%;left:0;right:0;z-index:99;background:#fff;border:1px solid #ddd;border-radius:12px;max-height:300px;overflow-y:auto"></select>
      </div>
      <input type="number" id="editQtyInput" value="1" min="1">
      <button type="button" id="addToEditCartBtn" class="success">إضافة</button>
    </div>
    <div id="editCartItems" style="margin:20px 0"></div>
    <div class="cart-total" id="editCartTotal">الإجمالي: 0 جنيه</div>
    <button id="updateOrderBtn" style="margin-top:20px;padding:18px;font-size:18px">تحديث الطلب</button>
    <div id="editOrderLoading" class="loading">جاري تحديث الطلب...</div>
  </div>

  <div id="orders" class="card" style="display:none">
    <h2>جميع الطلبات</h2>
    <div style="margin:20px 0">
      <button class="success export-btn" id="exportOrdersBtn">تصدير إلى إكسيل</button>
      <button class="danger export-btn" id="deleteAllOrdersBtn">حذف كل الطلبات</button>
    </div>
    <input type="text" id="searchOrders" placeholder="بحث...">
    <table>
      <thead><tr>
        <th>العميل</th><th>التليفون</th><th>المنتجات</th><th>الإجمالي</th><th>الحالة</th><th>التاريخ</th><th>إجراءات</th>
      </tr></thead>
      <tbody id="ordersList"></tbody>
    </table>
  </div>

  <div id="products" class="card" style="display:none">
    <h2>إدارة المنتجات</h2>
    
    <!-- قسم تشخيص المشاكل -->
    <div class="debug-info" id="debugInfo" style="display:none">
      <h4><i class="fas fa-bug"></i> معلومات التشخيص</h4>
      <div id="debugContent">جاري التحقق من اتصال قاعدة البيانات...</div>
    </div>
    
    <div style="margin:20px 0; text-align:center;">
      <button class="success export-btn" id="exportProductsBtn">تصدير إلى إكسيل</button>
      <button class="danger export-btn" id="deleteAllProductsBtn">حذف كل المنتجات</button>
      <button class="orange export-btn" id="importExcelBtn">استيراد من إكسل</button>
      <input type="file" id="importExcel" accept=".xlsx,.xls" style="display:none;">
      <div style="margin-top:12px; color:#555; font-size:14px;">
        الأعمدة المطلوبة: <strong>اسم المنتج | الكمية | سعر البيع | الخصم % | رابط الصورة (اختياري) | الباركود (اختياري)</strong>
      </div>
    </div>
    
    <input type="text" id="searchProducts" placeholder="بحث عن منتج...">
    
    <!-- قسم الباركود في صفحة المنتجات -->
    <div class="barcode-section">
      <div class="barcode-toggle" id="productBarcodeToggle">
        <i class="fas fa-barcode"></i>
        <span style="font-weight:bold">مسح الباركود للمنتج بالكاميرا</span>
        <i class="fas fa-chevron-down" style="margin-right:auto"></i>
      </div>
      
      <div id="productBarcodeContent" style="display:none">
        <div class="barcode-container">
          <video id="product-barcode-scanner" class="barcode-scanner"></video>
          <div class="scan-area" id="productScanArea">
            <div class="scan-area-line"></div>
          </div>
          <div class="scan-instructions" id="productScanInstructions">
            <i class="fas fa-info-circle"></i> قرب الباركود من الكاميرا
          </div>
          <div class="zoom-indicator" id="productZoomIndicator">
            <i class="fas fa-search"></i> المسافة المثالية: 15-20 سم
          </div>
          <div class="barcode-overlay" id="productBarcodeOverlay">
            <div style="text-align:center">
              <i class="fas fa-camera" style="font-size:48px;margin-bottom:15px;display:block"></i>
              جاري تشغيل الكاميرا...
              <div style="margin-top:15px;font-size:14px;color:#ddd">
                ضع الباركود داخل المستطيل ليتم التعرف عليه تلقائياً
              </div>
            </div>
          </div>
        </div>
        
        <div class="barcode-controls">
          <button id="productFlashToggle" class="orange">
            <i class="fas fa-lightbulb"></i> تشغيل الفلاش
          </button>
          <button id="focusProductCamera" class="orange">
            <i class="fas fa-crosshairs"></i> ضبط التركيز
          </button>
        </div>
        
        <div class="barcode-input-group">
          <input type="text" id="scannedBarcode" placeholder="سيظهر الباركود هنا تلقائياً..." readonly>
          <button type="button" id="applyBarcode" class="success" disabled>
            <i class="fas fa-check"></i> تطبيق الباركود
          </button>
        </div>
        
        <div id="productBarcodeResult" class="barcode-result"></div>
        
        <div style="text-align:center;margin-top:15px;color:#666;font-size:14px">
          <i class="fas fa-info-circle"></i>
          قم بمسح الباركود ثم اضغط على "تطبيق الباركود" لإضافته للمنتج
        </div>
      </div>
    </div>
    
    <form id="productForm" style="background:#f9f9f9;padding:25px;border-radius:16px;margin:25px 0">
      <input type="hidden" id="editProductId">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px">
        <input placeholder="اسم المنتج" id="pname" required>
        <input type="number" placeholder="الكمية" id="pstock" required>
        <input type="number" placeholder="سعر البيع" id="psell" required>
        <input type="number" placeholder="الخصم %" id="pdiscount" min="0" max="100" value="0">
        <div class="barcode-input-group">
          <input placeholder="كود الباركود" id="pbarcode">
          <button type="button" id="scanBarcodeForProduct" class="orange">
            <i class="fas fa-camera"></i> مسح
          </button>
        </div>
        <input type="file" id="pimage" accept="image/*">
        <div id="imagePreview"></div>
      </div>
      <button type="submit" id="productSubmitBtn">إضافة منتج</button>
      <div id="productLoading" class="loading">جاري حفظ المنتج...</div>
    </form>
    <table>
      <thead><tr>
        <th>صورة</th><th>المنتج</th><th>المتوفر</th><th>سعر البيع</th><th>الخصم %</th><th>السعر بعد الخصم</th><th>الباركود</th><th>إجراءات</th>
      </tr></thead>
      <tbody id="productsList"></tbody>
    </table>
    <!-- إضافة حقوق الملكية في صفحة المنتجات -->
    <div class="copyright-footer">
      تم تطوير النظام بواسطة المهندس محمد صلاح الزهيري - للتواصل: 01029149379
    </div>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, serverTimestamp, increment, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  // إعدادات Firebase - تم التعديل بناءً على إعداداتك
  const firebaseConfig = {
    apiKey: "AIzaSyAuRBWr54OUPpH63rYX2GuX5UGMippYSkQ",
    authDomain: "ashrynutral.firebaseapp.com",
    projectId: "ashrynutral",
    storageBucket: "ashrynutral.appspot.com",
    messagingSenderId: "272736958880",
    appId: "1:272736958880:web:5d565a91be484a9cbf4cc5"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const IMGBB_API_KEY = "6e0b6ad4c71f839987c098fe183beca5";

  let products = [], orders = [], cart = [], editCart = [];
  let currentStream = null;
  let productStream = null;
  let currentFacingMode = 'environment';
  let productFacingMode = 'environment';
  let scannedBarcodeValue = '';
  let isScanning = false;
  let quaggaInitialized = false;
  let quaggaProductInitialized = false;
  let connectionTestInterval = null;
  let flashEnabled = false;
  let productFlashEnabled = false;

  // تعريف الدوال في النطاق العالمي
  window.renderCart = function() {
    const useDiscount = document.getElementById('applyDiscount').checked;
    let total = 0;
    let html = '';
    
    if (cart.length === 0) {
      html = '<p style="text-align:center;color:#999;margin:50px 0;font-size:18px;">السلة فارغة، ابدأ بإضافة منتجات</p>';
    } else {
      cart.forEach((item, index) => {
        const p = products.find(x => x.id === item.id);
        if (!p) return;
        
        let price;
        if (useDiscount) {
          price = p.sellPrice * (1 - (p.discount || 0)/100);
        } else {
          price = item.originalPrice || p.sellPrice;
        }
        
        const itemTotal = price * item.qty;
        total += itemTotal;
        
        html += `
          <div class="cart-item" style="position:relative;padding-left:60px;padding-right:15px;min-height:90px;">
            <button onclick="window.removeFromCart(${index})"
                    style="position:absolute;left:10px;top:50%;transform:translateY(-50%);
                           background:#e74c3c;color:white;width:40px;height:40px;
                           border:none;border-radius:50%;cursor:pointer;font-size:16px;
                           box-shadow:0 2px 10px rgba(231,76,60,0.3);z-index:10;">
              <i class="fas fa-trash"></i>
            </button>
            ${item.imageUrl ?
              `<img src="${item.imageUrl}" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);width:70px;height:70px;object-fit:cover;border-radius:8px;">`
              : '<div style="position:absolute;right:10px;top:50%;transform:translateY(-50%);width:70px;height:70px;background:#eee;border-radius:8px;"></div>'}
            <div style="padding:15px 80px 15px 10px;">
              <div style="font-weight:bold;font-size:18px;margin-bottom:8px;">${item.name}</div>
              <div style="color:#555;margin-bottom:8px;">الكمية: <strong>${item.qty}</strong></div>
              <div style="color:#666;margin-bottom:4px;font-size:14px;">سعر الوحدة: ${price.toFixed(0)} ج</div>
              ${useDiscount && p.discount > 0 ? `<div style="color:#e67e22;font-weight:bold;font-size:14px;">تم تطبيق خصم ${p.discount}%</div>` : ''}
              <div style="font-size:20px;color:#1e3c72;margin-top:10px;font-weight:bold;">
                ${itemTotal.toFixed(0)} جنيه
              </div>
            </div>
          </div>`;
      });
    }
    
    document.getElementById('cartItems').innerHTML = html;
    document.getElementById('cartTotal').innerHTML = `
      <div style="background:linear-gradient(135deg,#1e3c72,#2a5298);color:white;padding:25px;border-radius:16px;text-align:center;font-size:28px;font-weight:900;box-shadow:0 8px 25px rgba(30,60,114,0.3);margin:20px 0;">
        الإجمالي: ${total.toFixed(0)} جنيه مصري
      </div>`;
  };

  window.renderEditCart = function() {
    const useDiscount = document.getElementById('editApplyDiscount').checked;
    let total = 0;
    let html = '';
    
    if (editCart.length === 0) {
      html = '<p style="text-align:center;color:#999;margin:50px 0;font-size:18px;">السلة فارغة، ابدأ بإضافة منتجات</p>';
    } else {
      editCart.forEach((item, index) => {
        const p = products.find(x => x.id === item.id);
        if (!p) return;
        
        let price;
        if (useDiscount) {
          price = p.sellPrice * (1 - (p.discount || 0)/100);
        } else {
          price = item.originalPrice || p.sellPrice;
        }
        
        const itemTotal = price * item.qty;
        total += itemTotal;
        
        html += `
          <div class="cart-item" style="position:relative;padding-left:60px;padding-right:15px;min-height:90px;">
            <button onclick="window.removeFromEditCart(${index})"
                    style="position:absolute;left:10px;top:50%;transform:translateY(-50%);
                           background:#e74c3c;color:white;width:40px;height:40px;
                           border:none;border-radius:50%;cursor:pointer;font-size:16px;
                           box-shadow:0 2px 10px rgba(231,76,60,0.3);z-index:10;">
              <i class="fas fa-trash"></i>
            </button>
            ${item.imageUrl ?
              `<img src="${item.imageUrl}" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);width:70px;height:70px;object-fit:cover;border-radius:8px;">`
              : '<div style="position:absolute;right:10px;top:50%;transform:translateY(-50%);width:70px;height:70px;background:#eee;border-radius:8px;"></div>'}
            <div style="padding:15px 80px 15px 10px;">
              <div style="font-weight:bold;font-size:18px;margin-bottom:8px;">${item.name}</div>
              <div style="color:#555;margin-bottom:8px;">الكمية: <strong>${item.qty}</strong></div>
              <div style="color:#666;margin-bottom:4px;font-size:14px;">سعر الوحدة: ${price.toFixed(0)} ج</div>
              ${useDiscount && p.discount > 0 ? `<div style="color:#e67e22;font-weight:bold;font-size:14px;">تم تطبيق خصم ${p.discount}%</div>` : ''}
              <div style="font-size:20px;color:#1e3c72;margin-top:10px;font-weight:bold;">
                ${itemTotal.toFixed(0)} جنيه
              </div>
            </div>
          </div>`;
      });
    }
    
    document.getElementById('editCartItems').innerHTML = html;
    document.getElementById('editCartTotal').innerHTML = `
      <div style="background:linear-gradient(135deg,#1e3c72,#2a5298);color:white;padding:25px;border-radius:16px;text-align:center;font-size:28px;font-weight:900;box-shadow:0 8px 25px rgba(30,60,114,0.3);margin:20px 0;">
        الإجمالي: ${total.toFixed(0)} جنيه مصري
      </div>`;
  };

  // دوال الباركود للطلبات - محسنة للقراءة المستمرة والتشغيل التلقائي
  window.startBarcodeScanner = async function() {
    const video = document.getElementById('barcode-scanner');
    const overlay = document.getElementById('barcodeOverlay');
    const scanArea = document.getElementById('scanArea');
    
    try {
      overlay.innerHTML = '<div style="text-align:center"><i class="fas fa-spinner fa-spin" style="font-size:48px;margin-bottom:15px;display:block"></i> جاري تشغيل الكاميرا...</div>';
      
      // إعدادات كاميرا عالية الدقة
      const constraints = {
        video: { 
          facingMode: currentFacingMode,
          width: { ideal: 1920, min: 1280 },
          height: { ideal: 1080, min: 720 },
          frameRate: { ideal: 30, min: 24 },
          focusMode: 'continuous'
        },
        audio: false
      };
      
      // إضافة الفلاش إذا كان مفعل
      if (flashEnabled) {
        constraints.video.torch = true;
      }
      
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      
      currentStream = stream;
      video.srcObject = stream;
      
      // محاولة تفعيل التركيز التلقائي
      const videoTrack = stream.getVideoTracks()[0];
      if (videoTrack && videoTrack.getCapabilities && videoTrack.getCapabilities().focusDistance) {
        try {
          await videoTrack.applyConstraints({
            advanced: [{ focusMode: 'continuous' }]
          });
        } catch (e) {
          console.log('التركيز التلقائي غير مدعوم:', e);
        }
      }
      
      await video.play();
      
      overlay.style.display = 'none';
      isScanning = true;
      
      // بدء وضع المسح
      scanArea.classList.add('scanning');
      
      // إعادة تهيئة Quagga إذا كان قد تم تهيئته من قبل
      if (quaggaInitialized) {
        try {
          Quagga.stop();
        } catch (e) {
          console.log('Quagga لم يكن يعمل:', e);
        }
      }
      
      // تهيئة Quagga للتعرف على الباركود مع إعدادات محسنة
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: video,
          constraints: {
            width: 1920,
            height: 1080,
            facingMode: currentFacingMode
          },
          area: {
            top: "25%",
            right: "10%",
            left: "10%",
            bottom: "25%"
          }
        },
        locator: {
          patchSize: "x-large",
          halfSample: false
        },
        numOfWorkers: navigator.hardwareConcurrency || 4,
        decoder: {
          readers: [
            "code_128_reader",
            "ean_reader",
            "ean_8_reader",
            "code_39_reader",
            "code_39_vin_reader",
            "codabar_reader",
            "upc_reader",
            "upc_e_reader",
            "i2of5_reader"
          ],
          multiple: false
        },
        locate: true,
        frequency: 10
      }, function(err) {
        if (err) {
          console.error('خطأ في تهيئة Quagga:', err);
          overlay.innerHTML = '<div style="text-align:center"><i class="fas fa-exclamation-triangle" style="font-size:48px;margin-bottom:15px;display:block"></i> خطأ في تشغيل الماسح الضوئي</div>';
          overlay.style.display = 'flex';
          scanArea.classList.remove('scanning');
          return;
        }
        
        Quagga.start();
        quaggaInitialized = true;
        console.log('Quagga started successfully with improved settings');
      });
      
      Quagga.onProcessed(function(result) {
        if (!result) return;
        
        // عرض معلومات التتبع للمساعدة في تصحيح الأخطاء
        const drawingCtx = Quagga.canvas.ctx.overlay;
        const drawingCanvas = Quagga.canvas.dom.overlay;
        
        if (drawingCtx && drawingCanvas) {
          drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
          
          if (result.boxes) {
            drawingCtx.strokeStyle = "#00FF00";
            result.boxes.filter(function(box) {
              return box !== result.box;
            }).forEach(function(box) {
              Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
            });
          }
          
          if (result.box) {
            Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
          }
          
          if (result.codeResult && result.codeResult.code) {
            Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
          }
        }
      });
      
      Quagga.onDetected(function(result) {
        if (!isScanning) return;
        
        const code = result.codeResult.code;
        console.log('تم التعرف على الباركود:', code, 'بدقة:', result.codeResult.format);
        
        // التحقق من جودة النتيجة
        if (!isValidBarcode(code)) {
          console.log('باركود غير صالح:', code);
          return;
        }
        
        // تغيير لون المستطيل إلى الأخضر للإشارة إلى النجاح
        scanArea.classList.remove('scanning');
        scanArea.classList.add('success');
        
        // إيقاف المسح مؤقتاً بعد التعرف على الباركود
        isScanning = false;
        try {
          Quagga.stop();
        } catch (e) {
          console.log('خطأ في إيقاف Quagga:', e);
        }
        
        // البحث عن المنتج باستخدام الباركود
        const product = findProductByBarcode(code);
        
        if (product) {
          showBarcodeResult(`تم التعرف على المنتج: ${product.name}`, true);
          
          // إضافة المنتج تلقائياً إلى السلة
          setTimeout(() => {
            addProductToCartByBarcode(product.id);
            
            // إعادة تعيين المستطيل وإعادة تشغيل الماسح بعد إضافة المنتج
            setTimeout(() => {
              scanArea.classList.remove('success');
              scanArea.classList.add('scanning');
              isScanning = true;
              try {
                Quagga.start();
              } catch (e) {
                console.log('خطأ في إعادة تشغيل Quagga:', e);
              }
            }, 500); // تقليل وقت الانتظار إلى نصف ثانية فقط
          }, 300);
        } else {
          showBarcodeResult(`لم يتم العثور على منتج بالباركود: ${code}`, false);
          scanArea.classList.remove('success');
          scanArea.classList.add('error');
          
          // إعادة تعيين المستطيل وإعادة تشغيل الماسح بعد الخطأ
          setTimeout(() => {
            scanArea.classList.remove('error');
            scanArea.classList.add('scanning');
            isScanning = true;
            try {
              Quagga.start();
            } catch (e) {
              console.log('خطأ في إعادة تشغيل Quagga:', e);
            }
          }, 1000); // وقت انتظار أطول قليلاً في حالة الخطأ
        }
      });
      
    } catch (error) {
      console.error('خطأ في تشغيل الكاميرا:', error);
      overlay.innerHTML = '<div style="text-align:center"><i class="fas fa-exclamation-triangle" style="font-size:48px;margin-bottom:15px;display:block"></i> خطأ في تشغيل الكاميرا. تأكد من السماح باستخدام الكاميرا.</div>';
      overlay.style.display = 'flex';
      scanArea.classList.remove('scanning');
    }
  };

  // دالة للتحقق من صحة الباركود
  function isValidBarcode(code) {
    if (!code || code.length < 4) return false;
    
    // التحقق من الأحرف المسموح بها
    const validChars = /^[0-9a-zA-Z\-\.\ \$\/\+\%]+$/;
    if (!validChars.test(code)) return false;
    
    return true;
  }

  // دالة محسنة للبحث عن المنتج بالباركود
  function findProductByBarcode(barcode) {
    // البحث الدقيق أولاً
    let product = products.find(p => p.barcode === barcode);
    
    if (!product) {
      // إذا لم يتم العثور، حاول البحث مع إزالة المسافات والأحرف الخاصة
      const cleanBarcode = barcode.replace(/[\s\-\.]/g, '');
      product = products.find(p => {
        const cleanProductBarcode = p.barcode ? p.barcode.replace(/[\s\-\.]/g, '') : '';
        return cleanProductBarcode === cleanBarcode;
      });
    }
    
    if (!product) {
      // البحث الجزئي كحل أخير
      product = products.find(p => p.barcode && p.barcode.includes(barcode));
    }
    
    return product;
  }

  // دالة ضبط التركيز
  window.focusCamera = async function() {
    if (!currentStream) return;
    
    const videoTrack = currentStream.getVideoTracks()[0];
    if (videoTrack && videoTrack.getCapabilities && videoTrack.getCapabilities().focusDistance) {
      try {
        await videoTrack.applyConstraints({
          advanced: [{ focusMode: 'manual', focusDistance: 0.1 }]
        });
        
        // العودة للتركيز التلقائي بعد ثانية
        setTimeout(async () => {
          try {
            await videoTrack.applyConstraints({
              advanced: [{ focusMode: 'continuous' }]
            });
          } catch (e) {
            console.log('لا يمكن العودة للتركيز التلقائي');
          }
        }, 1000);
        
        showBarcodeResult('تم ضبط التركيز', true);
      } catch (e) {
        showBarcodeResult('لا يمكن ضبط التركيز على هذا الجهاز', false);
      }
    } else {
      showBarcodeResult('التركيز اليدوي غير مدعوم على هذا الجهاز', false);
    }
  };

  // دالة تشغيل/إيقاف الفلاش - محسنة لإيقاف الفلاش تلقائياً
  window.toggleFlash = async function() {
    if (!currentStream) return;
    
    const videoTrack = currentStream.getVideoTracks()[0];
    if (videoTrack && videoTrack.getCapabilities && videoTrack.getCapabilities().torch) {
      try {
        flashEnabled = !flashEnabled;
        await videoTrack.applyConstraints({
          advanced: [{ torch: flashEnabled }]
        });
        
        const flashBtn = document.getElementById('flashToggle');
        if (flashEnabled) {
          flashBtn.innerHTML = '<i class="fas fa-lightbulb"></i> إيقاف الفلاش';
          flashBtn.style.background = '#f39c12';
          showBarcodeResult('تم تشغيل الفلاش', true);
        } else {
          flashBtn.innerHTML = '<i class="fas fa-lightbulb"></i> تشغيل الفلاش';
          flashBtn.style.background = '';
          showBarcodeResult('تم إيقاف الفلاش', true);
        }
      } catch (e) {
        showBarcodeResult('الفلاش غير مدعوم على هذا الجهاز', false);
      }
    } else {
      showBarcodeResult('الفلاش غير مدعوم على هذا الجهاز', false);
    }
  };

  // دالة إيقاف الماسح الضوئي - محسنة لإيقاف الفلاش تلقائياً
  window.stopBarcodeScanner = function() {
    const video = document.getElementById('barcode-scanner');
    const overlay = document.getElementById('barcodeOverlay');
    const scanArea = document.getElementById('scanArea');
    
    // إيقاف الفلاش تلقائياً إذا كان مفعل
    if (flashEnabled && currentStream) {
      const videoTrack = currentStream.getVideoTracks()[0];
      if (videoTrack && videoTrack.getCapabilities && videoTrack.getCapabilities().torch) {
        try {
          videoTrack.applyConstraints({
            advanced: [{ torch: false }]
          });
        } catch (e) {
          console.log('خطأ في إيقاف الفلاش:', e);
        }
      }
    }
    
    if (currentStream) {
      currentStream.getTracks().forEach(track => track.stop());
      currentStream = null;
    }
    
    if (video.srcObject) {
      video.srcObject = null;
    }
    
    if (quaggaInitialized) {
      try {
        Quagga.stop();
      } catch (e) {
        console.log('Quagga لم يكن يعمل عند الإيقاف:', e);
      }
      quaggaInitialized = false;
    }
    
    isScanning = false;
    flashEnabled = false;
    
    if (scanArea) {
      scanArea.classList.remove('scanning', 'success', 'error');
    }
    
    if (overlay) {
      overlay.innerHTML = '<div style="text-align:center"><i class="fas fa-camera" style="font-size:48px;margin-bottom:15px;display:block"></i> جاري تشغيل الكاميرا...<div style="margin-top:15px;font-size:14px;color:#ddd">ضع الباركود داخل المستطيل ليتم التعرف عليه تلقائياً</div></div>';
      overlay.style.display = 'flex';
    }
    
    // تحديث زر الفلاش
    const flashBtn = document.getElementById('flashToggle');
    if (flashBtn) {
      flashBtn.innerHTML = '<i class="fas fa-lightbulb"></i> تشغيل الفلاش';
      flashBtn.style.background = '';
    }
  };

  // دوال الباركود للمنتجات - نفس التحسينات للقراءة المستمرة والتشغيل التلقائي
  window.startProductBarcodeScanner = async function() {
    const video = document.getElementById('product-barcode-scanner');
    const overlay = document.getElementById('productBarcodeOverlay');
    const scanArea = document.getElementById('productScanArea');
    const applyBtn = document.getElementById('applyBarcode');
    
    try {
      overlay.innerHTML = '<div style="text-align:center"><i class="fas fa-spinner fa-spin" style="font-size:48px;margin-bottom:15px;display:block"></i> جاري تشغيل الكاميرا...</div>';
      
      const constraints = {
        video: { 
          facingMode: productFacingMode,
          width: { ideal: 1920, min: 1280 },
          height: { ideal: 1080, min: 720 },
          frameRate: { ideal: 30, min: 24 },
          focusMode: 'continuous'
        },
        audio: false
      };
      
      // إضافة الفلاش إذا كان مفعل
      if (productFlashEnabled) {
        constraints.video.torch = true;
      }
      
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      
      productStream = stream;
      video.srcObject = stream;
      
      await video.play();
      
      overlay.style.display = 'none';
      applyBtn.disabled = true;
      
      // بدء وضع المسح
      if (scanArea) scanArea.classList.add('scanning');
      
      // إعدادات Quagga محسنة للمنتجات
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: video,
          constraints: {
            width: 1920,
            height: 1080,
            facingMode: productFacingMode
          },
          area: {
            top: "25%",
            right: "10%",
            left: "10%",
            bottom: "25%"
          }
        },
        locator: {
          patchSize: "x-large",
          halfSample: false
        },
        numOfWorkers: navigator.hardwareConcurrency || 4,
        decoder: {
          readers: [
            "code_128_reader",
            "ean_reader",
            "ean_8_reader",
            "code_39_reader",
            "code_39_vin_reader",
            "codabar_reader",
            "upc_reader",
            "upc_e_reader",
            "i2of5_reader"
          ],
          multiple: false
        },
        locate: true,
        frequency: 10
      }, function(err) {
        if (err) {
          console.error('خطأ في تهيئة Quagga:', err);
          overlay.innerHTML = '<div style="text-align:center"><i class="fas fa-exclamation-triangle" style="font-size:48px;margin-bottom:15px;display:block"></i> خطأ في تشغيل الماسح الضوئي</div>';
          overlay.style.display = 'flex';
          if (scanArea) scanArea.classList.remove('scanning');
          return;
        }
        
        Quagga.start();
        quaggaProductInitialized = true;
        console.log('Quagga for products started successfully with improved settings');
      });
      
      Quagga.onDetected(function(result) {
        const code = result.codeResult.code;
        console.log('تم التعرف على الباركود للمنتج:', code, 'بدقة:', result.codeResult.format);
        
        if (!isValidBarcode(code)) {
          console.log('باركود غير صالح:', code);
          return;
        }
        
        // تغيير لون المستطيل إلى الأخضر للإشارة إلى النجاح
        if (scanArea) {
          scanArea.classList.remove('scanning');
          scanArea.classList.add('success');
        }
        
        // إيقاف المسح مؤقتاً بعد التعرف على الباركود
        try {
          Quagga.stop();
        } catch (e) {
          console.log('خطأ في إيقاف Quagga:', e);
        }
        
        scannedBarcodeValue = code;
        document.getElementById('scannedBarcode').value = code;
        document.getElementById('applyBarcode').disabled = false;
        
        showProductBarcodeResult(`تم مسح الباركود: ${code}`, true);
        
        // إعادة تعيين المستطيل وإعادة تشغيل الماسح بعد النجاح
        setTimeout(() => {
          if (scanArea) {
            scanArea.classList.remove('success');
            scanArea.classList.add('scanning');
            try {
              Quagga.start();
            } catch (e) {
              console.log('خطأ في إعادة تشغيل Quagga:', e);
            }
          }
        }, 500); // تقليل وقت الانتظار إلى نصف ثانية فقط
      });
      
    } catch (error) {
      console.error('خطأ في تشغيل الكاميرا:', error);
      overlay.innerHTML = '<div style="text-align:center"><i class="fas fa-exclamation-triangle" style="font-size:48px;margin-bottom:15px;display:block"></i> خطأ في تشغيل الكاميرا. تأكد من السماح باستخدام الكاميرا.</div>';
      overlay.style.display = 'flex';
      if (scanArea) scanArea.classList.remove('scanning');
    }
  };

  // دالة تشغيل/إيقاف الفلاش للمنتجات - محسنة لإيقاف الفلاش تلقائياً
  window.toggleProductFlash = async function() {
    if (!productStream) return;
    
    const videoTrack = productStream.getVideoTracks()[0];
    if (videoTrack && videoTrack.getCapabilities && videoTrack.getCapabilities().torch) {
      try {
        productFlashEnabled = !productFlashEnabled;
        await videoTrack.applyConstraints({
          advanced: [{ torch: productFlashEnabled }]
        });
        
        const flashBtn = document.getElementById('productFlashToggle');
        if (productFlashEnabled) {
          flashBtn.innerHTML = '<i class="fas fa-lightbulb"></i> إيقاف الفلاش';
          flashBtn.style.background = '#f39c12';
          showProductBarcodeResult('تم تشغيل الفلاش', true);
        } else {
          flashBtn.innerHTML = '<i class="fas fa-lightbulb"></i> تشغيل الفلاش';
          flashBtn.style.background = '';
          showProductBarcodeResult('تم إيقاف الفلاش', true);
        }
      } catch (e) {
        showProductBarcodeResult('الفلاش غير مدعوم على هذا الجهاز', false);
      }
    } else {
      showProductBarcodeResult('الفلاش غير مدعوم على هذا الجهاز', false);
    }
  };

  // دالة إيقاف الماسح الضوئي للمنتجات - محسنة لإيقاف الفلاش تلقائياً
  window.stopProductBarcodeScanner = function() {
    const video = document.getElementById('product-barcode-scanner');
    const overlay = document.getElementById('productBarcodeOverlay');
    const scanArea = document.getElementById('productScanArea');
    const applyBtn = document.getElementById('applyBarcode');
    
    // إيقاف الفلاش تلقائياً إذا كان مفعل
    if (productFlashEnabled && productStream) {
      const videoTrack = productStream.getVideoTracks()[0];
      if (videoTrack && videoTrack.getCapabilities && videoTrack.getCapabilities().torch) {
        try {
          videoTrack.applyConstraints({
            advanced: [{ torch: false }]
          });
        } catch (e) {
          console.log('خطأ في إيقاف الفلاش:', e);
        }
      }
    }
    
    if (productStream) {
      productStream.getTracks().forEach(track => track.stop());
      productStream = null;
    }
    
    if (video.srcObject) {
      video.srcObject = null;
    }
    
    if (quaggaProductInitialized) {
      try {
        Quagga.stop();
      } catch (e) {
        console.log('Quagga للمنتجات لم يكن يعمل عند الإيقاف:', e);
      }
      quaggaProductInitialized = false;
    }
    
    if (scanArea) scanArea.classList.remove('scanning', 'success', 'error');
    
    if (overlay) {
      overlay.innerHTML = '<div style="text-align:center"><i class="fas fa-camera" style="font-size:48px;margin-bottom:15px;display:block"></i> جاري تشغيل الكاميرا...<div style="margin-top:15px;font-size:14px;color:#ddd">ضع الباركود داخل المستطيل ليتم التعرف عليه تلقائياً</div></div>';
      overlay.style.display = 'flex';
    }
    
    if (applyBtn) applyBtn.disabled = true;
    productFlashEnabled = false;
    
    // تحديث زر الفلاش
    const flashBtn = document.getElementById('productFlashToggle');
    if (flashBtn) {
      flashBtn.innerHTML = '<i class="fas fa-lightbulb"></i> تشغيل الفلاش';
      flashBtn.style.background = '';
    }
  };

  window.focusProductCamera = async function() {
    if (!productStream) return;
    
    const videoTrack = productStream.getVideoTracks()[0];
    if (videoTrack && videoTrack.getCapabilities && videoTrack.getCapabilities().focusDistance) {
      try {
        await videoTrack.applyConstraints({
          advanced: [{ focusMode: 'manual', focusDistance: 0.1 }]
        });
        
        // العودة للتركيز التلقائي بعد ثانية
        setTimeout(async () => {
          try {
            await videoTrack.applyConstraints({
              advanced: [{ focusMode: 'continuous' }]
            });
          } catch (e) {
            console.log('لا يمكن العودة للتركيز التلقائي');
          }
        }, 1000);
        
        showProductBarcodeResult('تم ضبط التركيز', true);
      } catch (e) {
        showProductBarcodeResult('لا يمكن ضبط التركيز على هذا الجهاز', false);
      }
    } else {
      showProductBarcodeResult('التركيز اليدوي غير مدعوم على هذا الجهاز', false);
    }
  };

  window.applyScannedBarcode = function() {
    if (scannedBarcodeValue) {
      document.getElementById('pbarcode').value = scannedBarcodeValue;
      showProductBarcodeResult('تم تطبيق الباركود على المنتج', true);
      document.getElementById('applyBarcode').disabled = true;
      
      // إغلاق قسم الباركود بعد التطبيق
      setTimeout(() => {
        document.getElementById('productBarcodeContent').style.display = 'none';
        document.getElementById('productBarcodeToggle').classList.remove('active');
        window.stopProductBarcodeScanner();
      }, 2000);
    }
  };

  window.scanBarcodeForProduct = function() {
    // فتح قسم الباركود
    document.getElementById('productBarcodeContent').style.display = 'block';
    document.getElementById('productBarcodeToggle').classList.add('active');
    
    // بدء المسح تلقائياً
    setTimeout(() => {
      window.startProductBarcodeScanner();
    }, 500);
  };

  function showBarcodeResult(message, isSuccess) {
    const resultDiv = document.getElementById('barcodeResult');
    if (resultDiv) {
      resultDiv.textContent = message;
      resultDiv.className = `barcode-result ${isSuccess ? 'success' : 'error'}`;
      resultDiv.style.display = 'block';
      
      // إخفاء الرسالة بعد 5 ثواني
      setTimeout(() => {
        resultDiv.style.display = 'none';
      }, 5000);
    }
  }

  function showProductBarcodeResult(message, isSuccess) {
    const resultDiv = document.getElementById('productBarcodeResult');
    if (resultDiv) {
      resultDiv.textContent = message;
      resultDiv.className = `barcode-result ${isSuccess ? 'success' : 'error'}`;
      resultDiv.style.display = 'block';
      
      // إخفاء الرسالة بعد 5 ثواني
      setTimeout(() => {
        resultDiv.style.display = 'none';
      }, 5000);
    }
  }

  function addProductToCartByBarcode(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;
    
    // التحقق إذا كان المنتج موجود بالفعل في السلة
    const existingItemIndex = cart.findIndex(item => item.id === productId);
    if (existingItemIndex > -1) {
      // إذا كان موجود، نزيد الكمية فقط
      cart[existingItemIndex].qty += 1;
    } else {
      // إذا لم يكن موجود، نضيفه جديد
      cart.push({
        id: product.id, 
        name: product.name, 
        qty: 1, 
        imageUrl: product.imageUrl || '',
        originalPrice: product.sellPrice
      });
    }
    
    renderCart();
    
    // إظهار رسالة نجاح
    showBarcodeResult(`تم إضافة ${product.name} إلى السلة`, true);
  }

  window.showPage = function(s) {
    console.log('🔄 تحويل للصفحة:', s);
    
    // إخفاء كل الصفحات
    document.querySelectorAll('.card:not(#login), #invoice').forEach(function(el) {
        el.style.display = 'none';
    });
    
    // إظهار الصفحة المطلوبة
    const targetPage = document.getElementById(s);
    if (targetPage) {
        targetPage.style.display = 'block';
        console.log('✅ تم إظهار الصفحة:', s);
    } else {
        console.error('❌ الصفحة غير موجودة:', s);
    }
    
    // تحديث القائمة الجانبية
    document.querySelectorAll('.sidebar a').forEach(function(a) {
        a.classList.remove('active');
    });
    
    const activeLink = document.querySelector('[onclick="window.showPage(\'' + s + '\')"]');
    if (activeLink) {
        activeLink.classList.add('active');
    }
    
    // إيقاف الماسح الضوئي عند تغيير الصفحة
    if (s !== 'add-order') {
        if (window.stopBarcodeScanner) window.stopBarcodeScanner();
    }
    if (s !== 'products') {
        if (window.stopProductBarcodeScanner) window.stopProductBarcodeScanner();
    }
    
    // تحميل البيانات حسب الصفحة
    if (s === 'orders') {
        if (window.loadOrders) window.loadOrders();
    }
    if (s === 'products') { 
        // إضافة تأخير لضمان تحميل الـ DOM أولاً
        setTimeout(function() {
            console.log('📦 تحميل صفحة المنتجات...');
            if (window.loadProducts) window.loadProducts(); 
            const searchInput = document.getElementById('searchProducts');
            if (searchInput) {
                searchInput.value = '';
            }
        }, 100);
    }
    if (s === 'add-order') { 
        cart = []; 
        if (window.renderCart) window.renderCart(); 
        const discountCheckbox = document.getElementById('applyDiscount');
        if (discountCheckbox) discountCheckbox.checked = false; 
        if (loadProductsForCart) loadProductsForCart(); 
    }
    if (s === 'dashboard') {
        if (updateDashboard) updateDashboard();
    }
  };

  window.logout = () => {
    if(confirm("تسجيل الخروج؟")) {
      window.stopBarcodeScanner();
      window.stopProductBarcodeScanner();
      if (connectionTestInterval) {
        clearInterval(connectionTestInterval);
        connectionTestInterval = null;
      }
      signOut(auth);
    }
  };

  function hideEverythingExceptLogin() {
    document.querySelectorAll('.card, #invoice, .sidebar, #menuBtn').forEach(el => {
      if (el.id !== 'login') el.style.display = 'none';
    });
    document.getElementById('login').style.display = 'block';
  }

  document.getElementById('loginForm').onsubmit = e => {
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('pass').value;

    signInWithEmailAndPassword(auth, email, pass)
      .then(() => {})
      .catch(err => {
        let msg = "خطأ في الدخول";
        if (err.code === 'auth/user-not-found') msg = "الإيميل غير موجود";
        else if (err.code === 'auth/wrong-password') msg = "كلمة المرور غلط";
        else if (err.code === 'auth/invalid-email') msg = "الإيميل غير صحيح";
        alert(msg);
      });
  };

  // دالة اختبار اتصال Firebase تلقائي
  async function autoTestFirebaseConnection() {
    try {
      const productsRef = collection(db, "products");
      const snapshot = await getDocs(productsRef);
      const productCount = snapshot.size;
      console.log('✅ اتصال Firebase تلقائي ناجح، عدد المنتجات:', productCount);
      return true;
    } catch (error) {
      console.error('❌ فشل الاتصال التلقائي بـ Firebase:', error);
      return false;
    }
  }

  // دالة تحميل المنتجات مع تحسينات التشخيص
  window.loadProducts = async function() {
    try {
      console.log('🔄 جاري تحميل المنتجات من Firebase...');
      
      const productsRef = collection(db, "products");
      const snap = await getDocs(productsRef);
      
      products = [];
      snap.forEach(doc => {
        const data = doc.data();
        console.log('📦 بيانات المنتج:', doc.id, data);
        
        const productData = {
          id: doc.id,
          name: data.name || 'بدون اسم',
          stock: data.stock || 0,
          sellPrice: data.sellPrice || 0,
          discount: data.discount || 0,
          imageUrl: data.imageUrl || '',
          barcode: data.barcode || ''
        };
        
        products.push(productData);
      });
      
      console.log('✅ عدد المنتجات المحملة:', products.length);
      
      // عرض المنتجات بعد تحميلها
      window.renderProducts();
      
    } catch (error) {
      console.error('❌ خطأ في تحميل المنتجات:', error);
    }
  };

  // دالة عرض المنتجات
  window.renderProducts = function() {
    console.log('🔄 بدء renderProducts');
    console.log('📦 عدد المنتجات:', products.length);
    
    let productsList = document.getElementById('productsList');
    if (!productsList) {
        console.error('❌ element productsList مش موجود في الـ DOM');
        return;
    }
    
    const searchInput = document.getElementById('searchProducts');
    const term = searchInput ? searchInput.value.toLowerCase() : '';
    
    console.log('🔍 البحث عن:', term);
    
    const filtered = products.filter(function(p) {
        if (!p) return false;
        const nameMatch = p.name && p.name.toLowerCase().includes(term);
        const barcodeMatch = p.barcode && p.barcode.toLowerCase().includes(term);
        return nameMatch || barcodeMatch;
    });
    
    console.log('✅ المنتجات المفلترة:', filtered.length);
    
    if (filtered.length === 0) {
        productsList.innerHTML = `
          <tr>
            <td colspan="8" style="text-align:center;padding:50px;color:#999">
              <i class="fas fa-box-open" style="font-size:48px;margin-bottom:20px;display:block;color:#ccc;"></i>
              لا توجد منتجات
            </td>
          </tr>
        `;
        return;
    }
    
    let html = '';
    filtered.forEach(function(p) {
        if (!p) return;
        const priceAfter = (p.sellPrice || 0) * (1 - (p.discount || 0)/100);
        html += `
            <tr>
                <td>${p.imageUrl ? '<img src="' + p.imageUrl + '" class="product-img-table" alt="' + p.name + '">' : '<div style="width:60px;height:60px;background:#f0f0f0;border-radius:8px;display:flex;align-items:center;justify-content:center;"><i class="fas fa-image" style="color:#ccc;"></i></div>'}</td>
                <td><strong>${p.name || 'بدون اسم'}</strong></td>
                <td>${(p.stock || 0) > 0 ? p.stock : '<span style="color:red">نفد</span>'}</td>
                <td>${p.sellPrice || 0} ج</td>
                <td><strong style="color:var(--o)">${p.discount || 0}%</strong></td>
                <td style="background:#fff8e1">${priceAfter.toFixed(0)} ج</td>
                <td>${p.barcode || 'لا يوجد'}</td>
                <td class="action-btns">
                    <button class="orange small" onclick="window.editProduct('${p.id}')">تعديل</button>
                    <button class="danger small" onclick="window.delP('${p.id}')">حذف</button>
                </td>
            </tr>
        `;
    });
    
    productsList.innerHTML = html;
    console.log('✅ تم عرض المنتجات بنجاح');
  };

  function loadProductsForCart() {
    const input = document.getElementById('prodSearch');
    const select = document.getElementById('prodSelect');
    
    if (!input || !select) {
      console.error('❌ عناصر البحث عن المنتجات غير موجودة');
      return;
    }
    
    input.oninput = () => {
      const term = input.value.toLowerCase();
      select.innerHTML = '';
      products.filter(p => p.stock > 0 && (p.name.toLowerCase().includes(term) || (p.barcode && p.barcode.includes(term)))).forEach(p => {
        const barcodeText = p.barcode ? ` - الباركود: ${p.barcode}` : '';
        const opt = new Option(`${p.name} - ${p.sellPrice} ج (متوفر: ${p.stock})${barcodeText}`, p.id);
        select.add(opt);
      });
      select.style.display = select.options.length ? 'block' : 'none';
    };
    
    input.onclick = () => input.oninput();
    select.onchange = () => { 
      if (select.selectedOptions.length > 0) {
        input.value = select.selectedOptions[0].text.split(' - ')[0]; 
        select.style.display = 'none'; 
      }
    };
  }

  function loadProductsForEditCart() {
    const input = document.getElementById('editProdSearch');
    const select = document.getElementById('editProdSelect');
    
    if (!input || !select) {
      console.error('❌ عناصر البحث عن المنتجات للتعديل غير موجودة');
      return;
    }
    
    input.oninput = () => {
      const term = input.value.toLowerCase();
      select.innerHTML = '';
      products.filter(p => p.name.toLowerCase().includes(term)).forEach(p => {
        const opt = new Option(`${p.name} - ${p.sellPrice} ج (متوفر: ${p.stock})`, p.id);
        select.add(opt);
      });
      select.style.display = select.options.length ? 'block' : 'none';
    };
    
    input.onclick = () => input.oninput();
    select.onchange = () => { 
      if (select.selectedOptions.length > 0) {
        input.value = select.selectedOptions[0].text.split(' - ')[0]; 
        select.style.display = 'none'; 
      }
    };
  }

  window.addToCart = () => {
    const select = document.getElementById('prodSelect');
    if(!select.value) return alert("اختر منتج");
    const qty = +document.getElementById('qtyInput').value || 1;
    const p = products.find(x => x.id === select.value);
    if(p.stock < qty) return alert("الكمية غير متوفرة");
    
    const existingItemIndex = cart.findIndex(item => item.id === p.id);
    if (existingItemIndex > -1) {
      cart[existingItemIndex].qty += qty;
    } else {
      cart.push({
        id: p.id, 
        name: p.name, 
        qty: qty, 
        imageUrl: p.imageUrl || '',
        originalPrice: p.sellPrice
      });
    }
    
    renderCart();
    document.getElementById('prodSearch').value = '';
    document.getElementById('qtyInput').value = 1;
    select.style.display = 'none';
  };

  window.addToEditCart = () => {
    const select = document.getElementById('editProdSelect');
    if(!select.value) return alert("اختر منتج");
    const qty = +document.getElementById('editQtyInput').value || 1;
    const p = products.find(x => x.id === select.value);
    
    const existingItemIndex = editCart.findIndex(item => item.id === p.id);
    if (existingItemIndex > -1) {
      editCart[existingItemIndex].qty += qty;
    } else {
      editCart.push({
        id: p.id, 
        name: p.name, 
        qty: qty, 
        imageUrl: p.imageUrl || '',
        originalPrice: p.sellPrice
      });
    }
    
    renderEditCart();
    document.getElementById('editProdSearch').value = '';
    document.getElementById('editQtyInput').value = 1;
    select.style.display = 'none';
  };

  window.removeFromCart = function(index) {
    if (confirm("هل تريد حذف هذا المنتج من السلة؟")) {
      cart.splice(index, 1);
      renderCart();
    }
  };

  window.removeFromEditCart = function(index) {
    if (confirm("هل تريد حذف هذا المنتج من السلة؟")) {
      editCart.splice(index, 1);
      renderEditCart();
    }
  };

  window.saveOrder = async () => {
  if (cart.length === 0) return alert("أضف منتجات أولاً");
  
  let phone = document.getElementById('cphone').value.replace(/[^\d]/g, '');
  if (!phone.startsWith('01') || phone.length !== 11) return alert("رقم الواتساب لازم 11 رقم يبدأ بـ 01");
  
  const customerName = document.getElementById('cname').value.trim();
  const address = document.getElementById('caddr').value.trim();
  const useDiscount = document.getElementById('applyDiscount').checked;
  let totalAfter = 0;
  
  const itemsWithPrice = cart.map(i => {
    const p = products.find(x => x.id === i.id);
    
    let price;
    if (useDiscount) {
      price = p.sellPrice * (1 - (p.discount || 0)/100);
    } else {
      price = i.originalPrice || p.sellPrice;
    }
    
    totalAfter += price * i.qty;
    return {
      ...i,
      price: price
    };
  });
  
  // بناء نص الرسالة بشكل صحيح
  const itemsText = itemsWithPrice.map(i => 
    `• ${i.name} × ${i.qty} = ${(i.price * i.qty).toFixed(0)} جنيه`
  ).join('\n');
  
  const message = `*طلب جديد من Ashry Natural*
  
الاسم: ${customerName}
رقم الواتساب: 0${phone}
العنوان: ${address}

المنتجات:
${itemsText}

*الإجمالي: ${totalAfter.toFixed(0)} جنيه مصري*

شكراً لثقتك فينا
*Ashry Natural - صحتك تهمنا*`;
  
  const saveBtn = document.getElementById('saveOrderBtn');
  const loading = document.getElementById('orderLoading');
  saveBtn.disabled = true;
  loading.style.display = 'block';
  saveBtn.innerText = "جاري الحفظ والإرسال...";
  
  try {
    // حفظ الطلب في Firebase
    await addDoc(collection(db, "orders"), {
      customerName,
      customerPhone: '+2' + phone,
      customerAddress: address,
      items: itemsWithPrice,
      totalPrice: totalAfter,
      orderStatus: document.getElementById('status').value,
      timestamp: serverTimestamp(),
      appliedDiscount: useDiscount
    });
    
    // تحديث المخزون
    for (const i of cart) {
      await updateDoc(doc(db, "products", i.id), { stock: increment(-i.qty) });
    }
    
    // إعداد رابط الواتساب بشكل صحيح
    const encodedMessage = encodeURIComponent(message);
    const whatsappUrl = `https://wa.me/2${phone}?text=${encodedMessage}`;
    
    // محاولة فتح الواتساب
    const waWindow = window.open(whatsappUrl, '_blank');
    
    // إذا فشل فتح النافذة، عرض رسالة بديلة
    if (!waWindow || waWindow.closed || typeof waWindow.closed === 'undefined') {
      setTimeout(() => {
        if (confirm("لم يتم فتح واتساب تلقائياً\nاضغط موافق لفتحه يدويًا، أو cancel للنسخ يدوياً")) {
          window.open(whatsappUrl, '_blank');
        } else {
          // نسخ الرسالة للحافظة
          navigator.clipboard.writeText(message).then(() => {
            alert("تم نسخ الرسالة للحافظة!\nيمكنك لصقها في واتساب يدوياً\n\n" + message);
          }).catch(() => {
            alert("الرسالة جاهزة للإرسال:\n\n" + message);
          });
        }
      }, 500);
    }
    
    alert("تم حفظ الطلب بنجاح!");
    
    // إعادة تعيين النموذج
    document.getElementById('customerForm').reset();
    cart = []; 
    renderCart();
    document.getElementById('applyDiscount').checked = false;
    loadOrders(); 
    loadProducts();
    
  } catch (err) {
    console.error(err);
    alert("فشل حفظ الطلب: " + err.message);
  } finally {
    saveBtn.disabled = false;
    loading.style.display = 'none';
    saveBtn.innerText = "حفظ الطلب وإرسال واتساب";
  }
};

  window.loadOrders = async function() {
    try {
      const snap = await getDocs(query(collection(db,"orders"), orderBy("timestamp","desc")));
      orders = snap.docs.map(d => ({id: d.id, ...d.data()}));
      renderOrders(); 
      updateDashboard();
    } catch (error) {
      console.error('❌ خطأ في تحميل الطلبات:', error);
    }
  }

  // إضافة الدالة المفقودة renderOrders
  window.renderOrders = function() {
    const ordersList = document.getElementById('ordersList');
    if (!ordersList) return;
    
    const term = (document.getElementById('searchOrders')?.value || '').toLowerCase();
    const filtered = orders.filter(o => 
      o.customerName.toLowerCase().includes(term) || 
      o.customerPhone.includes(term) || 
      o.items.some(i => i.name.toLowerCase().includes(term))
    );
    
    ordersList.innerHTML = filtered.map(o => {
      const items = o.items.map(i => `${i.name}×${i.qty}`).join('، ');
      const date = o.timestamp?.toDate?.()?.toLocaleString('ar-EG') || '';
      const updated = o.updatedAt ? ` (محدث: ${o.updatedAt.toDate().toLocaleString('ar-EG')})` : '';
      
      return `<tr>
        <td>${o.customerName}</td>
        <td><a href="https://wa.me/${o.customerPhone}" target="_blank">${o.customerPhone}</a></td>
        <td>${items}</td>
        <td>${o.totalPrice} ج</td>
        <td><span class="badge ${o.orderStatus==='جديد'?'new':o.orderStatus==='تحت التجهيز'?'processing':'delivered'}">${o.orderStatus}</span></td>
        <td>${date}${updated}</td>
        <td class="action-btns">
          <button class="orange small" onclick="window.editOrder('${o.id}')">تعديل</button>
          <button class="print-btn small" onclick="window.printInvoice('${o.id}')">طباعة</button>
          <button class="danger small" onclick="window.delOrder('${o.id}')">حذف</button>
        </td>
      </tr>`;
    }).join('') || '<tr><td colspan="7" style="text-align:center;padding:50px;color:#999">لا توجد طلبات</td></tr>';
  }

  window.editOrder = async (id) => {
    const order = orders.find(o => o.id === id);
    if (!order) return alert("الطلب غير موجود");
    
    document.getElementById('editOrderId').value = order.id;
    document.getElementById('editCname').value = order.customerName;
    document.getElementById('editCphone').value = order.customerPhone.replace('+2', '');
    document.getElementById('editCaddr').value = order.customerAddress || '';
    document.getElementById('editStatus').value = order.orderStatus;
    
    editCart = order.items.map(item => ({
      id: item.id,
      name: item.name,
      qty: item.qty,
      imageUrl: item.imageUrl || '',
      originalPrice: item.price || products.find(p => p.id === item.id)?.sellPrice || 0
    }));
    
    document.getElementById('editApplyDiscount').checked = order.appliedDiscount || false;
    
    renderEditCart();
    
    document.querySelectorAll('.card').forEach(el => el.style.display = 'none');
    document.getElementById('edit-order').style.display = 'block';
  };

  window.updateOrder = async () => {
    if (editCart.length === 0) return alert("أضف منتجات أولاً");
    
    const orderId = document.getElementById('editOrderId').value;
    let phone = document.getElementById('editCphone').value.replace(/[^\d]/g, '');
    if (!phone.startsWith('01') || phone.length !== 11) return alert("رقم الواتساب لازم 11 رقم يبدأ بـ 01");
    
    const customerName = document.getElementById('editCname').value.trim();
    const address = document.getElementById('editCaddr').value.trim();
    const orderStatus = document.getElementById('editStatus').value;
    const useDiscount = document.getElementById('editApplyDiscount').checked;
    
    let totalAfter = 0;
    const itemsWithPrice = editCart.map(i => {
      const p = products.find(x => x.id === i.id);
      let price;
      
      if (useDiscount) {
        price = p.sellPrice * (1 - (p.discount || 0)/100);
      } else {
        price = i.originalPrice || p.sellPrice;
      }
      
      const itemTotal = price * i.qty;
      totalAfter += itemTotal;
      
      return {
        id: i.id,
        name: i.name,
        qty: i.qty,
        imageUrl: i.imageUrl || '',
        price: price
      };
    });
    
    const updateBtn = document.getElementById('updateOrderBtn');
    const loading = document.getElementById('editOrderLoading');
    updateBtn.disabled = true;
    loading.style.display = 'block';
    updateBtn.innerText = "جاري التحديث...";
    
    try {
      console.log("جاري تحديث الطلب:", orderId);
      
      await updateDoc(doc(db, "orders", orderId), {
        customerName: customerName,
        customerPhone: '+2' + phone,
        customerAddress: address,
        items: itemsWithPrice,
        totalPrice: totalAfter,
        orderStatus: orderStatus,
        appliedDiscount: useDiscount,
        updatedAt: serverTimestamp()
      });
      
      console.log("تم تحديث الطلب بنجاح");
      
      await loadOrders();
      
      alert("✅ تم تحديث الطلب بنجاح!");
      
      window.showPage('orders');
      
    } catch (err) {
      console.error("خطأ في تحديث الطلب:", err);
      alert("❌ فشل تحديث الطلب: " + err.message);
    } finally {
      updateBtn.disabled = false;
      loading.style.display = 'none';
      updateBtn.innerText = "تحديث الطلب";
    }
  };

  window.printInvoice = function(id) {
    const o = orders.find(x => x.id === id);
    if (!o) return alert("الطلب مش موجود");
    document.getElementById('inv_name').textContent = o.customerName;
    document.getElementById('inv_phone').textContent = o.customerPhone;
    document.getElementById('inv_addr').textContent = o.customerAddress || "غير محدد";
    document.getElementById('inv_date').textContent = new Date().toLocaleString('ar-EG');
    document.getElementById('inv_total').textContent = Number(o.totalPrice).toLocaleString();
    document.getElementById('inv_items').innerHTML = o.items.map(i => `
      <tr>
        <td style="padding:12px;font-weight:bold;border:1px solid #000">${i.name}</td>
        <td style="padding:12px;border:1px solid #000;text-align:center">${i.qty}</td>
        <td style="padding:12px;border:1px solid #000;text-align:center">${Number(i.price || 0).toFixed(0)}</td>
        <td style="padding:12px;border:1px solid #000;text-align:center">${(Number(i.price || 0) * i.qty).toFixed(0)}</td>
      </tr>
    `).join('');
    document.querySelectorAll('.card, .sidebar, #menuBtn').forEach(el => el.style.display = 'none');
    document.body.style.background = 'white';
    document.getElementById('invoice').style.display = 'block';
    setTimeout(() => { window.print(); }, 500);
    window.onafterprint = () => location.reload();
  };

  window.delOrder = id => confirm("حذف نهائي؟") && deleteDoc(doc(db,'orders',id)).then(loadOrders);
  
  window.deleteAllOrders = () => {
    if(confirm("هل أنت متأكد من حذف كل الطلبات؟ هذا الإجراء لا يمكن التراجع عنه!")) {
      getDocs(collection(db,"orders")).then(s => { 
        const b = writeBatch(db); 
        s.docs.forEach(d => b.delete(d.ref)); 
        return b.commit(); 
      }).then(loadOrders);
    }
  };
  
  window.deleteAllProducts = () => {
    if(confirm("هل أنت متأكد من حذف كل المنتجات؟ هذا الإجراء لا يمكن التراجع عنه!")) {
      getDocs(collection(db,"products")).then(s => { 
        const b = writeBatch(db); 
        s.docs.forEach(d => b.delete(d.ref)); 
        return b.commit(); 
      }).then(loadProducts);
    }
  };

  function updateDashboard() {
    const today = new Date().toDateString();
    const todayCount = orders.filter(o => o.timestamp && new Date(o.timestamp.toDate()).toDateString() === today).length;
    const completed = orders.filter(o => o.orderStatus === 'تم التوصيل').length;
    const sales = orders.reduce((a,b) => a + (b.totalPrice || 0), 0);
    document.getElementById('totalOrders').innerText = orders.length;
    document.getElementById('todayOrders').innerText = todayCount;
    document.getElementById('completedOrders').innerText = completed;
    document.getElementById('totalSales').innerText = sales.toLocaleString() + ' جنيه';
  }

  window.exportProductsToExcel = () => {
    const data = products.map(p => ({
      "اسم المنتج": p.name, "الكمية": p.stock, "سعر البيع": p.sellPrice,
      "الخصم %": p.discount || 0, "السعر بعد الخصم": (p.sellPrice * (1 - (p.discount || 0)/100)).toFixed(0),
      "الباركود": p.barcode || "", "رابط الصورة": p.imageUrl || ""
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    ws['!cols'] = [{wch:25},{wch:10},{wch:12},{wch:10},{wch:15},{wch:20},{wch:50}];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "المنتجات");
    XLSX.writeFile(wb, "AshryNatural_المنتجات_" + new Date().toISOString().slice(0,10) + ".xlsx");
  };

  window.exportOrdersToExcel = () => {
    const data = orders.map(o => ({
      "اسم العميل": o.customerName, "رقم الواتساب": o.customerPhone, "العنوان": o.customerAddress || "غير محدد",
      "المنتجات": o.items.map(i => `${i.name} × ${i.qty}`).join(" | "), "الإجمالي": o.totalPrice,
      "الحالة": o.orderStatus, "التاريخ": o.timestamp?.toDate?.()?.toLocaleString('ar-EG') || ""
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "الطلبات");
    XLSX.writeFile(wb, "AshryNatural_الطلبات_" + new Date().toISOString().slice(0,10) + ".xlsx");
  };

  window.importProductsFromExcel = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async function (ev) {
      try {
        const data = new Uint8Array(ev.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        let added = 0, skipped = 0;
        for (const r of rows) {
          const name = String(r["اسم المنتج"] || r["الاسم"] || "").trim();
          const stock = Number(r["الكمية"] || 0) || 0;
          const sellPrice = Number(r["سعر البيع"] || r["السعر"] || 0) || 0;
          const discount = Number(r["الخصم %"] || 0) || 0;
          const barcode = String(r["الباركود"] || "").trim();
          const imageUrl = String(r["رابط الصورة"] || "").trim();
          if (!name || sellPrice <= 0) { skipped++; continue; }
          await addDoc(collection(db, "products"), { name, stock, sellPrice, discount, barcode, imageUrl: imageUrl || "" });
          added++;
        }
        alert(`تم الاستيراد!\nأُضيف: ${added}\nتم تجاهل: ${skipped}`);
        
        window.loadProducts();
        
        e.target.value = "";
      } catch (err) { 
        alert("فشل قراءة الملف! تأكد من صيغة الإكسيل"); 
      }
    };
    reader.readAsArrayBuffer(file);
  };

  window.editProduct = id => {
    const p = products.find(x => x.id === id);
    document.getElementById('editProductId').value = id;
    document.getElementById('pname').value = p.name;
    document.getElementById('pstock').value = p.stock;
    document.getElementById('psell').value = p.sellPrice;
    document.getElementById('pdiscount').value = p.discount;
    document.getElementById('pbarcode').value = p.barcode || '';
    if(p.imageUrl) document.getElementById('imagePreview').innerHTML = `<img src="${p.imageUrl}" class="product-img-preview">`;
    document.getElementById('productSubmitBtn').innerText = "حفظ التعديل";
    window.showPage('products');
  };

  window.delP = id => confirm("حذف نهائي؟") && deleteDoc(doc(db,"products",id)).then(loadProducts);

  document.getElementById('productForm').onsubmit = async e => {
    e.preventDefault();
    const submitBtn = document.getElementById('productSubmitBtn');
    const loading = document.getElementById('productLoading');
    submitBtn.disabled = true;
    loading.style.display = 'block';
    const id = document.getElementById('editProductId').value;
    let imageUrl = products.find(p => p.id === id)?.imageUrl || '';
    const file = document.getElementById('pimage').files[0];
    if (file && file.size > 3*1024*1024) {
      alert("حجم الصورة كبير جدًا! اختر صورة أقل من 3 ميجا");
      submitBtn.disabled = false;
      loading.style.display = 'none';
      return;
    }
    if (file) {
      const formData = new FormData();
      formData.append('image', file);
      try {
        const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {method:'POST', body:formData});
        const json = await res.json();
        if (json.success) imageUrl = json.data.url;
        else { alert("فشل رفع الصورة"); submitBtn.disabled = false; loading.style.display = 'none'; return; }
      } catch { alert("مشكلة في رفع الصورة"); submitBtn.disabled = false; loading.style.display = 'none'; return; }
    }
    const data = {
      name: document.getElementById('pname').value.trim(),
      stock: +document.getElementById('pstock').value,
      sellPrice: +document.getElementById('psell').value,
      discount: +document.getElementById('pdiscount').value || 0,
      barcode: document.getElementById('pbarcode').value.trim(),
      imageUrl
    };
    try {
      id ? await updateDoc(doc(db,"products",id), data) : await addDoc(collection(db,"products"), data);
      alert(id ? "تم التعديل بنجاح" : "تم إضافة المنتج بنجاح");
      e.target.reset();
      document.getElementById('imagePreview').innerHTML = '';
      document.getElementById('editProductId').value = '';
      submitBtn.innerText = "إضافة منتج";
      loadProducts();
    } catch (err) { alert("خطأ: " + err.message); }
    finally {
      submitBtn.disabled = false;
      loading.style.display = 'none';
    }
  };

  document.getElementById('pimage').onchange = e => {
    const file = e.target.files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = ev => document.getElementById('imagePreview').innerHTML = `<img src="${ev.target.result}" class="product-img-preview">`;
      reader.readAsDataURL(file);
    }
  };

  // إضافة مستمعي الأحداث بعد تحميل الصفحة
  document.addEventListener('DOMContentLoaded', function() {
    // مستمعي أحداث تفعيل الخصم
    document.getElementById('applyDiscount').addEventListener('change', window.renderCart);
    document.getElementById('editApplyDiscount').addEventListener('change', window.renderEditCart);
    
    // مستمعي أحداث الأزرار
    document.getElementById('addToCartBtn').addEventListener('click', window.addToCart);
    document.getElementById('addToEditCartBtn').addEventListener('click', window.addToEditCart);
    document.getElementById('saveOrderBtn').addEventListener('click', window.saveOrder);
    document.getElementById('updateOrderBtn').addEventListener('click', window.updateOrder);
    document.getElementById('exportOrdersBtn').addEventListener('click', window.exportOrdersToExcel);
    document.getElementById('exportProductsBtn').addEventListener('click', window.exportProductsToExcel);
    document.getElementById('deleteAllOrdersBtn').addEventListener('click', window.deleteAllOrders);
    document.getElementById('deleteAllProductsBtn').addEventListener('click', window.deleteAllProducts);
    document.getElementById('importExcelBtn').addEventListener('click', function() {
      document.getElementById('importExcel').click();
    });
    document.getElementById('importExcel').addEventListener('change', window.importProductsFromExcel);
    
    // مستمعي أحداث البحث
    const searchOrders = document.getElementById('searchOrders');
    const searchProducts = document.getElementById('searchProducts');
    if (searchOrders) searchOrders.addEventListener('input', renderOrders);
    if (searchProducts) searchProducts.addEventListener('input', renderProducts);
    
    // مستمعي أحداث الباركود للطلبات
    document.getElementById('flashToggle').addEventListener('click', window.toggleFlash);
    document.getElementById('focusCamera').addEventListener('click', window.focusCamera);
    
    // مستمعي أحداث الباركود للمنتجات
    document.getElementById('productFlashToggle').addEventListener('click', window.toggleProductFlash);
    document.getElementById('focusProductCamera').addEventListener('click', window.focusProductCamera);
    document.getElementById('applyBarcode').addEventListener('click', window.applyScannedBarcode);
    document.getElementById('scanBarcodeForProduct').addEventListener('click', window.scanBarcodeForProduct);
    
    // تبديل عرض قسم الباركود مع التشغيل التلقائي
    document.getElementById('barcodeToggle').addEventListener('click', function() {
      const content = document.getElementById('barcodeContent');
      const isVisible = content.style.display === 'block';
      content.style.display = isVisible ? 'none' : 'block';
      this.classList.toggle('active', !isVisible);
      
      if (!isVisible) {
        // تشغيل الكاميرا تلقائياً عند فتح القسم
        setTimeout(() => {
          window.startBarcodeScanner();
        }, 500);
      } else {
        // إيقاف الكاميرا عند إغلاق القسم
        window.stopBarcodeScanner();
      }
    });
    
    document.getElementById('productBarcodeToggle').addEventListener('click', function() {
      const content = document.getElementById('productBarcodeContent');
      const isVisible = content.style.display === 'block';
      content.style.display = isVisible ? 'none' : 'block';
      this.classList.toggle('active', !isVisible);
      
      if (!isVisible) {
        // تشغيل الكاميرا تلقائياً عند فتح القسم
        setTimeout(() => {
          window.startProductBarcodeScanner();
        }, 500);
      } else {
        // إيقاف الكاميرا عند إغلاق القسم
        window.stopProductBarcodeScanner();
      }
    });
  });

  // عند تحميل الصفحة، اختبر الاتصال تلقائياً
  onAuthStateChanged(auth, user => {
    if (user) {
      document.getElementById('login').style.display = 'none';
      document.querySelector('.sidebar').style.display = 'block';
      document.getElementById('menuBtn').style.display = window.innerWidth <= 992 ? 'block' : 'none';
      window.showPage('dashboard');
      setInterval(() => {
        const currentTime = document.getElementById('currentTime');
        if (currentTime) {
          currentTime.innerText = new Date().toLocaleString('ar-EG');
        }
      }, 1000);
      
      // اختبار الاتصال التلقائي كل 5 دقائق
      connectionTestInterval = setInterval(() => {
        autoTestFirebaseConnection();
      }, 5 * 60 * 1000); // 5 دقائق
      
      // تحميل البيانات مباشرة
      window.loadProducts();
      window.loadOrders();
      
    } else {
      hideEverythingExceptLogin();
      if (connectionTestInterval) {
        clearInterval(connectionTestInterval);
        connectionTestInterval = null;
      }
    }
  });
  
</script>

</body>
</html>
