<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ashry Natural - نظام إدارة الطلبات</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{--p:#1e3c72;--s:#2a5298;--d:#e74c3c;--g:#27ae60;--o:#f39c12;--l:#f8fbff}
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Tajawal',sans-serif}
    body{background:#f0f2f5;color:#333;display:flex;min-height:100vh;overflow-x:hidden}
    .sidebar{width:280px;background:var(--p);color:#fff;position:fixed;top:0;right:0;bottom:0;padding:20px;z-index:1000;transition:.35s;box-shadow:-5px 0 20px rgba(0,0,0,.15);overflow-y:auto}
    .sidebar h2{text-align:center;font-size:26px;margin-bottom:40px;font-weight:900}
    .sidebar a{display:block;color:#fff;padding:16px 20px;border-radius:12px;margin:8px 0;text-decoration:none;font-weight:500;transition:.3s;cursor:pointer}
    .sidebar a i{margin-left:12px}
    .sidebar a:hover,.sidebar a.active{background:var(--s);transform:translateX(-8px)}
    .main{margin-right:280px;padding:20px;width:100%;transition:.35s;min-height:100vh}
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.1);padding:25px;margin-bottom:25px}
    input,select,button,textarea{width:100%;padding:14px 18px;margin:12px 0;border-radius:12px;border:1px solid #ddd;font-size:16px;transition:.3s}
    input:focus,select:focus{outline:none;border-color:var(--p);box-shadow:0 0 0 3px rgba(30,60,114,.15)}
    button{background:var(--p);color:#fff;border:none;cursor:pointer;font-weight:bold;padding:15px;border-radius:12px;transition:.3s}
    button:hover{background:var(--s)}
    button.danger{background:var(--d)}
    button.success{background:var(--g)}
    button.orange{background:var(--o);color:#fff}
    button.print-btn{background:#16a085;color:#fff}
    button.small{padding:8px 15px;font-size:14px;margin:5px}
    button:disabled{background:#999;cursor:not-allowed;opacity:0.7}
    table{width:100%;border-collapse:collapse;margin:25px 0;border-radius:12px;overflow:hidden;box-shadow:0 5px 20px rgba(0,0,0,.08)}
    th{background:var(--p);color:#fff;padding:16px;text-align:center}
    td{padding:14px;text-align:center;border-bottom:1px solid #eee}
    tr:hover{background:var(--l)}
    .badge{padding:6px 16px;border-radius:50px;font-size:13px;font-weight:bold}
    .badge.new{background:#e3f2fd;color:#1976d2}
    .badge.processing{background:#fff3e0;color:#f57c00}
    .badge.delivered{background:#e8f5e8;color:#27ae60}
    .searchable-select{position:relative}
    .searchable-select input{width:100%;padding:14px 40px 14px 18px}
    .searchable-select i{position:absolute;left:15px;top:50%;transform:translateY(-50%);color:#777}
    .cart-item{background:#f9f9f9;padding:15px;border-radius:12px;margin:10px 0;display:flex;align-items:center;flex-wrap:wrap;gap:15px;position:relative;padding-right:80px}
    .cart-item img{width:70px;height:70px;object-fit:cover;border-radius:8px;position:absolute;right:10px;top:50%;transform:translateY(-50%)}
    .cart-total{background:var(--p);color:#fff;padding:20px;border-radius:12px;text-align:center;font-size:26px;margin:20px 0;box-shadow:0 4px 12px rgba(0,0,0,0.2)}
    .discount-toggle{margin:20px 0;display:flex;align-items:center;gap:15px;font-size:18px;background:#fff8e1;padding:15px;border-radius:12px;flex-wrap:wrap}
    .switch{position:relative;display:inline-block;width:70px;height:34px}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#ccc;transition:.4s;border-radius:34px}
    .slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background:white;transition:.4s;border-radius:50%}
    input:checked + .slider{background:var(--o)}
    input:checked + .slider:before{transform:translateX(36px)}
    .action-btns button{margin:5px}
    #menuBtn{display:none;position:fixed;top:15px;left:15px;z-index:9999;background:var(--p);color:#fff;border:none;padding:12px;border-radius:50%;font-size:20px;cursor:pointer;box-shadow:0 4px 15px rgba(0,0,0,.2)}
    .export-btn{margin:10px 5px;padding:14px 25px;font-size:16px}
    .product-img-preview{width:100px;height:100px;object-fit:cover;border-radius:8px;margin:10px 0}
    .product-img-table{width:60px;height:60px;object-fit:cover;border-radius:8px}
    .loading{color:#1976d2;font-weight:bold;text-align:center;margin:20px 0;font-size:18px;display:none}
    @media(max-width:992px){
      .sidebar{transform:translateX(100%);width:280px}
      .sidebar.active{transform:translateX(0)}
      .main{margin-right:0;padding:15px}
      #menuBtn{display:block}
    }
    @media(max-width:576px){
      .card{padding:18px}
      .main{padding:10px}
      .cart-item{flex-direction:column;text-align:center;padding-right:15px}
      .cart-item img{position:static;transform:none;margin:0 auto 10px}
      table{font-size:14px}
      th,td{padding:10px 6px}
      .export-btn,.action-btns button{width:100%;margin:6px 0;display:block}
      .discount-toggle{flex-direction:column;align-items:flex-start}
    }
    #invoice{display:none;background:white;padding:30px;border:2px solid #333;border-radius:12px;max-width:800px;margin:20px auto;box-shadow:0 0 30px rgba(0,0,0,.3);font-size:18px}
    .invoice-header{text-align:center;margin-bottom:30px}
    .invoice-header h1{font-size:36px;color:var(--p);margin-bottom:10px;font-weight:900}
    .invoice-details{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:30px 0;background:#f9f9f9;padding:20px;border-radius:12px}
    .invoice-table{width:100%;border-collapse:collapse;margin:30px 0}
    .invoice-table th{background:var(--p);color:white;padding:15px;font-size:18px}
    .invoice-table td{padding:15px;border-bottom:1px solid #ddd;text-align:center;font-size:17px}
    .invoice-total{text-align:left;font-size:28px;font-weight:bold;margin-top:30px;padding:25px;background:linear-gradient(135deg,#f8fbff,#e3f2fd);border-radius:12px;color:var(--p)}
    @media print {
  @page { margin: 1cm; }

  body * {
    visibility: hidden !important;
  }

  #invoice, #invoice * {
    visibility: visible !important;
  }

  #invoice {
    position: absolute !important;
    left: 0 !important;
    top: 0 !important;
    width: 100% !important;
    padding: 20px !important;
    background: white !important;
    color: black !important;
  }

  .invoice-table, .invoice-table th, .invoice-table td {
    border: 1px solid black !important;
    border-collapse: collapse !important;
  }

  .invoice-table th {
    background: #1e3c72 !important;
    color: white !important;
    -webkit-print-color-adjust: exact !important;
    color-adjust: exact !important;
  }

  .invoice-total {
    background: linear-gradient(135deg, #f8fbff, #e3f2fd) !important;
    -webkit-print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
}
  </style>
</head>
<body>
<button id="menuBtn" onclick="document.querySelector('.sidebar').classList.toggle('active')">
  <i class="fas fa-bars"></i>
</button>

<div class="sidebar">
  <h2>Ashry Natural</h2>
  <a onclick="window.showPage('dashboard')" class="active">الرئيسية</a>
  <a onclick="window.showPage('add-order')">طلب جديد</a>
  <a onclick="window.showPage('orders')">الطلبات</a>
  <a onclick="window.showPage('products')">المنتجات</a>
  <a onclick="window.logout()">تسجيل الخروج</a>
</div>

<div class="main">
  <div id="invoice">
    <div class="invoice-header">
      <h1>Ashry Natural</h1>
      <p>فاتورة رسمية</p>
    </div>
    <div class="invoice-details">
      <div><strong>اسم العميل:</strong> <span id="inv_name"></span></div>
      <div><strong>رقم الواتساب:</strong> <span id="inv_phone"></span></div>
      <div><strong>العنوان:</strong> <span id="inv_addr"></span></div>
      <div><strong>تاريخ الفاتورة:</strong> <span id="inv_date"></span></div>
    </div>
    <table class="invoice-table">
      <thead><tr><th>المنتج</th><th>الكمية</th><th>سعر الوحدة</th><th>الإجمالي</th></tr></thead>
      <tbody id="inv_items"></tbody>
    </table>
    <div class="invoice-total">
      الإجمالي النهائي: <span id="inv_total">0</span> جنيه مصري
    </div>
    <div style="text-align:center;margin-top:50px;font-size:22px;color:#27ae60">
      شكراً لثقتكم بنا<br><strong>Ashry Natural - صحتك تهمنا</strong>
    </div>
  </div>

  <div id="login" class="card" style="max-width:420px;margin:100px auto;text-align:center">
    <h2 style="color:var(--p);margin-bottom:30px">Ashry Natural</h2>
    <form id="loginForm">
      <input type="email" id="email" placeholder="الإيميل" required>
      <input type="password" id="pass" placeholder="كلمة المرور" required>
      <button type="submit">دخول</button>
    </form>
  </div>

  <div id="dashboard" class="card" style="display:none">
    <h2>لوحة التحكم</h2>
    <p style="font-size:22px;color:var(--p);margin:20px 0" id="currentTime"></p>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:25px">
      <div class="stat" style="background:linear-gradient(135deg,var(--p),var(--s));color:#fff;padding:30px;border-radius:16px;text-align:center"><h3>إجمالي الطلبات</h3><h2 id="totalOrders">0</h2></div>
      <div class="stat" style="background:linear-gradient(135deg,#8e44ad,#9b59b6);color:#fff;padding:30px;border-radius:16px;text-align:center"><h3>طلبات اليوم</h3><h2 id="todayOrders">0</h2></div>
      <div class="stat" style="background:linear-gradient(135deg,var(--g),#2ecc71);color:#fff;padding:30px;border-radius:16px;text-align:center"><h3>تم التوصيل</h3><h2 id="completedOrders">0</h2></div>
      <div class="stat" style="background:linear-gradient(135deg,var(--o),#e67e22);color:#fff;padding:30px;border-radius:16px;text-align:center"><h3>إجمالي المبيعات</h3><h2 id="totalSales">0 جنيه</h2></div>
    </div>
  </div>

  <div id="add-order" class="card" style="display:none">
    <h2>إضافة طلب جديد</h2>
    <form id="customerForm">
      <input type="text" placeholder="اسم العميل" id="cname" required>
      <input type="tel" placeholder="رقم الواتساب (مثلاً: 01029149379)" id="cphone" required>
      <input type="text" placeholder="العنوان كامل" id="caddr" required>
      <select id="status">
        <option value="جديد">جديد</option>
        <option value="تحت التجهيز">تحت التجهيز</option>
        <option value="تم التوصيل">تم التوصيل</option>
      </select>
    </form>
    <div class="discount-toggle">
      <label class="switch">
        <input type="checkbox" id="applyDiscount">
        <span class="slider"></span>
      </label>
      <span>تفعيل الخصم على كل المنتجات في هذا الطلب</span>
    </div>
    <hr style="margin:30px 0">
    <h3>إضافة منتجات</h3>
    <div style="display:grid;grid-template-columns:1fr 120px auto;gap:15px;align-items:end">
      <div class="searchable-select">
        <input type="text" id="prodSearch" placeholder="اكتب اسم المنتج..." autocomplete="off">
        <i class="fas fa-search"></i>
        <select id="prodSelect" size="8" style="display:none;position:absolute;top:100%;left:0;right:0;z-index:99;background:#fff;border:1px solid #ddd;border-radius:12px;max-height:300px;overflow-y:auto"></select>
      </div>
      <input type="number" id="qtyInput" value="1" min="1">
      <button type="button" onclick="window.addToCart()" class="success">إضافة</button>
    </div>
    <div id="cartItems" style="margin:20px 0"></div>
    <div class="cart-total" id="cartTotal">الإجمالي: 0 جنيه</div>
    <button onclick="window.saveOrder()" id="saveOrderBtn" style="margin-top:20px;padding:18px;font-size:18px">حفظ الطلب وإرسال واتساب</button>
    <div id="orderLoading" class="loading">جاري حفظ الطلب، انتظر لحظة...</div>
  </div>

  <div id="orders" class="card" style="display:none">
    <h2>جميع الطلبات</h2>
    <div style="margin:20px 0">
      <button class="success export-btn" onclick="window.exportOrdersToExcel()">تصدير إلى إكسيل</button>
      <button class="danger export-btn" onclick="window.deleteAllOrders()">حذف كل الطلبات</button>
    </div>
    <input type="text" id="searchOrders" placeholder="بحث..." oninput="renderOrders()">
    <table>
      <thead><tr>
        <th>العميل</th><th>التليفون</th><th>المنتجات</th><th>الإجمالي</th><th>الحالة</th><th>التاريخ</th><th>إجراءات</th>
      </tr></thead>
      <tbody id="ordersList"></tbody>
    </table>
  </div>

  <div id="products" class="card" style="display:none">
    <h2>إدارة المنتجات</h2>
    <div style="margin:20px 0; text-align:center;">
      <button class="success export-btn" onclick="window.exportProductsToExcel()">تصدير إلى إكسيل</button>
      <button class="danger export-btn" onclick="window.deleteAllProducts()">حذف كل المنتجات</button>
      <button class="orange export-btn" onclick="document.getElementById('importExcel').click()">استيراد من إكسل</button>
      <input type="file" id="importExcel" accept=".xlsx,.xls" onchange="window.importProductsFromExcel(event)" style="display:none;">
      <div style="margin-top:12px; color:#555; font-size:14px;">
        الأعمدة المطلوبة: <strong>اسم
        المنتج | الكمية | سعر البيع | الخصم % | رابط الصورة (اختياري)</strong>
      </div>
    </div>
    <input type="text" id="searchProducts" placeholder="بحث عن منتج..." oninput="renderProducts()">
    <form id="productForm" style="background:#f9f9f9;padding:25px;border-radius:16px;margin:25px 0">
      <input type="hidden" id="editProductId">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px">
        <input placeholder="اسم المنتج" id="pname" required>
        <input type="number" placeholder="الكمية" id="pstock" required>
        <input type="number" placeholder="سعر البيع" id="psell" required>
        <input type="number" placeholder="الخصم %" id="pdiscount" min="0" max="100" value="0">
        <input type="file" id="pimage" accept="image/*">
        <div id="imagePreview"></div>
      </div>
      <button type="submit" id="productSubmitBtn">إضافة منتج</button>
      <div id="productLoading" class="loading">جاري حفظ المنتج...</div>
    </form>
    <table>
      <thead><tr>
        <th>صورة</th><th>المنتج</th><th>المتوفر</th><th>سعر البيع</th><th>الخصم %</th><th>السعر بعد الخصم</th><th>إجراءات</th>
      </tr></thead>
      <tbody id="productsList"></tbody>
    </table>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, serverTimestamp, increment, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const app = initializeApp({
    apiKey: "AIzaSyAuRBWr54OUPpH63rYX2GuX5UGMippYSkQ",
    authDomain: "ashrynutral.firebaseapp.com",
    projectId: "ashrynutral",
    storageBucket: "ashrynutral.firebasestorage.app",
    messagingSenderId: "272736958880",
    appId: "1:272736958880:web:5d565a91be484a9cbf4cc5"
  });

  const auth = getAuth(app);
  const db = getFirestore(app);
  const IMGBB_API_KEY = "6e0b6ad4c71f839987c098fe183beca5";

  let products = [], orders = [], cart = [];

  window.showPage = function(s) {
    document.querySelectorAll('.card, #invoice').forEach(el => el.style.display = 'none');
    document.getElementById(s).style.display = 'block';
    document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
    document.querySelector(`[onclick="window.showPage('${s}')"]`)?.classList.add('active');
    if(s==='orders') loadOrders();
    if(s==='products') { loadProducts(); document.getElementById('searchProducts').value = ''; }
    if(s==='add-order') { cart = []; renderCart(); document.getElementById('applyDiscount').checked = false; loadProductsForCart(); }
    if(s==='dashboard') updateDashboard();
  };

  window.logout = () => signOut(auth);

  document.getElementById('loginForm').onsubmit = e => {
    e.preventDefault();
    signInWithEmailAndPassword(auth, document.getElementById('email').value.trim(), document.getElementById('pass').value)
      .catch(err => alert("خطأ في الدخول: " + err.message));
  };

  onAuthStateChanged(auth, user => {
    if(user){
      window.showPage('dashboard');
      setInterval(() => document.getElementById('currentTime').innerText = new Date().toLocaleString('ar-EG'), 1000);
      loadProducts();
      loadOrders();
    } else window.showPage('login');
  });

  async function loadProducts() {
    const snap = await getDocs(collection(db, "products"));
    products = snap.docs.map(d => ({id: d.id, ...d.data(), discount: d.data().discount || 0, imageUrl: d.data().imageUrl || ''}));
    renderProducts();
    loadProductsForCart();
  }

  function renderProducts() {
    const term = (document.getElementById('searchProducts')?.value || '').toLowerCase();
    const filtered = products.filter(p => p.name.toLowerCase().includes(term));
    document.getElementById('productsList').innerHTML = filtered.map(p => {
      const priceAfter = p.sellPrice * (1 - p.discount/100);
      return `<tr>
        <td>${p.imageUrl ? `<img src="${p.imageUrl}" class="product-img-table">` : 'لا صورة'}</td>
        <td><strong>${p.name}</strong></td>
        <td>${p.stock > 0 ? p.stock : '<span style="color:red">نفد</span>'}</td>
        <td>${p.sellPrice} ج</td>
        <td><strong style="color:var(--o)">${p.discount}%</strong></td>
        <td style="background:#fff8e1">${priceAfter.toFixed(0)} ج</td>
        <td class="action-btns">
          <button class="orange small" onclick="window.editProduct('${p.id}')">تعديل</button>
          <button class="danger small" onclick="window.delP('${p.id}')">حذف</button>
        </td>
      </tr>`;
    }).join('') || '<tr><td colspan="7" style="text-align:center;padding:50px;color:#999">لا توجد منتجات</td></tr>';
  }

  document.getElementById('pimage').onchange = e => {
    const file = e.target.files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = ev => document.getElementById('imagePreview').innerHTML = `<img src="${ev.target.result}" class="product-img-preview">`;
      reader.readAsDataURL(file);
    }
  };

  document.getElementById('productForm').onsubmit = async e => {
    e.preventDefault();
    const submitBtn = document.getElementById('productSubmitBtn');
    const loading = document.getElementById('productLoading');
    submitBtn.disabled = true;
    loading.style.display = 'block';

    const id = document.getElementById('editProductId').value;
    let imageUrl = products.find(p => p.id === id)?.imageUrl || '';
    const file = document.getElementById('pimage').files[0];

    if (file && file.size > 3*1024*1024) {
      alert("حجم الصورة كبير جدًا! اختر صورة أقل من 3 ميجا");
      submitBtn.disabled = false;
      loading.style.display = 'none';
      return;
    }

    if (file) {
      const formData = new FormData();
      formData.append('image', file);
      try {
        const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {method:'POST', body:formData});
        const json = await res.json();
        if (json.success) imageUrl = json.data.url;
        else { alert("فشل رفع الصورة"); submitBtn.disabled = false; loading.style.display = 'none'; return; }
      } catch { alert("مشكلة في رفع الصورة"); submitBtn.disabled = false; loading.style.display = 'none'; return; }
    }

    const data = {
      name: document.getElementById('pname').value.trim(),
      stock: +document.getElementById('pstock').value,
      sellPrice: +document.getElementById('psell').value,
      discount: +document.getElementById('pdiscount').value || 0,
      imageUrl
    };

    try {
      id ? await updateDoc(doc(db,"products",id), data) : await addDoc(collection(db,"products"), data);
      alert(id ? "تم التعديل بنجاح" : "تم إضافة المنتج بنجاح");
      e.target.reset();
      document.getElementById('imagePreview').innerHTML = '';
      document.getElementById('editProductId').value = '';
      submitBtn.innerText = "إضافة منتج";
      loadProducts();
    } catch (err) { alert("خطأ: " + err.message); }
    finally {
      submitBtn.disabled = false;
      loading.style.display = 'none';
    }
  };

  window.editProduct = id => {
    const p = products.find(x => x.id === id);
    document.getElementById('editProductId').value = id;
    document.getElementById('pname').value = p.name;
    document.getElementById('pstock').value = p.stock;
    document.getElementById('psell').value = p.sellPrice;
    document.getElementById('pdiscount').value = p.discount;
    if(p.imageUrl) document.getElementById('imagePreview').innerHTML = `<img src="${p.imageUrl}" class="product-img-preview">`;
    document.getElementById('productSubmitBtn').innerText = "حفظ التعديل";
    window.showPage('products');
  };

  window.delP = id => confirm("حذف نهائي؟") && deleteDoc(doc(db,"products",id)).then(loadProducts);

  function loadProductsForCart() {
    const input = document.getElementById('prodSearch');
    const select = document.getElementById('prodSelect');
    input.oninput = () => {
      const term = input.value.toLowerCase();
      select.innerHTML = '';
      products.filter(p => p.stock > 0 && p.name.toLowerCase().includes(term)).forEach(p => {
        const opt = new Option(`${p.name} - ${p.sellPrice} ج (متوفر: ${p.stock})`, p.id);
        select.add(opt);
      });
      select.style.display = select.options.length ? 'block' : 'none';
    };
    input.onclick = () => input.oninput();
    select.onchange = () => { input.value = select.selectedOptions[0].text.split(' - ')[0]; select.style.display = 'none'; };
  }

  window.addToCart = () => {
    const select = document.getElementById('prodSelect');
    if(!select.value) return alert("اختر منتج");
    const qty = +document.getElementById('qtyInput').value || 1;
    const p = products.find(x => x.id === select.value);
    if(p.stock < qty) return alert("الكمية غير متوفرة");
    cart.push({id: p.id, name: p.name, qty, imageUrl: p.imageUrl || ''});
    renderCart();
    document.getElementById('prodSearch').value = '';
    document.getElementById('qtyInput').value = 1;
    select.style.display = 'none';
  };

  function renderCart() {
    const useDiscount = document.getElementById('applyDiscount').checked;
    let total = 0;
    let html = cart.length === 0 ? '<p style="text-align:center;color:#999;margin:40px 0;">السلة فارغة</p>' : '';
    cart.forEach((item, i) => {
      const p = products.find(x => x.id === item.id);
      const price = useDiscount ? p.sellPrice * (1 - p.discount/100) : p.sellPrice;
      total += price * item.qty;
      html += `
        <div class="cart-item">
          ${item.imageUrl ? `<img src="${item.imageUrl}">` : '<div style="width:70px;height:70px;background:#eee;border-radius:8px"></div>'}
          <div style="font-weight:bold;font-size:17px;">${item.name} × ${item.qty}</div>
          ${useDiscount && p.discount > 0 ? `<small style="color:#e67e22;font-weight:bold;">خصم ${p.discount}%</small><br>` : ''}
          <div style="font-size:19px;color:var(--p);margin-top:8px;"><strong>${(price * item.qty).toFixed(0)} جنيه</strong></div>
          <button class="danger small" onclick="cart.splice(${i},1);renderCart()">حذف</button>
        </div>`;
    });
    document.getElementById('cartItems').innerHTML = html;
    document.getElementById('cartTotal').innerHTML = `<div style="background:#1e3a8a;padding:20px;border-radius:12px;color:#ffffff;font-size:26px;font-weight:bold;text-align:center;box-shadow:0 4px 12px rgba(0,0,0,0.2)">
      الإجمالي: ${total.toFixed(0)} جنيه مصري
    </div>`;
  }

  document.getElementById('applyDiscount').onchange = renderCart;

  window.saveOrder = async () => {
    if(cart.length === 0) return alert("أضف منتجات");
    let phone = document.getElementById('cphone').value.replace(/[^\d]/g, '');
    if(!phone.startsWith('01') || phone.length !== 11) return alert("رقم الواتساب لازم 11 رقم يبدأ بـ 01");
    const fullPhone = '+2' + phone;
    const useDiscount = document.getElementById('applyDiscount').checked;
    const totalAfter = cart.reduce((s, i) => s + (useDiscount ? products.find(p=>p.id===i.id).sellPrice * (1 - products.find(p=>p.id===i.id).discount/100) : products.find(p=>p.id===i.id).sellPrice) * i.qty, 0);
    const items = cart.map(i => ({...i, price: useDiscount ? products.find(p=>p.id===i.id).sellPrice * (1 - products.find(p=>p.id===i.id).discount/100) : products.find(p=>p.id===i.id).sellPrice}));

    const saveBtn = document.getElementById('saveOrderBtn');
    const loading = document.getElementById('orderLoading');
    saveBtn.disabled = true;
    loading.style.display = 'block';

    try {
      await addDoc(collection(db,"orders"), {
        customerName: document.getElementById('cname').value.trim(),
        customerPhone: fullPhone,
        customerAddress: document.getElementById('caddr').value.trim(),
        items, totalPrice: totalAfter,
        orderStatus: document.getElementById('status').value,
        timestamp: serverTimestamp()
      });
      for(const i of cart) await updateDoc(doc(db,"products",i.id), {stock: increment(-i.qty)});
      alert("تم حفظ الطلب بنجاح");
      document.getElementById('customerForm').reset();
      cart = []; renderCart(); document.getElementById('applyDiscount').checked = false;
      loadOrders(); loadProducts();
    } catch(err) { alert("خطأ: " + err.message); }
    finally {
      saveBtn.disabled = false;
      loading.style.display = 'none';
    }
  };

  async function loadOrders() {
    const snap = await getDocs(query(collection(db,"orders"), orderBy("timestamp","desc")));
    orders = snap.docs.map(d => ({id: d.id, ...d.data()}));
    renderOrders(); updateDashboard();
  }

  function renderOrders() {
    const term = (document.getElementById('searchOrders')?.value || '').toLowerCase();
    const filtered = orders.filter(o => o.customerName.toLowerCase().includes(term) || o.customerPhone.includes(term) || o.items.some(i => i.name.toLowerCase().includes(term)));
    document.getElementById('ordersList').innerHTML = filtered.map(o => {
      const items = o.items.map(i => `${i.name}×${i.qty}`).join('، ');
      const date = o.timestamp?.toDate?.()?.toLocaleString('ar-EG') || '';
      return `<tr>
        <td>${o.customerName}</td>
        <td><a href="https://wa.me/${o.customerPhone}" target="_blank">${o.customerPhone}</a></td>
        <td>${items}</td>
        <td>${o.totalPrice} ج</td>
        <td><span class="badge ${o.orderStatus==='جديد'?'new':o.orderStatus==='تحت التجهيز'?'processing':'delivered'}">${o.orderStatus}</span></td>
        <td>${date}</td>
        <td class="action-btns">
          <button class="print-btn small" onclick="window.printInvoice('${o.id}')">طباعة</button>
          <button class="danger small" onclick="window.delOrder('${o.id}')">حذف</button>
        </td>
      </tr>`;
    }).join('') || '<tr><td colspan="7" style="text-align:center;padding:50px;color:#999">لا توجد طلبات</td></tr>';
  }

  window.delOrder = id => confirm("حذف نهائي؟") && deleteDoc(doc(db,'orders',id)).then(loadOrders);
  window.deleteAllOrders = () => confirm("حذف الكل؟") && getDocs(collection(db,"orders")).then(s => { const b = writeBatch(db); s.docs.forEach(d => b.delete(d.ref)); return b.commit(); }).then(loadOrders);
  window.deleteAllProducts = () => confirm("حذف الكل؟") && getDocs(collection(db,"products")).then(s => { const b = writeBatch(db); s.docs.forEach(d => b.delete(d.ref)); return b.commit(); }).then(loadProducts);

  function updateDashboard() {
    const today = new Date().toDateString();
    const todayCount = orders.filter(o => o.timestamp && new Date(o.timestamp.toDate()).toDateString() === today).length;
    const completed = orders.filter(o => o.orderStatus === 'تم التوصيل').length;
    const sales = orders.reduce((a,b) => a + (b.totalPrice || 0), 0);
    document.getElementById('totalOrders').innerText = orders.length;
    document.getElementById('todayOrders').innerText = todayCount;
    document.getElementById('completedOrders').innerText = completed;
    document.getElementById('totalSales').innerText = sales.toLocaleString() + ' جنيه';
  }

  window.exportProductsToExcel = () => {
    const data = products.map(p => ({
      "اسم المنتج": p.name, "الكمية": p.stock, "سعر البيع": p.sellPrice,
      "الخصم %": p.discount || 0, "السعر بعد الخصم": (p.sellPrice * (1 - (p.discount || 0)/100)).toFixed(0),
      "رابط الصورة": p.imageUrl || ""
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    ws['!cols'] = [{wch:25},{wch:10},{wch:12},{wch:10},{wch:15},{wch:50}];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "المنتجات");
    XLSX.writeFile(wb, "AshryNatural_المنتجات_" + new Date().toISOString().slice(0,10) + ".xlsx");
  };

  window.exportOrdersToExcel = () => {
    const data = orders.map(o => ({
      "اسم العميل": o.customerName, "رقم الواتساب": o.customerPhone, "العنوان": o.customerAddress || "غير محدد",
      "المنتجات": o.items.map(i => `${i.name} × ${i.qty}`).join(" | "), "الإجمالي": o.totalPrice,
      "الحالة": o.orderStatus, "التاريخ": o.timestamp?.toDate?.()?.toLocaleString('ar-EG') || ""
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "الطلبات");
    XLSX.writeFile(wb, "AshryNatural_الطلبات_" + new Date().toISOString().slice(0,10) + ".xlsx");
  };

  window.importProductsFromExcel = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async function (ev) {
      try {
        const data = new Uint8Array(ev.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        let added = 0, skipped = 0;
        for (const r of rows) {
          const name = String(r["اسم المنتج"] || r["الاسم"] || "").trim();
          const stock = Number(r["الكمية"] || 0) || 0;
          const sellPrice = Number(r["سعر البيع"] || r["السعر"] || 0) || 0;
          const discount = Number(r["الخصم %"] || 0) || 0;
          const imageUrl = String(r["رابط الصورة"] || "").trim();
          if (!name || sellPrice <= 0) { skipped++; continue; }
          await addDoc(collection(db, "products"), { name, stock, sellPrice, discount, imageUrl: imageUrl || "" });
          added++;
        }
        alert(`تم الاستيراد!\nأُضيف: ${added}\nتم تجاهل: ${skipped}`);
        loadProducts();
        e.target.value = "";
      } catch (err) { alert("فشل قراءة الملف! تأكد من صيغة الإكسيل"); }
    };
    reader.readAsArrayBuffer(file);
  };

  window.printInvoice = function(id) {
  const o = orders.find(x => x.id === id);
  if (!o) return alert("الطلب مش موجود");

  // 1- ملء بيانات الفاتورة
  document.getElementById('inv_name').textContent = o.customerName;
  document.getElementById('inv_phone').textContent = o.customerPhone;
  document.getElementById('inv_addr').textContent = o.customerAddress || "غير محدد";
  document.getElementById('inv_date').textContent = new Date().toLocaleString('ar-EG');
  document.getElementById('inv_total').textContent = Number(o.totalPrice).toLocaleString();

  document.getElementById('inv_items').innerHTML = o.items.map(i => `
    <tr>
      <td style="padding:12px;font-weight:bold;border:1px solid #000">${i.name}</td>
      <td style="padding:12px;border:1px solid #000;text-align:center">${i.qty}</td>
      <td style="padding:12px;border:1px solid #000;text-align:center">${Number(i.price || 0).toFixed(0)}</td>
      <td style="padding:12px;border:1px solid #000;text-align:center">${(Number(i.price || 0) * i.qty).toFixed(0)}</td>
    </tr>
  `).join('');

  // 2- إخفاء كل الصفحة ما عدا الفاتورة
  document.querySelectorAll('.card, .sidebar, #menuBtn').forEach(el => el.style.display = 'none');
  document.body.style.background = 'white';
  document.body.style.margin = '0';
  document.body.style.padding = '0';

  const invoice = document.getElementById('invoice');
  invoice.style.display = 'block';
  invoice.style.position = 'absolute';
  invoice.style.left = '0';
  invoice.style.top = '0';
  invoice.style.width = '100%';
  invoice.style.padding = '30px';
  invoice.style.boxShadow = 'none';
  invoice.style.background = 'white';

  // 3- أهم حاجة: إجبار المتصفح يرسم الفاتورة كاملة قبل الطباعة
  setTimeout(() => {
    window.print();
  }, 300);   // 300 مللي ثانية كافية جدًا

  // 4- إرجاع الصفحة زي ما كانت بعد الطباعة أو الإلغاء
  window.onafterprint = () => {
    location.reload();   // أضمن طريقة ترجع كل حاجة زي ما كانت
  };
};
</script>
</body>
</html>
