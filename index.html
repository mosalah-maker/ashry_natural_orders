<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ashry Natural - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
  <style>
    :root {
      --p: #1e3c72;
      --s: #2a5298;
      --d: #e74c3c;
      --g: #27ae60;
      --o: #f39c12;
      --l: #f8fbff;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Tajawal', sans-serif;
    }
    
    body {
      background: #f0f2f5;
      color: #333;
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .sidebar {
      width: 280px;
      background: var(--p);
      color: #fff;
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      padding: 20px;
      z-index: 1000;
      transition: .35s;
      box-shadow: -5px 0 20px rgba(0,0,0,.15);
      overflow-y: auto;
    }
    
    .sidebar h2 {
      text-align: center;
      font-size: 26px;
      margin-bottom: 40px;
      font-weight: 900;
    }
    
    .sidebar a {
      display: block;
      color: #fff;
      padding: 16px 20px;
      border-radius: 12px;
      margin: 8px 0;
      text-decoration: none;
      font-weight: 500;
      transition: .3s;
      cursor: pointer;
    }
    
    .sidebar a i {
      margin-left: 12px;
    }
    
    .sidebar a:hover,
    .sidebar a.active {
      background: var(--s);
      transform: translateX(-8px);
    }
    
    .main {
      margin-right: 280px;
      padding: 20px;
      width: 100%;
      transition: .35s;
      min-height: 100vh;
    }
    
    .card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 8px 30px rgba(0,0,0,.1);
      padding: 25px;
      margin-bottom: 25px;
    }
    
    input, select, button, textarea {
      width: 100%;
      padding: 14px 18px;
      margin: 12px 0;
      border-radius: 12px;
      border: 1px solid #ddd;
      font-size: 16px;
      transition: .3s;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--p);
      box-shadow: 0 0 0 3px rgba(30,60,114,.15);
    }
    
    button {
      background: var(--p);
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: bold;
      padding: 15px;
      border-radius: 12px;
      transition: .3s;
    }
    
    button:hover {
      background: var(--s);
    }
    
    button.danger {
      background: var(--d);
    }
    
    button.success {
      background: var(--g);
    }
    
    button.orange {
      background: var(--o);
      color: #fff;
    }
    
    button.print-btn {
      background: #16a085;
      color: #fff;
    }
    
    button.small {
      padding: 8px 15px;
      font-size: 14px;
      margin: 5px;
    }
    
    button:disabled {
      background: #999;
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 25px 0;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 20px rgba(0,0,0,.08);
    }
    
    th {
      background: var(--p);
      color: #fff;
      padding: 16px;
      text-align: center;
    }
    
    td {
      padding: 14px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }
    
    tr:hover {
      background: var(--l);
    }
    
    .badge {
      padding: 6px 16px;
      border-radius: 50px;
      font-size: 13px;
      font-weight: bold;
    }
    
    .badge.new {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .badge.processing {
      background: #fff3e0;
      color: #f57c00;
    }
    
    .badge.delivered {
      background: #e8f5e8;
      color: #27ae60;
    }
    
    .searchable-select {
      position: relative;
    }
    
    .searchable-select input {
      width: 100%;
      padding: 14px 40px 14px 18px;
    }
    
    .searchable-select i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #777;
    }
    
    .cart-item {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 12px;
      margin: 10px 0;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      position: relative;
      padding-right: 80px;
    }
    
    .cart-item img {
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 8px;
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
    }
    
    .cart-total {
      background: var(--p);
      color: #fff;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      font-size: 26px;
      margin: 20px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .discount-toggle {
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 18px;
      background: #fff8e1;
      padding: 15px;
      border-radius: 12px;
      flex-wrap: wrap;
    }
    
    .switch {
      position: relative;
      display: inline-block;
      width: 70px;
      height: 34px;
    }
    
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background: var(--o);
    }
    
    input:checked + .slider:before {
      transform: translateX(36px);
    }
    
    .action-btns button {
      margin: 5px;
    }
    
    #menuBtn {
      display: none;
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 9999;
      background: var(--p);
      color: #fff;
      border: none;
      padding: 12px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,.2);
    }
    
    .export-btn {
      margin: 10px 5px;
      padding: 14px 25px;
      font-size: 16px;
    }
    
    .product-img-preview {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    .product-img-table {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
    }
    
    .loading {
      color: #1976d2;
      font-weight: bold;
      text-align: center;
      margin: 20px 0;
      font-size: 18px;
      display: none;
    }
    
    .remove-item-btn {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: #e74c3c;
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }
    
    .barcode-section {
      margin: 20px 0;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
      border: 2px dashed #ddd;
    }
    
    .barcode-container {
      position: relative;
      width: 100%;
      max-width: 500px;
      margin: 0 auto;
    }
    
    .barcode-scanner {
      width: 100%;
      height: 400px;
      background: #000;
      border-radius: 12px;
      object-fit: cover;
    }
    
    .barcode-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.7);
      color: white;
      font-size: 18px;
      border-radius: 12px;
      z-index: 10;
    }
    
    .barcode-controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: center;
    }
    
    .barcode-controls button {
      width: auto;
      padding: 10px 20px;
    }
    
    .barcode-result {
      background: #e8f5e8;
      padding: 15px;
      border-radius: 12px;
      margin-top: 15px;
      text-align: center;
      display: none;
    }
    
    .barcode-result.success {
      background: #e8f5e8;
      color: #27ae60;
    }
    
    .barcode-result.error {
      background: #ffeaea;
      color: #e74c3c;
    }
    
    .barcode-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      cursor: pointer;
      padding: 10px;
      background: #fff;
      border-radius: 8px;
    }
    
    .barcode-toggle i {
      transition: transform 0.3s;
    }
    
    .barcode-toggle.active i {
      transform: rotate(180deg);
    }
    
    .barcode-input-group {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }
    
    .barcode-input-group input {
      flex: 1;
      margin: 0;
    }
    
    .barcode-input-group button {
      width: auto;
      padding: 10px 15px;
    }
    
    .scan-area {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 250px;
      border: 3px solid #fff;
      border-radius: 12px;
      box-shadow: 0 0 0 4000px rgba(0,0,0,0.5);
      z-index: 5;
      transition: all 0.3s ease;
    }
    
    .scan-area.scanning {
      border-color: #ffeb3b;
      animation: pulse 1.5s infinite;
    }
    
    .scan-area.success {
      border-color: #27ae60;
      background: rgba(39,174,96,0.1);
    }
    
    .scan-area.error {
      border-color: #e74c3c;
      background: rgba(231,76,60,0.1);
    }
    
    .scan-area-line {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: #27ae60;
      animation: scanLine 2s linear infinite;
      display: none;
    }
    
    .scan-area.scanning .scan-area-line {
      display: block;
    }
    
    .zoom-indicator {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      z-index: 10;
    }
    
    .scan-instructions {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 12px;
      z-index: 10;
      text-align: center;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 4000px rgba(0,0,0,0.5), 0 0 0 0 rgba(255,235,59,0.7); }
      70% { box-shadow: 0 0 0 4000px rgba(0,0,0,0.5), 0 0 0 10px rgba(255,235,59,0); }
      100% { box-shadow: 0 0 0 4000px rgba(0,0,0,0.5), 0 0 0 0 rgba(255,235,59,0); }
    }
    
    @keyframes scanLine {
      0% { top: 0; }
      100% { top: 100%; }
    }
    
    @media (max-width: 992px) {
      .sidebar {
        transform: translateX(100%);
        width: 280px;
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      .main {
        margin-right: 0;
        padding: 15px;
      }
      
      #menuBtn {
        display: block;
      }
    }
    
    @media (max-width: 576px) {
      .card {
        padding: 18px;
      }
      
      .main {
        padding: 10px;
      }
      
      .cart-item {
        flex-direction: column;
        text-align: center;
        padding-right: 15px;
        padding-left: 15px;
      }
      
      .cart-item img {
        position: static;
        transform: none;
        margin: 0 auto 10px;
      }
      
      .remove-item-btn {
        position: static;
        transform: none;
        margin-top: 10px;
      }
      
      table {
        font-size: 14px;
      }
      
      th, td {
        padding: 10px 6px;
      }
      
      .export-btn, .action-btns button {
        width: 100%;
        margin: 6px 0;
        display: block;
      }
      
      .discount-toggle {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .barcode-controls {
        flex-direction: column;
      }
      
      .barcode-controls button {
        width: 100%;
      }
      
      .barcode-input-group {
        flex-direction: column;
      }
      
      .barcode-input-group button {
        width: 100%;
      }
      
      .scan-area {
        width: 90%;
        height: 200px;
      }
      
      .barcode-scanner {
        height: 350px;
      }
    }
    
    #invoice {
      display: none;
      background: white;
      padding: 30px;
      border: 2px solid #333;
      border-radius: 12px;
      max-width: 800px;
      margin: 20px auto;
      box-shadow: 0 0 30px rgba(0,0,0,.3);
      font-size: 18px;
    }
    
    .invoice-header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .invoice-header h1 {
      font-size: 36px;
      color: var(--p);
      margin-bottom: 10px;
      font-weight: 900;
    }
    
    .invoice-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 30px 0;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 12px;
    }
    
    .invoice-table {
      width: 100%;
      border-collapse: collapse;
      margin: 30px 0;
    }
    
    .invoice-table th {
      background: var(--p);
      color: white;
      padding: 15px;
      font-size: 18px;
    }
    
    .invoice-table td {
      padding: 15px;
      border-bottom: 1px solid #ddd;
      text-align: center;
      font-size: 17px;
    }
    
    .invoice-total {
      text-align: left;
      font-size: 28px;
      font-weight: bold;
      margin-top: 30px;
      padding: 25px;
      background: linear-gradient(135deg, #f8fbff, #e3f2fd);
      border-radius: 12px;
      color: var(--p);
    }
    
    .copyright-footer {
      text-align: center;
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #ddd;
      font-size: 14px;
      color: #666;
    }
    
    @media print {
      @page { margin: 1cm; }
      body * { visibility: hidden !important; }
      #invoice, #invoice * { visibility: visible !important; }
      #invoice {
        position: absolute !important;
        left: 0 !important;
        top: 0 !important;
        width: 100% !important;
      }
      .invoice-table, .invoice-table th, .invoice-table td {
        border: 1px solid black !important;
      }
      .invoice-table th {
        background: #1e3c72 !important;
        color: white !important;
      }
      .copyright-footer {
        color: #000 !important;
        font-size: 12px !important;
      }
    }
    
    .debug-info {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      font-size: 14px;
    }
    
    .debug-success {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    
    .debug-error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø³Ù„Ø© - Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø²ÙŠØ§Ø¯Ø© ÙˆØ§Ù„Ù†Ù‚ØµØ§Ù† */
    .quantity-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    
    .quantity-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--p);
      color: white;
      border: none;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    
    .quantity-btn:hover {
      background: var(--s);
      transform: scale(1.1);
    }
    
    .quantity-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .quantity-display {
      font-size: 18px;
      font-weight: bold;
      min-width: 40px;
      text-align: center;
      padding: 8px;
      background: #f0f0f0;
      border-radius: 8px;
    }
  </style>
</head>
<body>

<button id="menuBtn" onclick="document.querySelector('.sidebar').classList.toggle('active')">
  <i class="fas fa-bars"></i>
</button>

<div class="sidebar">
  <h2>Ashry Natural</h2>
  <a onclick="window.showPage('dashboard')" class="active">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
  <a onclick="window.showPage('add-order')">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</a>
  <a onclick="window.showPage('orders')">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</a>
  <a onclick="window.showPage('products')">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
  <a onclick="window.logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
</div>

<div class="main">

  <div id="invoice">
    <div class="invoice-header">
      <h1>Ashry Natural</h1>
      <p>ÙØ§ØªÙˆØ±Ø© Ø±Ø³Ù…ÙŠØ©</p>
    </div>
    <div class="invoice-details">
      <div><strong>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> <span id="inv_name"></span></div>
      <div><strong>Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨:</strong> <span id="inv_phone"></span></div>
      <div><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> <span id="inv_addr"></span></div>
      <div><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</strong> <span id="inv_date"></span></div>
    </div>
    <table class="invoice-table">
      <thead><tr><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead>
      <tbody id="inv_items"></tbody>
    </table>
    <div class="invoice-total">
      Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: <span id="inv_total">0</span> Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ
    </div>
    <div style="text-align:center;margin-top:50px;font-size:22px;color:#27ae60">
      Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒÙ… Ø¨Ù†Ø§<br><strong>Ashry Natural - ØµØ­ØªÙƒ ØªÙ‡Ù…Ù†Ø§</strong>
    </div>
    <!-- Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
    <div class="copyright-footer">
      ØªÙ… ØªØ·ÙˆÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ ØµÙ„Ø§Ø­ Ø§Ù„Ø²Ù‡ÙŠØ±ÙŠ<br>
      Ù„Ù„ØªÙˆØ§ØµÙ„: 01029149379
    </div>
  </div>

  <div id="login" class="card" style="max-width:420px;margin:100px auto;text-align:center">
    <h2 style="color:var(--p);margin-bottom:30px">Ashry Natural</h2>
    <form id="loginForm">
      <input type="email" id="email" placeholder="Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„" required>
      <input type="password" id="pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
      <button type="submit">Ø¯Ø®ÙˆÙ„</button>
    </form>
  </div>

  <div id="dashboard" class="card" style="display:none">
    <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
    <p style="font-size:22px;color:var(--p);margin:20px 0" id="currentTime"></p>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:25px">
      <div class="stat" style="background:linear-gradient(135deg,var(--p),var(--s));color:#fff;padding:30px;border-radius:16px;text-align:center"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3><h2 id="totalOrders">0</h2></div>
      <div class="stat" style="background:linear-gradient(135deg,#8e44ad,#9b59b6);color:#fff;padding:30px;border-radius:16px;text-align:center"><h3>Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3><h2 id="todayOrders">0</h2></div>
      <div class="stat" style="background:linear-gradient(135deg,var(--g),#2ecc71);color:#fff;padding:30px;border-radius:16px;text-align:center"><h3>ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</h3><h2 id="completedOrders">0</h2></div>
      <div class="stat" style="background:linear-gradient(135deg,var(--o),#e67e22);color:#fff;padding:30px;border-radius:16px;text-align:center"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3><h2 id="totalSales">0 Ø¬Ù†ÙŠÙ‡</h2></div>
    </div>
    <!-- Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <div class="copyright-footer">
      ØªÙ… ØªØ·ÙˆÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ ØµÙ„Ø§Ø­ Ø§Ù„Ø²Ù‡ÙŠØ±ÙŠ - Ù„Ù„ØªÙˆØ§ØµÙ„: 01029149379
    </div>
  </div>

  <div id="add-order" class="card" style="display:none">
    <h2>Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
    <form id="customerForm">
      <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" id="cname" required>
      <input type="tel" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ù…Ø«Ù„Ø§Ù‹: 01029149379)" id="cphone" required>
      <input type="text" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙƒØ§Ù…Ù„" id="caddr" required>
      <select id="status">
        <option value="Ø¬Ø¯ÙŠØ¯">Ø¬Ø¯ÙŠØ¯</option>
        <option value="ØªØ­Øª Ø§Ù„ØªØ¬Ù‡ÙŠØ²">ØªØ­Øª Ø§Ù„ØªØ¬Ù‡ÙŠØ²</option>
        <option value="ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„">ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</option>
      </select>
    </form>
    <div class="discount-toggle">
      <label class="switch">
        <input type="checkbox" id="applyDiscount">
        <span class="slider"></span>
      </label>
      <span>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®ØµÙ… Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨</span>
    </div>
    <hr style="margin:30px 0">
    
    <!-- Ù‚Ø³Ù… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ - Ù…Ø­Ø³Ù† Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø© -->
    <div class="barcode-section">
      <div class="barcode-toggle" id="barcodeToggle">
        <i class="fas fa-barcode"></i>
        <span style="font-weight:bold">Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</span>
        <i class="fas fa-chevron-down" style="margin-right:auto"></i>
      </div>
      
      <div id="barcodeContent" style="display:none">
        <div class="barcode-container">
          <video id="barcode-scanner" class="barcode-scanner"></video>
          <div class="scan-area" id="scanArea">
            <div class="scan-area-line"></div>
          </div>
          <div class="scan-instructions" id="scanInstructions">
            <i class="fas fa-info-circle"></i> Ù‚Ø±Ø¨ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
          </div>
          <div class="zoom-indicator" id="zoomIndicator">
            <i class="fas fa-search"></i> Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ©: 15-20 Ø³Ù…
          </div>
          <div class="barcode-overlay" id="barcodeOverlay">
            <div style="text-align:center">
              <i class="fas fa-camera" style="font-size:48px;margin-bottom:15px;display:block"></i>
              Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...
              <div style="margin-top:15px;font-size:14px;color:#ddd">
                Ø¶Ø¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„ Ù„ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
              </div>
            </div>
          </div>
        </div>
        
        <div class="barcode-controls">
          <button id="flashToggle" class="orange">
            <i class="fas fa-lightbulb"></i> ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ„Ø§Ø´
          </button>
          <button id="focusCamera" class="orange">
            <i class="fas fa-crosshairs"></i> Ø¶Ø¨Ø· Ø§Ù„ØªØ±ÙƒÙŠØ²
          </button>
        </div>
        
        <div style="background:#f0f8ff;padding:15px;border-radius:12px;margin:15px 0;border-right:4px solid #1e3c72">
          <h4 style="color:#1e3c72;margin-bottom:10px"><i class="fas fa-lightbulb"></i> Ù†ØµØ§Ø¦Ø­ Ù„Ù„Ù…Ø³Ø­ Ø§Ù„Ø¯Ù‚ÙŠÙ‚:</h4>
          <ul style="color:#555;margin:0;padding-right:20px">
            <li>ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§Ø¡Ø© Ø¬ÙŠØ¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</li>
            <li>Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ù…Ø³Ø§ÙØ© 15-20 Ø³Ù… Ø¨ÙŠÙ† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</li>
            <li>Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…ÙˆØ§Ø²ÙŠØ§Ù‹ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§</li>
            <li>ØªØ¬Ù†Ø¨ Ø§Ù„Ø¸Ù„Ø§Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</li>
            <li>Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "Ø¶Ø¨Ø· Ø§Ù„ØªØ±ÙƒÙŠØ²" Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙˆØ±Ø© ØºÙŠØ± ÙˆØ§Ø¶Ø­Ø©</li>
            <li>Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ„Ø§Ø´" ÙÙŠ Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ù…Ø¸Ù„Ù…Ø©</li>
          </ul>
        </div>
        
        <div id="barcodeResult" class="barcode-result"></div>
        
        <div style="text-align:center;margin-top:15px;color:#666;font-size:14px">
          <i class="fas fa-info-circle"></i>
          Ù‚Ù… Ø¨ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙˆØ³ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        </div>
      </div>
    </div>
    
    <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª</h3>
    <div style="display:grid;grid-template-columns:1fr 120px auto;gap:15px;align-items:end">
      <div class="searchable-select">
        <input type="text" id="prodSearch" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø£Ùˆ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯..." autocomplete="off">
        <i class="fas fa-search"></i>
        <select id="prodSelect" size="8" style="display:none;position:absolute;top:100%;left:0;right:0;z-index:99;background:#fff;border:1px solid #ddd;border-radius:12px;max-height:300px;overflow-y:auto"></select>
      </div>
      <input type="number" id="qtyInput" value="1" min="1">
      <button type="button" id="addToCartBtn" class="success">Ø¥Ø¶Ø§ÙØ©</button>
    </div>
    <div id="cartItems" style="margin:20px 0"></div>
    <div class="cart-total" id="cartTotal">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0 Ø¬Ù†ÙŠÙ‡</div>
    <button id="saveOrderBtn" style="margin-top:20px;padding:18px;font-size:18px">Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨</button>
    <div id="orderLoading" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„...</div>
  </div>

  <div id="edit-order" class="card" style="display:none">
    <h2>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨</h2>
    <form id="editCustomerForm">
      <input type="hidden" id="editOrderId">
      <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" id="editCname" required>
      <input type="tel" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ù…Ø«Ù„Ø§Ù‹: 01029149379)" id="editCphone" required>
      <input type="text" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙƒØ§Ù…Ù„" id="editCaddr" required>
      <select id="editStatus">
        <option value="Ø¬Ø¯ÙŠØ¯">Ø¬Ø¯ÙŠØ¯</option>
        <option value="ØªØ­Øª Ø§Ù„ØªØ¬Ù‡ÙŠØ²">ØªØ­Øª Ø§Ù„ØªØ¬Ù‡ÙŠØ²</option>
        <option value="ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„">ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„</option>
      </select>
    </form>
    <div class="discount-toggle">
      <label class="switch">
        <input type="checkbox" id="editApplyDiscount">
        <span class="slider"></span>
      </label>
      <span>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®ØµÙ… Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨</span>
    </div>
    <hr style="margin:30px 0">
    <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª</h3>
    <div style="display:grid;grid-template-columns:1fr 120px auto;gap:15px;align-items:end">
      <div class="searchable-select">
        <input type="text" id="editProdSearch" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬..." autocomplete="off">
        <i class="fas fa-search"></i>
        <select id="editProdSelect" size="8" style="display:none;position:absolute;top:100%;left:0;right:0;z-index:99;background:#fff;border:1px solid #ddd;border-radius:12px;max-height:300px;overflow-y:auto"></select>
      </div>
      <input type="number" id="editQtyInput" value="1" min="1">
      <button type="button" id="addToEditCartBtn" class="success">Ø¥Ø¶Ø§ÙØ©</button>
    </div>
    <div id="editCartItems" style="margin:20px 0"></div>
    <div class="cart-total" id="editCartTotal">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0 Ø¬Ù†ÙŠÙ‡</div>
    <button id="updateOrderBtn" style="margin-top:20px;padding:18px;font-size:18px">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨</button>
    <div id="editOrderLoading" class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨...</div>
  </div>

  <div id="orders" class="card" style="display:none">
    <h2>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
    <div style="margin:20px 0">
      <button class="success export-btn" id="exportOrdersBtn">ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Ø¥ÙƒØ³ÙŠÙ„</button>
      <button class="danger export-btn" id="deleteAllOrdersBtn">Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
    </div>
    <input type="text" id="searchOrders" placeholder="Ø¨Ø­Ø«...">
    <table>
      <thead><tr>
        <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†</th><th>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr></thead>
      <tbody id="ordersList"></tbody>
    </table>
  </div>

  <div id="products" class="card" style="display:none">
    <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
    
    <!-- Ù‚Ø³Ù… ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ -->
    <div class="debug-info" id="debugInfo" style="display:none">
      <h4><i class="fas fa-bug"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ´Ø®ÙŠØµ</h4>
      <div id="debugContent">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    </div>
    
    <div style="margin:20px 0; text-align:center;">
      <button class="success export-btn" id="exportProductsBtn">ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Ø¥ÙƒØ³ÙŠÙ„</button>
      <button class="danger export-btn" id="deleteAllProductsBtn">Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
      <button class="orange export-btn" id="importExcelBtn">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ø¥ÙƒØ³Ù„</button>
      <input type="file" id="importExcel" accept=".xlsx,.xls" style="display:none;">
      <div style="margin-top:12px; color:#555; font-size:14px;">
        Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: <strong>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ | Ø§Ù„ÙƒÙ…ÙŠØ© | Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹ | Ø§Ù„Ø®ØµÙ… % | Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) | Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</strong>
      </div>
    </div>
    
    <input type="text" id="searchProducts" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬...">
    
    <!-- Ù‚Ø³Ù… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
    <div class="barcode-section">
      <div class="barcode-toggle" id="productBarcodeToggle">
        <i class="fas fa-barcode"></i>
        <span style="font-weight:bold">Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</span>
        <i class="fas fa-chevron-down" style="margin-right:auto"></i>
      </div>
      
      <div id="productBarcodeContent" style="display:none">
        <div class="barcode-container">
          <video id="product-barcode-scanner" class="barcode-scanner"></video>
          <div class="scan-area" id="productScanArea">
            <div class="scan-area-line"></div>
          </div>
          <div class="scan-instructions" id="productScanInstructions">
            <i class="fas fa-info-circle"></i> Ù‚Ø±Ø¨ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
          </div>
          <div class="zoom-indicator" id="productZoomIndicator">
            <i class="fas fa-search"></i> Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ©: 15-20 Ø³Ù…
          </div>
          <div class="barcode-overlay" id="productBarcodeOverlay">
            <div style="text-align:center">
              <i class="fas fa-camera" style="font-size:48px;margin-bottom:15px;display:block"></i>
              Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...
              <div style="margin-top:15px;font-size:14px;color:#ddd">
                Ø¶Ø¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„ Ù„ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
              </div>
            </div>
          </div>
        </div>
        
        <div class="barcode-controls">
          <button id="productFlashToggle" class="orange">
            <i class="fas fa-lightbulb"></i> ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ„Ø§Ø´
          </button>
          <button id="focusProductCamera" class="orange">
            <i class="fas fa-crosshairs"></i> Ø¶Ø¨Ø· Ø§Ù„ØªØ±ÙƒÙŠØ²
          </button>
        </div>
        
        <div class="barcode-input-group">
          <input type="text" id="scannedBarcode" placeholder="Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹..." readonly>
          <button type="button" id="applyBarcode" class="success" disabled>
            <i class="fas fa-check"></i> ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
          </button>
        </div>
        
        <div id="productBarcodeResult" class="barcode-result"></div>
        
        <div style="text-align:center;margin-top:15px;color:#666;font-size:14px">
          <i class="fas fa-info-circle"></i>
          Ù‚Ù… Ø¨Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯" Ù„Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ù…Ù†ØªØ¬
        </div>
      </div>
    </div>
    
    <form id="productForm" style="background:#f9f9f9;padding:25px;border-radius:16px;margin:25px 0">
      <input type="hidden" id="editProductId">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px">
        <input placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" id="pname" required>
        <input type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" id="pstock" required>
        <input type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹" id="psell" required>
        <input type="number" placeholder="Ø§Ù„Ø®ØµÙ… %" id="pdiscount" min="0" max="100" value="0">
        <div class="barcode-input-group">
          <input placeholder="ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯" id="pbarcode">
          <button type="button" id="scanBarcodeForProduct" class="orange">
            <i class="fas fa-camera"></i> Ù…Ø³Ø­
          </button>
        </div>
        <input type="file" id="pimage" accept="image/*">
        <div id="imagePreview"></div>
      </div>
      <button type="submit" id="productSubmitBtn">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</button>
      <div id="productLoading" class="loading">Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬...</div>
    </form>
    <table>
      <thead><tr>
        <th>ØµÙˆØ±Ø©</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„Ù…ØªÙˆÙØ±</th><th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th><th>Ø§Ù„Ø®ØµÙ… %</th><th>Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…</th><th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr></thead>
      <tbody id="productsList"></tbody>
    </table>
    <!-- Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ© ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
    <div class="copyright-footer">
      ØªÙ… ØªØ·ÙˆÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø­Ù…Ø¯ ØµÙ„Ø§Ø­ Ø§Ù„Ø²Ù‡ÙŠØ±ÙŠ - Ù„Ù„ØªÙˆØ§ØµÙ„: 01029149379
    </div>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, serverTimestamp, increment, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAuRBWr54OUPpH63rYX2GuX5UGMippYSkQ",
    authDomain: "ashrynutral.firebaseapp.com",
    projectId: "ashrynutral",
    storageBucket: "ashrynutral.appspot.com",
    messagingSenderId: "272736958880",
    appId: "1:272736958880:web:5d565a91be484a9cbf4cc5"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const IMGBB_API_KEY = "6e0b6ad4c71f839987c098fe183beca5";

  let products = [], orders = [], cart = [], editCart = [];
  let currentStream = null;
  let productStream = null;
  let currentFacingMode = 'environment';
  let productFacingMode = 'environment';
  let scannedBarcodeValue = '';
  let isScanning = false;
  let quaggaInitialized = false;
  let quaggaProductInitialized = false;
  let connectionTestInterval = null;
  let flashEnabled = false;
  let productFlashEnabled = false;
  let lastScannedCode = ''; // Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù…ØªÙƒØ±Ø± Ù„Ù†ÙØ³ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
  let scanCooldown = false; // Ù„Ù…Ù†Ø¹ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù…ØªÙƒØ±Ø± Ø§Ù„Ø³Ø±ÙŠØ¹

  // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
  function createOrderStatusMessage(order, newStatus, oldStatus) {
    const customerName = order.customerName;
    const orderItems = order.items.map(i => `â€¢ ${i.name} Ã— ${i.qty}`).join('\n');
    const totalPrice = order.totalPrice;
    
    let statusMessage = '';
    
    if (newStatus === 'ØªØ­Øª Ø§Ù„ØªØ¬Ù‡ÙŠØ²' && oldStatus === 'Ø¬Ø¯ÙŠØ¯') {
      statusMessage = `*ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ - Ashry Natural*

Ù…Ø±Ø­Ø¨Ø§Ù‹ ${customerName} ğŸ‘‹

Ù†ÙˆØ¯ Ø¥Ø¹Ù„Ø§Ù…Ùƒ Ø£Ù† Ø·Ù„Ø¨Ùƒ Ù‚Ø¯ ØªÙ… Ù†Ù‚Ù„Ù‡ Ø¥Ù„Ù‰ Ù…Ø±Ø­Ù„Ø© *"ØªØ­Øª Ø§Ù„ØªØ¬Ù‡ÙŠØ²"* âœ…

*ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:*
${orderItems}

*Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${totalPrice} Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ*

Ù†Ù‚ÙˆÙ… Ø§Ù„Ø¢Ù† Ø¨ØªØ¬Ù‡ÙŠØ² Ø·Ù„Ø¨Ùƒ Ø¨Ø¹Ù†Ø§ÙŠØ© ÙˆØ³ÙŠØªÙ… Ø´Ø­Ù†Ù‡ Ø¥Ù„ÙŠÙƒ ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª Ù…Ù…ÙƒÙ†.

Ù†Ø´ÙƒØ±Ùƒ Ø¹Ù„Ù‰ Ø«Ù‚ØªÙƒ Ø¨Ù†Ø§ ğŸŒŸ
*Ashry Natural - ØµØ­ØªÙƒ ØªÙ‡Ù…Ù†Ø§*`;
    }
    else if (newStatus === 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„' && oldStatus !== 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„') {
      statusMessage = `*ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ØªÙ… ØªÙˆØµÙŠÙ„ Ø·Ù„Ø¨Ùƒ - Ashry Natural*

Ø£Ù‡Ù„Ø§Ù‹ ${customerName} ğŸ‰

ÙŠØ³Ø¹Ø¯Ù†Ø§ Ø¥Ø¹Ù„Ø§Ù…Ùƒ Ø£Ù†Ù‡ ØªÙ… ØªÙˆØµÙŠÙ„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­ âœ…

*ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨:*
${orderItems}

*Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${totalPrice} Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ*

Ù†Ø´ÙƒØ±Ùƒ Ø¹Ù„Ù‰ Ø«Ù‚ØªÙƒ Ø¨Ù†Ø§ ÙˆÙ†ØªØ´Ø±Ù Ø¨Ø®Ø¯Ù…ØªÙƒ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª.

Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø± Ø£Ùˆ ÙˆØ§Ø¬Ù‡Øª Ø£ÙŠ Ù…Ø´ÙƒÙ„Ø©ØŒ Ù„Ø§ ØªØªØ±Ø¯Ø¯ ÙÙŠ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙØ±ÙŠÙ‚ Ø§Ù„Ø¯Ø¹Ù….

Ù…Ø¹ ÙØ§Ø¦Ù‚ Ø§Ù„ØªØ­ÙŠØ© ğŸŒ¹
*Ashry Natural - ØµØ­ØªÙƒ ØªÙ‡Ù…Ù†Ø§*`;
    }
    
    return statusMessage;
  }

  // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ - Ù…Ø­Ø³Ù†Ø©
  async function sendOrderStatusUpdate(orderId, newStatus, oldStatus) {
    try {
      const order = orders.find(o => o.id === orderId);
      if (!order) {
        console.error('Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯:', orderId);
        return false;
      }
      
      const message = createOrderStatusMessage(order, newStatus, oldStatus);
      if (!message) {
        console.log('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ù„Ø© Ù…Ø®ØµØµØ© Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ­Ø¯ÙŠØ«');
        return true;
      }
      
      const phone = order.customerPhone.replace('+2', '');
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/2${phone}?text=${encodedMessage}`;
      
      // Ù…Ø­Ø§ÙˆÙ„Ø© ÙØªØ­ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
      const waWindow = window.open(whatsappUrl, '_blank');
      
      // Ø¥Ø°Ø§ ÙØ´Ù„ ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©ØŒ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø¨Ø¯ÙŠÙ„Ø©
      if (!waWindow || waWindow.closed || typeof waWindow.closed === 'undefined') {
        setTimeout(() => {
          if (confirm(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ "${newStatus}"\n\nØ§Ø¶ØºØ· Ù…ÙˆØ§ÙÙ‚ Ù„ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„ØŒ Ø£Ùˆ cancel Ù„Ù„Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹`)) {
            window.open(whatsappUrl, '_blank');
          } else {
            // Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø­Ø§ÙØ¸Ø©
            navigator.clipboard.writeText(message).then(() => {
              alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø­Ø§ÙØ¸Ø©!\nÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨ ÙŠØ¯ÙˆÙŠØ§Ù‹\n\n" + message);
            }).catch(() => {
              alert("Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„:\n\n" + message);
            });
          }
        }, 500);
      } else {
        console.log('ØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø¥Ø±Ø³Ø§Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨');
      }
      
      return true;
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨:', error);
      return false;
    }
  }

  // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¯ÙˆØ§Ù„ ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ
  window.renderCart = function() {
    const useDiscount = document.getElementById('applyDiscount').checked;
    let total = 0;
    let html = '';
    
    if (cart.length === 0) {
      html = '<p style="text-align:center;color:#999;margin:50px 0;font-size:18px;">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©ØŒ Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª</p>';
    } else {
      cart.forEach((item, index) => {
        const p = products.find(x => x.id === item.id);
        if (!p) return;
        
        let price;
        if (useDiscount) {
          price = p.sellPrice * (1 - (p.discount || 0)/100);
        } else {
          price = item.originalPrice || p.sellPrice;
        }
        
        const itemTotal = price * item.qty;
        total += itemTotal;
        
        html += `
          <div class="cart-item" style="position:relative;padding-left:60px;padding-right:15px;min-height:90px;">
            <button onclick="window.removeFromCart(${index})"
                    style="position:absolute;left:10px;top:50%;transform:translateY(-50%);
                           background:#e74c3c;color:white;width:40px;height:40px;
                           border:none;border-radius:50%;cursor:pointer;font-size:16px;
                           box-shadow:0 2px 10px rgba(231,76,60,0.3);z-index:10;">
              <i class="fas fa-trash"></i>
            </button>
            ${item.imageUrl ?
              `<img src="${item.imageUrl}" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);width:70px;height:70px;object-fit:cover;border-radius:8px;">`
              : '<div style="position:absolute;right:10px;top:50%;transform:translateY(-50%);width:70px;height:70px;background:#eee;border-radius:8px;"></div>'}
            <div style="padding:15px 80px 15px 10px;">
              <div style="font-weight:bold;font-size:18px;margin-bottom:8px;">${item.name}</div>
              <div class="quantity-controls">
                <button class="quantity-btn" onclick="window.decreaseQuantity(${index})" ${item.qty <= 1 ? 'disabled' : ''}>
                  <i class="fas fa-minus"></i>
                </button>
                <div class="quantity-display">${item.qty}</div>
                <button class="quantity-btn" onclick="window.increaseQuantity(${index})">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
              <div style="color:#666;margin-bottom:4px;font-size:14px;">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©: ${price.toFixed(0)} Ø¬</div>
              ${useDiscount && p.discount > 0 ? `<div style="color:#e67e22;font-weight:bold;font-size:14px;">ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø®ØµÙ… ${p.discount}%</div>` : ''}
              <div style="font-size:20px;color:#1e3c72;margin-top:10px;font-weight:bold;">
                ${itemTotal.toFixed(0)} Ø¬Ù†ÙŠÙ‡
              </div>
            </div>
          </div>`;
      });
    }
    
    document.getElementById('cartItems').innerHTML = html;
    document.getElementById('cartTotal').innerHTML = `
      <div style="background:linear-gradient(135deg,#1e3c72,#2a5298);color:white;padding:25px;border-radius:16px;text-align:center;font-size:28px;font-weight:900;box-shadow:0 8px 25px rgba(30,60,114,0.3);margin:20px 0;">
        Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toFixed(0)} Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ
      </div>`;
  };

  window.renderEditCart = function() {
    const useDiscount = document.getElementById('editApplyDiscount').checked;
    let total = 0;
    let html = '';
    
    if (editCart.length === 0) {
      html = '<p style="text-align:center;color:#999;margin:50px 0;font-size:18px;">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©ØŒ Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª</p>';
    } else {
      editCart.forEach((item, index) => {
        const p = products.find(x => x.id === item.id);
        if (!p) return;
        
        let price;
        if (useDiscount) {
          price = p.sellPrice * (1 - (p.discount || 0)/100);
        } else {
          price = item.originalPrice || p.sellPrice;
        }
        
        const itemTotal = price * item.qty;
        total += itemTotal;
        
        html += `
          <div class="cart-item" style="position:relative;padding-left:60px;padding-right:15px;min-height:90px;">
            <button onclick="window.removeFromEditCart(${index})"
                    style="position:absolute;left:10px;top:50%;transform:translateY(-50%);
                           background:#e74c3c;color:white;width:40px;height:40px;
                           border:none;border-radius:50%;cursor:pointer;font-size:16px;
                           box-shadow:0 2px 10px rgba(231,76,60,0.3);z-index:10;">
              <i class="fas fa-trash"></i>
            </button>
            ${item.imageUrl ?
              `<img src="${item.imageUrl}" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);width:70px;height:70px;object-fit:cover;border-radius:8px;">`
              : '<div style="position:absolute;right:10px;top:50%;transform:translateY(-50%);width:70px;height:70px;background:#eee;border-radius:8px;"></div>'}
            <div style="padding:15px 80px 15px 10px;">
              <div style="font-weight:bold;font-size:18px;margin-bottom:8px;">${item.name}</div>
              <div class="quantity-controls">
                <button class="quantity-btn" onclick="window.decreaseEditQuantity(${index})" ${item.qty <= 1 ? 'disabled' : ''}>
                  <i class="fas fa-minus"></i>
                </button>
                <div class="quantity-display">${item.qty}</div>
                <button class="quantity-btn" onclick="window.increaseEditQuantity(${index})">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
              <div style="color:#666;margin-bottom:4px;font-size:14px;">Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©: ${price.toFixed(0)} Ø¬</div>
              ${useDiscount && p.discount > 0 ? `<div style="color:#e67e22;font-weight:bold;font-size:14px;">ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø®ØµÙ… ${p.discount}%</div>` : ''}
              <div style="font-size:20px;color:#1e3c72;margin-top:10px;font-weight:bold;">
                ${itemTotal.toFixed(0)} Ø¬Ù†ÙŠÙ‡
              </div>
            </div>
          </div>`;
      });
    }
    
    document.getElementById('editCartItems').innerHTML = html;
    document.getElementById('editCartTotal').innerHTML = `
      <div style="background:linear-gradient(135deg,#1e3c72,#2a5298);color:white;padding:25px;border-radius:16px;text-align:center;font-size:28px;font-weight:900;box-shadow:0 8px 25px rgba(30,60,114,0.3);margin:20px 0;">
        Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toFixed(0)} Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ
      </div>`;
  };

  // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙƒÙ…ÙŠØ© Ù„Ù„Ø³Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  window.increaseQuantity = function(index) {
    if (index >= 0 && index < cart.length) {
      cart[index].qty += 1;
      renderCart();
    }
  };

  window.decreaseQuantity = function(index) {
    if (index >= 0 && index < cart.length && cart[index].qty > 1) {
      cart[index].qty -= 1;
      renderCart();
    }
  };

  // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙƒÙ…ÙŠØ© Ù„Ø³Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
  window.increaseEditQuantity = function(index) {
    if (index >= 0 && index < editCart.length) {
      editCart[index].qty += 1;
      renderEditCart();
    }
  };

  window.decreaseEditQuantity = function(index) {
    if (index >= 0 && index < editCart.length && editCart[index].qty > 1) {
      editCart[index].qty -= 1;
      renderEditCart();
    }
  };

  // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ù„Ø·Ù„Ø¨Ø§Øª - Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø© Ø¨Ø¯ÙˆÙ† ØªÙˆÙ‚Ù
  window.startBarcodeScanner = async function() {
    const video = document.getElementById('barcode-scanner');
    const overlay = document.getElementById('barcodeOverlay');
    const scanArea = document.getElementById('scanArea');
    
    try {
      overlay.innerHTML = '<div style="text-align:center"><i class="fas fa-spinner fa-spin" style="font-size:48px;margin-bottom:15px;display:block"></i> Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...</div>';
      
      // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¯Ù‚Ø©
      const constraints = {
        video: { 
          facingMode: currentFacingMode,
          width: { ideal: 1920, min: 1280 },
          height: { ideal: 1080, min: 720 },
          frameRate: { ideal: 30, min: 24 },
          focusMode: 'continuous'
        },
        audio: false
      };
      
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙ„Ø§Ø´ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ù„
      if (flashEnabled) {
        constraints.video.torch = true;
      }
      
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      
      currentStream = stream;
      video.srcObject = stream;
      
      // Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
      const videoTrack = stream.getVideoTracks()[0];
      if (videoTrack && videoTrack.getCapabilities && videoTrack.getCapabilities().focusDistance) {
        try {
          await videoTrack.applyConstraints({
            advanced: [{ focusMode: 'continuous' }]
          });
        } catch (e) {
          console.log('Ø§Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…:', e);
        }
      }
      
      await video.play();
      
      overlay.style.display = 'none';
      isScanning = true;
      
      // Ø¨Ø¯Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³Ø­
      scanArea.classList.add('scanning');
      
      // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Quagga Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‚Ø¯ ØªÙ… ØªÙ‡ÙŠØ¦ØªÙ‡ Ù…Ù† Ù‚Ø¨Ù„
      if (quaggaInitialized) {
        try {
          Quagga.stop();
        } catch (e) {
          console.log('Quagga Ù„Ù… ÙŠÙƒÙ† ÙŠØ¹Ù…Ù„:', e);
        }
      }
      
      // ØªÙ‡ÙŠØ¦Ø© Quagga Ù„Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø­Ø³Ù†Ø©
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: video,
          constraints: {
            width: 1920,
            height: 1080,
            facingMode: currentFacingMode
          },
          area: {
            top: "25%",
            right: "10%",
            left: "10%",
            bottom: "25%"
          }
        },
        locator: {
          patchSize: "x-large",
          halfSample: false
        },
        numOfWorkers: navigator.hardwareConcurrency || 4,
        decoder: {
          readers: [
            "code_128_reader",
            "ean_reader",
            "ean_8_reader",
            "code_39_reader",
            "code_39_vin_reader",
            "codabar_reader",
            "upc_reader",
            "upc_e_reader",
            "i2of5_reader"
          ],
          multiple: false
        },
        locate: true,
        frequency: 10
      }, function(err) {
        if (err) {
          console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Quagga:', err);
          overlay.innerHTML = '<div style="text-align:center"><i class="fas fa-exclamation-triangle" style="font-size:48px;margin-bottom:15px;display:block"></i> Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ</div>';
          overlay.style.display = 'flex';
          scanArea.classList.remove('scanning');
          return;
        }
        
        Quagga.start();
        quaggaInitialized = true;
        console.log('Quagga started successfully with improved settings');
      });
      
      Quagga.onProcessed(function(result) {
        if (!result) return;
        
        // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        const drawingCtx = Quagga.canvas.ctx.overlay;
        const drawingCanvas = Quagga.canvas.dom.overlay;
        
        if (drawingCtx && drawingCanvas) {
          drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
          
          if (result.boxes) {
            drawingCtx.strokeStyle = "#00FF00";
            result.boxes.filter(function(box) {
              return box !== result.box;
            }).forEach(function(box) {
              Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
            });
          }
          
          if (result.box) {
            Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
          }
          
          if (result.codeResult && result.codeResult.code) {
            Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
          }
        }
      });
      
      // Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ø­Ø³Ù†: Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø© Ø¨Ø¯ÙˆÙ† ØªÙˆÙ‚Ù Ù…Ø¹ ÙØªØ±Ø© ØªØ¬Ù…ÙŠØ¯ 1 Ø«Ø§Ù†ÙŠØ©
      Quagga.onDetected(function(result) {
        if (!isScanning || scanCooldown) return;
        
        const code = result.codeResult.code;
        console.log('ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯:', code, 'Ø¨Ø¯Ù‚Ø©:', result.codeResult.format);
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©
        if (!isValidBarcode(code)) {
          console.log('Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­:', code);
          return;
        }
        
        // ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù…ØªÙƒØ±Ø± Ù„Ù†ÙØ³ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
        if (code === lastScannedCode) {
          console.log('ØªÙ… Ù…Ø³Ø­ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡');
          return;
        }
        
        // ØªÙØ¹ÙŠÙ„ ÙØªØ±Ø© Ø§Ù„ØªØ¨Ø±ÙŠØ¯ Ù„Ù…Ù†Ø¹ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù…ØªÙƒØ±Ø± Ø§Ù„Ø³Ø±ÙŠØ¹ - 1 Ø«Ø§Ù†ÙŠØ©
        scanCooldown = true;
        setTimeout(() => {
          scanCooldown = false;
        }, 1000); // ÙØªØ±Ø© ØªØ¬Ù…ÙŠØ¯ 1000 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© (1 Ø«Ø§Ù†ÙŠØ©)
        
        lastScannedCode = code;
        
        // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø®Ø¶Ø± Ù„Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¬Ø§Ø­
        scanArea.classList.remove('scanning');
        scanArea.classList.add('success');
        
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
        const product = findProductByBarcode(code);
        
        if (product) {
          showBarcodeResult(`ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬: ${product.name}`, true);
          
          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©
          setTimeout(() => {
            addProductToCartByBarcode(product.id);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„ Ù„Ù„Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ù„Ù„Ù…Ø³Ø­ Ø§Ù„ØªØ§Ù„ÙŠ
            setTimeout(() => {
              scanArea.classList.remove('success');
              scanArea.classList.add('scanning');
              lastScannedCode = ''; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ù…Ø³Ø­ Ù†ÙØ³ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ ÙØªØ±Ø©
            }, 800);
          }, 300);
        } else {
          showBarcodeResult(`Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: ${code}`, false);
          scanArea.classList.remove('success');
          scanArea.classList.add('error');
          
          // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„ Ù„Ù„Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ù„Ù„Ù…Ø³Ø­ Ø§Ù„ØªØ§Ù„ÙŠ
          setTimeout(() => {
            scanArea.classList.remove('error');
            scanArea.classList.add('scanning');
            lastScannedCode = ''; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ù…Ø³Ø­ Ù†ÙØ³ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨Ø¹Ø¯ ÙØªØ±Ø©
          }, 1500);
        }
      });
      
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:', error);
      overlay.innerHTML = '<div style="text-align:center"><i class="fas fa-exclamation-triangle" style="font-size:48px;margin-bottom:15px;display:block"></i> Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.</div>';
      overlay.style.display = 'flex';
      scanArea.classList.remove('scanning');
    }
  };

  // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
  function isValidBarcode(code) {
    if (!code || code.length < 4) return false;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§
    const validChars = /^[0-9a-zA-Z\-\.\ \$\/\+\%]+$/;
    if (!validChars.test(code)) return false;
    
    return true;
  }

  // Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
  function findProductByBarcode(barcode) {
    // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¯Ù‚ÙŠÙ‚ Ø£ÙˆÙ„Ø§Ù‹
    let product = products.find(p => p.barcode === barcode);
    
    if (!product) {
      // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±ØŒ Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« Ù…Ø¹ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ§Øª ÙˆØ§Ù„Ø£Ø­Ø±Ù Ø§Ù„Ø®Ø§ØµØ©
      const cleanBarcode = barcode.replace(/[\s\-\.]/g, '');
      product = products.find(p => {
        const cleanProductBarcode = p.barcode ? p.barcode.replace(/[\s\-\.]/g, '') : '';
        return cleanProductBarcode === cleanBarcode;
      });
    }
    
    if (!product) {
      // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ø²Ø¦ÙŠ ÙƒØ­Ù„ Ø£Ø®ÙŠØ±
      product = products.find(p => p.barcode && p.barcode.includes(barcode));
    }
    
    return product;
  }

  // Ø¯Ø§Ù„Ø© Ø¶Ø¨Ø· Ø§Ù„ØªØ±ÙƒÙŠØ²
  window.focusCamera = async function() {
    if (!currentStream) return;
    
    const videoTrack = currentStream.getVideoTracks()[0];
    if (videoTrack && videoTrack.getCapabilities && videoTrack.getCapabilities().focusDistance) {
      try {
        await videoTrack.applyConstraints({
          advanced: [{ focusMode: 'manual', focusDistance: 0.1 }]
        });
        
        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©
        setTimeout(async () => {
          try {
            await videoTrack.applyConstraints({
              advanced: [{ focusMode: 'continuous' }]
            });
          } catch (e) {
            console.log('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ');
          }
        }, 1000);
        
        showBarcodeResult('ØªÙ… Ø¶Ø¨Ø· Ø§Ù„ØªØ±ÙƒÙŠØ²', true);
      } catch (e) {
        showBarcodeResult('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¶Ø¨Ø· Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²', false);
      }
    } else {
      showBarcodeResult('Ø§Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„ÙŠØ¯ÙˆÙŠ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²', false);
    }
  };

  // Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙ„Ø§Ø´ - Ù…Ø­Ø³Ù†Ø© Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙ„Ø§Ø´ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  window.toggleFlash = async function() {
    if (!currentStream) return;
    
    const videoTrack = currentStream.getVideoTracks()[0];
    if (videoTrack && videoTrack.getCapabilities && videoTrack.getCapabilities().torch) {
      try {
        flashEnabled = !flashEnabled;
        await videoTrack.applyConstraints({
          advanced: [{ torch: flashEnabled }]
        });
        
        const flashBtn = document.getElementById('flashToggle');
        if (flashEnabled) {
          flashBtn.innerHTML = '<i class="fas fa-lightbulb"></i> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙ„Ø§Ø´';
          flashBtn.style.background = '#f39c12';
          showBarcodeResult('ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ„Ø§Ø´', true);
        } else {
          flashBtn.innerHTML = '<i class="fas fa-lightbulb"></i> ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ„Ø§Ø´';
          flashBtn.style.background = '';
          showBarcodeResult('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙ„Ø§Ø´', true);
        }
      } catch (e) {
        showBarcodeResult('Ø§Ù„ÙÙ„Ø§Ø´ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²', false);
      }
    } else {
      showBarcodeResult('Ø§Ù„ÙÙ„Ø§Ø´ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²', false);
    }
  };

  // Ø¯Ø§Ù„Ø© Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ - Ù…Ø­Ø³Ù†Ø© Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙ„Ø§Ø´ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  window.stopBarcodeScanner = function() {
    const video = document.getElementById('barcode-scanner');
    const overlay = document.getElementById('barcodeOverlay');
    const scanArea = document.getElementById('scanArea');
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙ„Ø§Ø´ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ù„
    if (flashEnabled && currentStream) {
      const videoTrack = currentStream.getVideoTracks()[0];
      if (videoTrack && videoTrack.getCapabilities && videoTrack.getCapabilities().torch) {
        try {
          videoTrack.applyConstraints({
            advanced: [{ torch: false }]
          });
        } catch (e) {
          console.log('Ø®Ø·Ø£ ÙÙŠ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙ„Ø§Ø´:', e);
        }
      }
    }
    
    if (currentStream) {
      currentStream.getTracks().forEach(track => track.stop());
      currentStream = null;
    }
    
    if (video.srcObject) {
      video.srcObject = null;
    }
    
    if (quaggaInitialized) {
      try {
        Quagga.stop();
      } catch (e) {
        console.log('Quagga Ù„Ù… ÙŠÙƒÙ† ÙŠØ¹Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù:', e);
      }
      quaggaInitialized = false;
    }
    
    isScanning = false;
    flashEnabled = false;
    scanCooldown = false;
    lastScannedCode = '';
    
    if (scanArea) {
      scanArea.classList.remove('scanning', 'success', 'error');
    }
    
    if (overlay) {
      overlay.innerHTML = '<div style="text-align:center"><i class="fas fa-camera" style="font-size:48px;margin-bottom:15px;display:block"></i> Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...<div style="margin-top:15px;font-size:14px;color:#ddd">Ø¶Ø¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„ Ù„ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</div></div>';
      overlay.style.display = 'flex';
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„ÙÙ„Ø§Ø´
    const flashBtn = document.getElementById('flashToggle');
    if (flashBtn) {
      flashBtn.innerHTML = '<i class="fas fa-lightbulb"></i> ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ„Ø§Ø´';
      flashBtn.style.background = '';
    }
  };

  // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª - Ù†ÙØ³ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø© ÙˆØ§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
  window.startProductBarcodeScanner = async function() {
    const video = document.getElementById('product-barcode-scanner');
    const overlay = document.getElementById('productBarcodeOverlay');
    const scanArea = document.getElementById('productScanArea');
    const applyBtn = document.getElementById('applyBarcode');
    
    try {
      overlay.innerHTML = '<div style="text-align:center"><i class="fas fa-spinner fa-spin" style="font-size:48px;margin-bottom:15px;display:block"></i> Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...</div>';
      
      const constraints = {
        video: { 
          facingMode: productFacingMode,
          width: { ideal: 1920, min: 1280 },
          height: { ideal: 1080, min: 720 },
          frameRate: { ideal: 30, min: 24 },
          focusMode: 'continuous'
        },
        audio: false
      };
      
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙ„Ø§Ø´ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ù„
      if (productFlashEnabled) {
        constraints.video.torch = true;
      }
      
      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      
      productStream = stream;
      video.srcObject = stream;
      
      await video.play();
      
      overlay.style.display = 'none';
      applyBtn.disabled = true;
      
      // Ø¨Ø¯Ø¡ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø³Ø­
      if (scanArea) scanArea.classList.add('scanning');
      
      // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Quagga Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: video,
          constraints: {
            width: 1920,
            height: 1080,
            facingMode: productFacingMode
          },
          area: {
            top: "25%",
            right: "10%",
            left: "10%",
            bottom: "25%"
          }
        },
        locator: {
          patchSize: "x-large",
          halfSample: false
        },
        numOfWorkers: navigator.hardwareConcurrency || 4,
        decoder: {
          readers: [
            "code_128_reader",
            "ean_reader",
            "ean_8_reader",
            "code_39_reader",
            "code_39_vin_reader",
            "codabar_reader",
            "upc_reader",
            "upc_e_reader",
            "i2of5_reader"
          ],
          multiple: false
        },
        locate: true,
        frequency: 10
      }, function(err) {
        if (err) {
          console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Quagga:', err);
          overlay.innerHTML = '<div style="text-align:center"><i class="fas fa-exclamation-triangle" style="font-size:48px;margin-bottom:15px;display:block"></i> Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ</div>';
          overlay.style.display = 'flex';
          if (scanArea) scanArea.classList.remove('scanning');
          return;
        }
        
        Quagga.start();
        quaggaProductInitialized = true;
        console.log('Quagga for products started successfully with improved settings');
      });
      
      Quagga.onDetected(function(result) {
        if (scanCooldown) return;
        
        const code = result.codeResult.code;
        console.log('ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ù„Ù…Ù†ØªØ¬:', code, 'Ø¨Ø¯Ù‚Ø©:', result.codeResult.format);
        
        if (!isValidBarcode(code)) {
          console.log('Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­:', code);
          return;
        }
        
        // ØªÙØ¹ÙŠÙ„ ÙØªØ±Ø© Ø§Ù„ØªØ¨Ø±ÙŠØ¯ Ù„Ù…Ù†Ø¹ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ù…ØªÙƒØ±Ø± Ø§Ù„Ø³Ø±ÙŠØ¹ - 1 Ø«Ø§Ù†ÙŠØ©
        scanCooldown = true;
        setTimeout(() => {
          scanCooldown = false;
        }, 1000); // ÙØªØ±Ø© ØªØ¬Ù…ÙŠØ¯ 1000 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ© (1 Ø«Ø§Ù†ÙŠØ©)
        
        // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø®Ø¶Ø± Ù„Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¬Ø§Ø­
        if (scanArea) {
          scanArea.classList.remove('scanning');
          scanArea.classList.add('success');
        }
        
        scannedBarcodeValue = code;
        document.getElementById('scannedBarcode').value = code;
        document.getElementById('applyBarcode').disabled = false;
        
        showProductBarcodeResult(`ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: ${code}`, true);
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„ Ù„Ù„Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ù„Ù„Ù…Ø³Ø­ Ø§Ù„ØªØ§Ù„ÙŠ
        setTimeout(() => {
          if (scanArea) {
            scanArea.classList.remove('success');
            scanArea.classList.add('scanning');
          }
        }, 500);
      });
      
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:', error);
      overlay.innerHTML = '<div style="text-align:center"><i class="fas fa-exclamation-triangle" style="font-size:48px;margin-bottom:15px;display:block"></i> Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§.</div>';
      overlay.style.display = 'flex';
      if (scanArea) scanArea.classList.remove('scanning');
    }
  };

  // Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙ„Ø§Ø´ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª - Ù…Ø­Ø³Ù†Ø© Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙ„Ø§Ø´ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  window.toggleProductFlash = async function() {
    if (!productStream) return;
    
    const videoTrack = productStream.getVideoTracks()[0];
    if (videoTrack && videoTrack.getCapabilities && videoTrack.getCapabilities().torch) {
      try {
        productFlashEnabled = !productFlashEnabled;
        await videoTrack.applyConstraints({
          advanced: [{ torch: productFlashEnabled }]
        });
        
        const flashBtn = document.getElementById('productFlashToggle');
        if (productFlashEnabled) {
          flashBtn.innerHTML = '<i class="fas fa-lightbulb"></i> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙ„Ø§Ø´';
          flashBtn.style.background = '#f39c12';
          showProductBarcodeResult('ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ„Ø§Ø´', true);
        } else {
          flashBtn.innerHTML = '<i class="fas fa-lightbulb"></i> ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ„Ø§Ø´';
          flashBtn.style.background = '';
          showProductBarcodeResult('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙ„Ø§Ø´', true);
        }
      } catch (e) {
        showProductBarcodeResult('Ø§Ù„ÙÙ„Ø§Ø´ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²', false);
      }
    } else {
      showProductBarcodeResult('Ø§Ù„ÙÙ„Ø§Ø´ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²', false);
    }
  };

  // Ø¯Ø§Ù„Ø© Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª - Ù…Ø­Ø³Ù†Ø© Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙ„Ø§Ø´ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  window.stopProductBarcodeScanner = function() {
    const video = document.getElementById('product-barcode-scanner');
    const overlay = document.getElementById('productBarcodeOverlay');
    const scanArea = document.getElementById('productScanArea');
    const applyBtn = document.getElementById('applyBarcode');
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙ„Ø§Ø´ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ù„
    if (productFlashEnabled && productStream) {
      const videoTrack = productStream.getVideoTracks()[0];
      if (videoTrack && videoTrack.getCapabilities && videoTrack.getCapabilities().torch) {
        try {
          videoTrack.applyConstraints({
            advanced: [{ torch: false }]
          });
        } catch (e) {
          console.log('Ø®Ø·Ø£ ÙÙŠ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙÙ„Ø§Ø´:', e);
        }
      }
    }
    
    if (productStream) {
      productStream.getTracks().forEach(track => track.stop());
      productStream = null;
    }
    
    if (video.srcObject) {
      video.srcObject = null;
    }
    
    if (quaggaProductInitialized) {
      try {
        Quagga.stop();
      } catch (e) {
        console.log('Quagga Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù… ÙŠÙƒÙ† ÙŠØ¹Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù:', e);
      }
      quaggaProductInitialized = false;
    }
    
    if (scanArea) scanArea.classList.remove('scanning', 'success', 'error');
    
    if (overlay) {
      overlay.innerHTML = '<div style="text-align:center"><i class="fas fa-camera" style="font-size:48px;margin-bottom:15px;display:block"></i> Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...<div style="margin-top:15px;font-size:14px;color:#ddd">Ø¶Ø¹ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø³ØªØ·ÙŠÙ„ Ù„ÙŠØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</div></div>';
      overlay.style.display = 'flex';
    }
    
    if (applyBtn) applyBtn.disabled = true;
    productFlashEnabled = false;
    
    // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„ÙÙ„Ø§Ø´
    const flashBtn = document.getElementById('productFlashToggle');
    if (flashBtn) {
      flashBtn.innerHTML = '<i class="fas fa-lightbulb"></i> ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙ„Ø§Ø´';
      flashBtn.style.background = '';
    }
  };

  window.focusProductCamera = async function() {
    if (!productStream) return;
    
    const videoTrack = productStream.getVideoTracks()[0];
    if (videoTrack && videoTrack.getCapabilities && videoTrack.getCapabilities().focusDistance) {
      try {
        await videoTrack.applyConstraints({
          advanced: [{ focusMode: 'manual', focusDistance: 0.1 }]
        });
        
        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ©
        setTimeout(async () => {
          try {
            await videoTrack.applyConstraints({
              advanced: [{ focusMode: 'continuous' }]
            });
          } catch (e) {
            console.log('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ');
          }
        }, 1000);
        
        showProductBarcodeResult('ØªÙ… Ø¶Ø¨Ø· Ø§Ù„ØªØ±ÙƒÙŠØ²', true);
      } catch (e) {
        showProductBarcodeResult('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¶Ø¨Ø· Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²', false);
      }
    } else {
      showProductBarcodeResult('Ø§Ù„ØªØ±ÙƒÙŠØ² Ø§Ù„ÙŠØ¯ÙˆÙŠ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²', false);
    }
  };

  window.applyScannedBarcode = function() {
    if (scannedBarcodeValue) {
      document.getElementById('pbarcode').value = scannedBarcodeValue;
      showProductBarcodeResult('ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬', true);
      document.getElementById('applyBarcode').disabled = true;
      
      // Ø¥ØºÙ„Ø§Ù‚ Ù‚Ø³Ù… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
      setTimeout(() => {
        document.getElementById('productBarcodeContent').style.display = 'none';
        document.getElementById('productBarcodeToggle').classList.remove('active');
        window.stopProductBarcodeScanner();
      }, 2000);
    }
  };

  window.scanBarcodeForProduct = function() {
    // ÙØªØ­ Ù‚Ø³Ù… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
    document.getElementById('productBarcodeContent').style.display = 'block';
    document.getElementById('productBarcodeToggle').classList.add('active');
    
    // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø³Ø­ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    setTimeout(() => {
      window.startProductBarcodeScanner();
    }, 500);
  };

  function showBarcodeResult(message, isSuccess) {
    const resultDiv = document.getElementById('barcodeResult');
    if (resultDiv) {
      resultDiv.textContent = message;
      resultDiv.className = `barcode-result ${isSuccess ? 'success' : 'error'}`;
      resultDiv.style.display = 'block';
      
      // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
      setTimeout(() => {
        resultDiv.style.display = 'none';
      }, 5000);
    }
  }

  function showProductBarcodeResult(message, isSuccess) {
    const resultDiv = document.getElementById('productBarcodeResult');
    if (resultDiv) {
      resultDiv.textContent = message;
      resultDiv.className = `barcode-result ${isSuccess ? 'success' : 'error'}`;
      resultDiv.style.display = 'block';
      
      // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
      setTimeout(() => {
        resultDiv.style.display = 'none';
      }, 5000);
    }
  }

  function addProductToCartByBarcode(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø³Ù„Ø©
    const existingItemIndex = cart.findIndex(item => item.id === productId);
    if (existingItemIndex > -1) {
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù†Ø²ÙŠØ¯ Ø§Ù„ÙƒÙ…ÙŠØ© ÙÙ‚Ø·
      cart[existingItemIndex].qty += 1;
    } else {
      // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù†Ø¶ÙŠÙÙ‡ Ø¬Ø¯ÙŠØ¯
      cart.push({
        id: product.id, 
        name: product.name, 
        qty: 1, 
        imageUrl: product.imageUrl || '',
        originalPrice: product.sellPrice
      });
    }
    
    renderCart();
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
    showBarcodeResult(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${product.name} Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©`, true);
  }

  window.showPage = function(s) {
    console.log('ğŸ”„ ØªØ­ÙˆÙŠÙ„ Ù„Ù„ØµÙØ­Ø©:', s);
    
    // Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª
    document.querySelectorAll('.card:not(#login), #invoice').forEach(function(el) {
        el.style.display = 'none';
    });
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
    const targetPage = document.getElementById(s);
    if (targetPage) {
        targetPage.style.display = 'block';
        console.log('âœ… ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙØ­Ø©:', s);
    } else {
        console.error('âŒ Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©:', s);
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©
    document.querySelectorAll('.sidebar a').forEach(function(a) {
        a.classList.remove('active');
    });
    
    const activeLink = document.querySelector('[onclick="window.showPage(\'' + s + '\')"]');
    if (activeLink) {
        activeLink.classList.add('active');
    }
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØµÙØ­Ø©
    if (s !== 'add-order') {
        if (window.stopBarcodeScanner) window.stopBarcodeScanner();
    }
    if (s !== 'products') {
        if (window.stopProductBarcodeScanner) window.stopProductBarcodeScanner();
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØµÙØ­Ø©
    if (s === 'orders') {
        if (window.loadOrders) window.loadOrders();
    }
    if (s === 'products') { 
        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø®ÙŠØ± Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ DOM Ø£ÙˆÙ„Ø§Ù‹
        setTimeout(function() {
            console.log('ğŸ“¦ ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...');
            if (window.loadProducts) window.loadProducts(); 
            const searchInput = document.getElementById('searchProducts');
            if (searchInput) {
                searchInput.value = '';
            }
        }, 100);
    }
    if (s === 'add-order') { 
        cart = []; 
        if (window.renderCart) window.renderCart(); 
        const discountCheckbox = document.getElementById('applyDiscount');
        if (discountCheckbox) discountCheckbox.checked = false; 
        if (loadProductsForCart) loadProductsForCart(); 
    }
    if (s === 'dashboard') {
        if (updateDashboard) updateDashboard();
    }
  };

  window.logout = () => {
    if(confirm("ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
      window.stopBarcodeScanner();
      window.stopProductBarcodeScanner();
      if (connectionTestInterval) {
        clearInterval(connectionTestInterval);
        connectionTestInterval = null;
      }
      signOut(auth);
    }
  };

  function hideEverythingExceptLogin() {
    document.querySelectorAll('.card, #invoice, .sidebar, #menuBtn').forEach(el => {
      if (el.id !== 'login') el.style.display = 'none';
    });
    document.getElementById('login').style.display = 'block';
  }

  document.getElementById('loginForm').onsubmit = e => {
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    const pass = document.getElementById('pass').value;

    signInWithEmailAndPassword(auth, email, pass)
      .then(() => {})
      .catch(err => {
        let msg = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„";
        if (err.code === 'auth/user-not-found') msg = "Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
        else if (err.code === 'auth/wrong-password') msg = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙ„Ø·";
        else if (err.code === 'auth/invalid-email') msg = "Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­";
        alert(msg);
      });
  };

  // Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØµØ§Ù„ Firebase ØªÙ„Ù‚Ø§Ø¦ÙŠ
  async function autoTestFirebaseConnection() {
    try {
      const productsRef = collection(db, "products");
      const snapshot = await getDocs(productsRef);
      const productCount = snapshot.size;
      console.log('âœ… Ø§ØªØµØ§Ù„ Firebase ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù†Ø§Ø¬Ø­ØŒ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:', productCount);
      return true;
    } catch (error) {
      console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ù€ Firebase:', error);
      return false;
    }
  }

  // Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„ØªØ´Ø®ÙŠØµ
  window.loadProducts = async function() {
    try {
      console.log('ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Firebase...');
      
      const productsRef = collection(db, "products");
      const snap = await getDocs(productsRef);
      
      products = [];
      snap.forEach(doc => {
        const data = doc.data();
        console.log('ğŸ“¦ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬:', doc.id, data);
        
        const productData = {
          id: doc.id,
          name: data.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…',
          stock: data.stock || 0,
          sellPrice: data.sellPrice || 0,
          discount: data.discount || 0,
          imageUrl: data.imageUrl || '',
          barcode: data.barcode || ''
        };
        
        products.push(productData);
      });
      
      console.log('âœ… Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©:', products.length);
      
      // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„Ù‡Ø§
      window.renderProducts();
      
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:', error);
    }
  };

  // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
  window.renderProducts = function() {
    console.log('ğŸ”„ Ø¨Ø¯Ø¡ renderProducts');
    console.log('ğŸ“¦ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:', products.length);
    
    let productsList = document.getElementById('productsList');
    if (!productsList) {
        console.error('âŒ element productsList Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù€ DOM');
        return;
    }
    
    const searchInput = document.getElementById('searchProducts');
    const term = searchInput ? searchInput.value.toLowerCase() : '';
    
    console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†:', term);
    
    const filtered = products.filter(function(p) {
        if (!p) return false;
        const nameMatch = p.name && p.name.toLowerCase().includes(term);
        const barcodeMatch = p.barcode && p.barcode.toLowerCase().includes(term);
        return nameMatch || barcodeMatch;
    });
    
    console.log('âœ… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©:', filtered.length);
    
    if (filtered.length === 0) {
        productsList.innerHTML = `
          <tr>
            <td colspan="8" style="text-align:center;padding:50px;color:#999">
              <i class="fas fa-box-open" style="font-size:48px;margin-bottom:20px;display:block;color:#ccc;"></i>
              Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª
            </td>
          </tr>
        `;
        return;
    }
    
    let html = '';
    filtered.forEach(function(p) {
        if (!p) return;
        const priceAfter = (p.sellPrice || 0) * (1 - (p.discount || 0)/100);
        html += `
            <tr>
                <td>${p.imageUrl ? '<img src="' + p.imageUrl + '" class="product-img-table" alt="' + p.name + '">' : '<div style="width:60px;height:60px;background:#f0f0f0;border-radius:8px;display:flex;align-items:center;justify-content:center;"><i class="fas fa-image" style="color:#ccc;"></i></div>'}</td>
                <td><strong>${p.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</strong></td>
                <td>${(p.stock || 0) > 0 ? p.stock : '<span style="color:red">Ù†ÙØ¯</span>'}</td>
                <td>${p.sellPrice || 0} Ø¬</td>
                <td><strong style="color:var(--o)">${p.discount || 0}%</strong></td>
                <td style="background:#fff8e1">${priceAfter.toFixed(0)} Ø¬</td>
                <td>${p.barcode || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</td>
                <td class="action-btns">
                    <button class="orange small" onclick="window.editProduct('${p.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button class="danger small" onclick="window.delP('${p.id}')">Ø­Ø°Ù</button>
                </td>
            </tr>
        `;
    });
    
    productsList.innerHTML = html;
    console.log('âœ… ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
  };

  function loadProductsForCart() {
    const input = document.getElementById('prodSearch');
    const select = document.getElementById('prodSelect');
    
    if (!input || !select) {
      console.error('âŒ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
      return;
    }
    
    input.oninput = () => {
      const term = input.value.toLowerCase();
      select.innerHTML = '';
      products.filter(p => p.stock > 0 && (p.name.toLowerCase().includes(term) || (p.barcode && p.barcode.includes(term)))).forEach(p => {
        const barcodeText = p.barcode ? ` - Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: ${p.barcode}` : '';
        const opt = new Option(`${p.name} - ${p.sellPrice} Ø¬ (Ù…ØªÙˆÙØ±: ${p.stock})${barcodeText}`, p.id);
        select.add(opt);
      });
      select.style.display = select.options.length ? 'block' : 'none';
    };
    
    input.onclick = () => input.oninput();
    select.onchange = () => { 
      if (select.selectedOptions.length > 0) {
        input.value = select.selectedOptions[0].text.split(' - ')[0]; 
        select.style.display = 'none'; 
      }
    };
  }

  function loadProductsForEditCart() {
    const input = document.getElementById('editProdSearch');
    const select = document.getElementById('editProdSelect');
    
    if (!input || !select) {
      console.error('âŒ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
      return;
    }
    
    input.oninput = () => {
      const term = input.value.toLowerCase();
      select.innerHTML = '';
      products.filter(p => p.name.toLowerCase().includes(term)).forEach(p => {
        const opt = new Option(`${p.name} - ${p.sellPrice} Ø¬ (Ù…ØªÙˆÙØ±: ${p.stock})`, p.id);
        select.add(opt);
      });
      select.style.display = select.options.length ? 'block' : 'none';
    };
    
    input.onclick = () => input.oninput();
    select.onchange = () => { 
      if (select.selectedOptions.length > 0) {
        input.value = select.selectedOptions[0].text.split(' - ')[0]; 
        select.style.display = 'none'; 
      }
    };
  }

  window.addToCart = () => {
    const select = document.getElementById('prodSelect');
    if(!select.value) return alert("Ø§Ø®ØªØ± Ù…Ù†ØªØ¬");
    const qty = +document.getElementById('qtyInput').value || 1;
    const p = products.find(x => x.id === select.value);
    if(p.stock < qty) return alert("Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©");
    
    const existingItemIndex = cart.findIndex(item => item.id === p.id);
    if (existingItemIndex > -1) {
      cart[existingItemIndex].qty += qty;
    } else {
      cart.push({
        id: p.id, 
        name: p.name, 
        qty: qty, 
        imageUrl: p.imageUrl || '',
        originalPrice: p.sellPrice
      });
    }
    
    renderCart();
    document.getElementById('prodSearch').value = '';
    document.getElementById('qtyInput').value = 1;
    select.style.display = 'none';
  };

  window.addToEditCart = () => {
    const select = document.getElementById('editProdSelect');
    if(!select.value) return alert("Ø§Ø®ØªØ± Ù…Ù†ØªØ¬");
    const qty = +document.getElementById('editQtyInput').value || 1;
    const p = products.find(x => x.id === select.value);
    
    const existingItemIndex = editCart.findIndex(item => item.id === p.id);
    if (existingItemIndex > -1) {
      editCart[existingItemIndex].qty += qty;
    } else {
      editCart.push({
        id: p.id, 
        name: p.name, 
        qty: qty, 
        imageUrl: p.imageUrl || '',
        originalPrice: p.sellPrice
      });
    }
    
    renderEditCart();
    document.getElementById('editProdSearch').value = '';
    document.getElementById('editQtyInput').value = 1;
    select.style.display = 'none';
  };

  window.removeFromCart = function(index) {
    if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø³Ù„Ø©ØŸ")) {
      cart.splice(index, 1);
      renderCart();
    }
  };

  window.removeFromEditCart = function(index) {
    if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø³Ù„Ø©ØŸ")) {
      editCart.splice(index, 1);
      renderEditCart();
    }
  };

  window.saveOrder = async () => {
  if (cart.length === 0) return alert("Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆÙ„Ø§Ù‹");
  
  let phone = document.getElementById('cphone').value.replace(/[^\d]/g, '');
  if (!phone.startsWith('01') || phone.length !== 11) return alert("Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø§Ø²Ù… 11 Ø±Ù‚Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 01");
  
  const customerName = document.getElementById('cname').value.trim();
  const address = document.getElementById('caddr').value.trim();
  const useDiscount = document.getElementById('applyDiscount').checked;
  let totalAfter = 0;
  
  const itemsWithPrice = cart.map(i => {
    const p = products.find(x => x.id === i.id);
    
    let price;
    if (useDiscount) {
      price = p.sellPrice * (1 - (p.discount || 0)/100);
    } else {
      price = i.originalPrice || p.sellPrice;
    }
    
    totalAfter += price * i.qty;
    return {
      ...i,
      price: price
    };
  });
  
  // Ø¨Ù†Ø§Ø¡ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
  const itemsText = itemsWithPrice.map(i => 
    `â€¢ ${i.name} Ã— ${i.qty} = ${(i.price * i.qty).toFixed(0)} Ø¬Ù†ÙŠÙ‡`
  ).join('\n');
  
  const message = `*Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ashry Natural*
  
Ø§Ù„Ø§Ø³Ù…: ${customerName}
Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨: 0${phone}
Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${address}

Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:
${itemsText}

*Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${totalAfter.toFixed(0)} Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ*

Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒ ÙÙŠÙ†Ø§
*Ashry Natural - ØµØ­ØªÙƒ ØªÙ‡Ù…Ù†Ø§*`;
  
  const saveBtn = document.getElementById('saveOrderBtn');
  const loading = document.getElementById('orderLoading');
  saveBtn.disabled = true;
  loading.style.display = 'block';
  saveBtn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„...";
  
  try {
    // Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Firebase
    await addDoc(collection(db, "orders"), {
      customerName,
      customerPhone: '+2' + phone,
      customerAddress: address,
      items: itemsWithPrice,
      totalPrice: totalAfter,
      orderStatus: document.getElementById('status').value,
      timestamp: serverTimestamp(),
      appliedDiscount: useDiscount
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
    for (const i of cart) {
      await updateDoc(doc(db, "products", i.id), { stock: increment(-i.qty) });
    }
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
    const encodedMessage = encodeURIComponent(message);
    const whatsappUrl = `https://wa.me/2${phone}?text=${encodedMessage}`;
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© ÙØªØ­ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
    const waWindow = window.open(whatsappUrl, '_blank');
    
    // Ø¥Ø°Ø§ ÙØ´Ù„ ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©ØŒ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø¨Ø¯ÙŠÙ„Ø©
    if (!waWindow || waWindow.closed || typeof waWindow.closed === 'undefined') {
      setTimeout(() => {
        if (confirm("Ù„Ù… ÙŠØªÙ… ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹\nØ§Ø¶ØºØ· Ù…ÙˆØ§ÙÙ‚ Ù„ÙØªØ­Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§ØŒ Ø£Ùˆ cancel Ù„Ù„Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹")) {
          window.open(whatsappUrl, '_blank');
        } else {
          // Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø­Ø§ÙØ¸Ø©
          navigator.clipboard.writeText(message).then(() => {
            alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø­Ø§ÙØ¸Ø©!\nÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ ÙˆØ§ØªØ³Ø§Ø¨ ÙŠØ¯ÙˆÙŠØ§Ù‹\n\n" + message);
          }).catch(() => {
            alert("Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„:\n\n" + message);
          });
        }
      }, 500);
    }
    
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!");
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
    document.getElementById('customerForm').reset();
    cart = []; 
    renderCart();
    document.getElementById('applyDiscount').checked = false;
    loadOrders(); 
    loadProducts();
    
  } catch (err) {
    console.error(err);
    alert("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨: " + err.message);
  } finally {
    saveBtn.disabled = false;
    loading.style.display = 'none';
    saveBtn.innerText = "Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨";
  }
};

  window.loadOrders = async function() {
    try {
      const snap = await getDocs(query(collection(db,"orders"), orderBy("timestamp","desc")));
      orders = snap.docs.map(d => ({id: d.id, ...d.data()}));
      renderOrders(); 
      updateDashboard();
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª:', error);
    }
  }

  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© renderOrders
  window.renderOrders = function() {
    const ordersList = document.getElementById('ordersList');
    if (!ordersList) return;
    
    const term = (document.getElementById('searchOrders')?.value || '').toLowerCase();
    const filtered = orders.filter(o => 
      o.customerName.toLowerCase().includes(term) || 
      o.customerPhone.includes(term) || 
      o.items.some(i => i.name.toLowerCase().includes(term))
    );
    
    ordersList.innerHTML = filtered.map(o => {
      const items = o.items.map(i => `${i.name}Ã—${i.qty}`).join('ØŒ ');
      const date = o.timestamp?.toDate?.()?.toLocaleString('ar-EG') || '';
      const updated = o.updatedAt ? ` (Ù…Ø­Ø¯Ø«: ${o.updatedAt.toDate().toLocaleString('ar-EG')})` : '';
      
      return `<tr>
        <td>${o.customerName}</td>
        <td><a href="https://wa.me/${o.customerPhone}" target="_blank">${o.customerPhone}</a></td>
        <td>${items}</td>
        <td>${o.totalPrice} Ø¬</td>
        <td><span class="badge ${o.orderStatus==='Ø¬Ø¯ÙŠØ¯'?'new':o.orderStatus==='ØªØ­Øª Ø§Ù„ØªØ¬Ù‡ÙŠØ²'?'processing':'delivered'}">${o.orderStatus}</span></td>
        <td>${date}${updated}</td>
        <td class="action-btns">
          <button class="orange small" onclick="window.editOrder('${o.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="print-btn small" onclick="window.printInvoice('${o.id}')">Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="danger small" onclick="window.delOrder('${o.id}')">Ø­Ø°Ù</button>
        </td>
      </tr>`;
    }).join('') || '<tr><td colspan="7" style="text-align:center;padding:50px;color:#999">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</td></tr>';
  }

  window.editOrder = async (id) => {
    const order = orders.find(o => o.id === id);
    if (!order) return alert("Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
    
    document.getElementById('editOrderId').value = order.id;
    document.getElementById('editCname').value = order.customerName;
    document.getElementById('editCphone').value = order.customerPhone.replace('+2', '');
    document.getElementById('editCaddr').value = order.customerAddress || '';
    document.getElementById('editStatus').value = order.orderStatus;
    
    editCart = order.items.map(item => ({
      id: item.id,
      name: item.name,
      qty: item.qty,
      imageUrl: item.imageUrl || '',
      originalPrice: item.price || products.find(p => p.id === item.id)?.sellPrice || 0
    }));
    
    document.getElementById('editApplyDiscount').checked = order.appliedDiscount || false;
    
    renderEditCart();
    
    document.querySelectorAll('.card').forEach(el => el.style.display = 'none');
    document.getElementById('edit-order').style.display = 'block';
  };

  window.updateOrder = async () => {
    if (editCart.length === 0) return alert("Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Øª Ø£ÙˆÙ„Ø§Ù‹");
    
    const orderId = document.getElementById('editOrderId').value;
    let phone = document.getElementById('editCphone').value.replace(/[^\d]/g, '');
    if (!phone.startsWith('01') || phone.length !== 11) return alert("Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø§Ø²Ù… 11 Ø±Ù‚Ù… ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 01");
    
    const customerName = document.getElementById('editCname').value.trim();
    const address = document.getElementById('editCaddr').value.trim();
    const newStatus = document.getElementById('editStatus').value;
    const useDiscount = document.getElementById('editApplyDiscount').checked;
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„Ø·Ù„Ø¨
    const oldOrder = orders.find(o => o.id === orderId);
    const oldStatus = oldOrder ? oldOrder.orderStatus : 'Ø¬Ø¯ÙŠØ¯';
    
    let totalAfter = 0;
    const itemsWithPrice = editCart.map(i => {
      const p = products.find(x => x.id === i.id);
      let price;
      
      if (useDiscount) {
        price = p.sellPrice * (1 - (p.discount || 0)/100);
      } else {
        price = i.originalPrice || p.sellPrice;
      }
      
      const itemTotal = price * i.qty;
      totalAfter += itemTotal;
      
      return {
        id: i.id,
        name: i.name,
        qty: i.qty,
        imageUrl: i.imageUrl || '',
        price: price
      };
    });
    
    const updateBtn = document.getElementById('updateOrderBtn');
    const loading = document.getElementById('editOrderLoading');
    updateBtn.disabled = true;
    loading.style.display = 'block';
    updateBtn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...";
    
    try {
      console.log("Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨:", orderId);
      
      await updateDoc(doc(db, "orders", orderId), {
        customerName: customerName,
        customerPhone: '+2' + phone,
        customerAddress: address,
        items: itemsWithPrice,
        totalPrice: totalAfter,
        orderStatus: newStatus,
        appliedDiscount: useDiscount,
        updatedAt: serverTimestamp()
      });
      
      console.log("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
      
      await loadOrders();
      
      // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ø°Ø§ ØªØºÙŠØ±Øª Ø§Ù„Ø­Ø§Ù„Ø©
      if (newStatus !== oldStatus && (newStatus === 'ØªØ­Øª Ø§Ù„ØªØ¬Ù‡ÙŠØ²' || newStatus === 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„')) {
        await sendOrderStatusUpdate(orderId, newStatus, oldStatus);
      }
      
      alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!");
      
      window.showPage('orders');
      
    } catch (err) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨:", err);
      alert("âŒ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨: " + err.message);
    } finally {
      updateBtn.disabled = false;
      loading.style.display = 'none';
      updateBtn.innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨";
    }
  };

  window.printInvoice = function(id) {
    const o = orders.find(x => x.id === id);
    if (!o) return alert("Ø§Ù„Ø·Ù„Ø¨ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯");
    document.getElementById('inv_name').textContent = o.customerName;
    document.getElementById('inv_phone').textContent = o.customerPhone;
    document.getElementById('inv_addr').textContent = o.customerAddress || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
    document.getElementById('inv_date').textContent = new Date().toLocaleString('ar-EG');
    document.getElementById('inv_total').textContent = Number(o.totalPrice).toLocaleString();
    document.getElementById('inv_items').innerHTML = o.items.map(i => `
      <tr>
        <td style="padding:12px;font-weight:bold;border:1px solid #000">${i.name}</td>
        <td style="padding:12px;border:1px solid #000;text-align:center">${i.qty}</td>
        <td style="padding:12px;border:1px solid #000;text-align:center">${Number(i.price || 0).toFixed(0)}</td>
        <td style="padding:12px;border:1px solid #000;text-align:center">${(Number(i.price || 0) * i.qty).toFixed(0)}</td>
      </tr>
    `).join('');
    document.querySelectorAll('.card, .sidebar, #menuBtn').forEach(el => el.style.display = 'none');
    document.body.style.background = 'white';
    document.getElementById('invoice').style.display = 'block';
    setTimeout(() => { window.print(); }, 500);
    window.onafterprint = () => location.reload();
  };

  window.delOrder = id => confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ") && deleteDoc(doc(db,'orders',id)).then(loadOrders);
  
  window.deleteAllOrders = () => {
    if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§ØªØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!")) {
      getDocs(collection(db,"orders")).then(s => { 
        const b = writeBatch(db); 
        s.docs.forEach(d => b.delete(d.ref)); 
        return b.commit(); 
      }).then(loadOrders);
    }
  };
  
  window.deleteAllProducts = () => {
    if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§ØªØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!")) {
      getDocs(collection(db,"products")).then(s => { 
        const b = writeBatch(db); 
        s.docs.forEach(d => b.delete(d.ref)); 
        return b.commit(); 
      }).then(loadProducts);
    }
  };

  function updateDashboard() {
    const today = new Date().toDateString();
    const todayCount = orders.filter(o => o.timestamp && new Date(o.timestamp.toDate()).toDateString() === today).length;
    const completed = orders.filter(o => o.orderStatus === 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„').length;
    const sales = orders.reduce((a,b) => a + (b.totalPrice || 0), 0);
    document.getElementById('totalOrders').innerText = orders.length;
    document.getElementById('todayOrders').innerText = todayCount;
    document.getElementById('completedOrders').innerText = completed;
    document.getElementById('totalSales').innerText = sales.toLocaleString() + ' Ø¬Ù†ÙŠÙ‡';
  }

  window.exportProductsToExcel = () => {
    const data = products.map(p => ({
      "Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬": p.name, "Ø§Ù„ÙƒÙ…ÙŠØ©": p.stock, "Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹": p.sellPrice,
      "Ø§Ù„Ø®ØµÙ… %": p.discount || 0, "Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…": (p.sellPrice * (1 - (p.discount || 0)/100)).toFixed(0),
      "Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯": p.barcode || "", "Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©": p.imageUrl || ""
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    ws['!cols'] = [{wch:25},{wch:10},{wch:12},{wch:10},{wch:15},{wch:20},{wch:50}];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª");
    XLSX.writeFile(wb, "AshryNatural_Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª_" + new Date().toISOString().slice(0,10) + ".xlsx");
  };

  window.exportOrdersToExcel = () => {
    const data = orders.map(o => ({
      "Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„": o.customerName, "Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨": o.customerPhone, "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†": o.customerAddress || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯",
      "Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª": o.items.map(i => `${i.name} Ã— ${i.qty}`).join(" | "), "Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ": o.totalPrice,
      "Ø§Ù„Ø­Ø§Ù„Ø©": o.orderStatus, "Ø§Ù„ØªØ§Ø±ÙŠØ®": o.timestamp?.toDate?.()?.toLocaleString('ar-EG') || ""
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ø·Ù„Ø¨Ø§Øª");
    XLSX.writeFile(wb, "AshryNatural_Ø§Ù„Ø·Ù„Ø¨Ø§Øª_" + new Date().toISOString().slice(0,10) + ".xlsx");
  };

  window.importProductsFromExcel = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async function (ev) {
      try {
        const data = new Uint8Array(ev.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        let added = 0, skipped = 0;
        for (const r of rows) {
          const name = String(r["Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬"] || r["Ø§Ù„Ø§Ø³Ù…"] || "").trim();
          const stock = Number(r["Ø§Ù„ÙƒÙ…ÙŠØ©"] || 0) || 0;
          const sellPrice = Number(r["Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹"] || r["Ø§Ù„Ø³Ø¹Ø±"] || 0) || 0;
          const discount = Number(r["Ø§Ù„Ø®ØµÙ… %"] || 0) || 0;
          const barcode = String(r["Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯"] || "").trim();
          const imageUrl = String(r["Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©"] || "").trim();
          if (!name || sellPrice <= 0) { skipped++; continue; }
          await addDoc(collection(db, "products"), { name, stock, sellPrice, discount, barcode, imageUrl: imageUrl || "" });
          added++;
        }
        alert(`ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯!\nØ£ÙØ¶ÙŠÙ: ${added}\nØªÙ… ØªØ¬Ø§Ù‡Ù„: ${skipped}`);
        
        window.loadProducts();
        
        e.target.value = "";
      } catch (err) { 
        alert("ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù! ØªØ£ÙƒØ¯ Ù…Ù† ØµÙŠØºØ© Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„"); 
      }
    };
    reader.readAsArrayBuffer(file);
  };

  window.editProduct = id => {
    const p = products.find(x => x.id === id);
    document.getElementById('editProductId').value = id;
    document.getElementById('pname').value = p.name;
    document.getElementById('pstock').value = p.stock;
    document.getElementById('psell').value = p.sellPrice;
    document.getElementById('pdiscount').value = p.discount;
    document.getElementById('pbarcode').value = p.barcode || '';
    if(p.imageUrl) document.getElementById('imagePreview').innerHTML = `<img src="${p.imageUrl}" class="product-img-preview">`;
    document.getElementById('productSubmitBtn').innerText = "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
    window.showPage('products');
  };

  window.delP = id => confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ") && deleteDoc(doc(db,"products",id)).then(loadProducts);

  document.getElementById('productForm').onsubmit = async e => {
    e.preventDefault();
    const submitBtn = document.getElementById('productSubmitBtn');
    const loading = document.getElementById('productLoading');
    submitBtn.disabled = true;
    loading.style.display = 'block';
    const id = document.getElementById('editProductId').value;
    let imageUrl = products.find(p => p.id === id)?.imageUrl || '';
    const file = document.getElementById('pimage').files[0];
    if (file && file.size > 3*1024*1024) {
      alert("Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ù‹Ø§! Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø£Ù‚Ù„ Ù…Ù† 3 Ù…ÙŠØ¬Ø§");
      submitBtn.disabled = false;
      loading.style.display = 'none';
      return;
    }
    if (file) {
      const formData = new FormData();
      formData.append('image', file);
      try {
        const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {method:'POST', body:formData});
        const json = await res.json();
        if (json.success) imageUrl = json.data.url;
        else { alert("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©"); submitBtn.disabled = false; loading.style.display = 'none'; return; }
      } catch { alert("Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©"); submitBtn.disabled = false; loading.style.display = 'none'; return; }
    }
    const data = {
      name: document.getElementById('pname').value.trim(),
      stock: +document.getElementById('pstock').value,
      sellPrice: +document.getElementById('psell').value,
      discount: +document.getElementById('pdiscount').value || 0,
      barcode: document.getElementById('pbarcode').value.trim(),
      imageUrl
    };
    try {
      id ? await updateDoc(doc(db,"products",id), data) : await addDoc(collection(db,"products"), data);
      alert(id ? "ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­" : "ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­");
      e.target.reset();
      document.getElementById('imagePreview').innerHTML = '';
      document.getElementById('editProductId').value = '';
      submitBtn.innerText = "Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬";
      loadProducts();
    } catch (err) { alert("Ø®Ø·Ø£: " + err.message); }
    finally {
      submitBtn.disabled = false;
      loading.style.display = 'none';
    }
  };

  document.getElementById('pimage').onchange = e => {
    const file = e.target.files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = ev => document.getElementById('imagePreview').innerHTML = `<img src="${ev.target.result}" class="product-img-preview">`;
      reader.readAsDataURL(file);
    }
  };

  // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  document.addEventListener('DOMContentLoaded', function() {
    // Ù…Ø³ØªÙ…Ø¹ÙŠ Ø£Ø­Ø¯Ø§Ø« ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®ØµÙ…
    document.getElementById('applyDiscount').addEventListener('change', window.renderCart);
    document.getElementById('editApplyDiscount').addEventListener('change', window.renderEditCart);
    
    // Ù…Ø³ØªÙ…Ø¹ÙŠ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    document.getElementById('addToCartBtn').addEventListener('click', window.addToCart);
    document.getElementById('addToEditCartBtn').addEventListener('click', window.addToEditCart);
    document.getElementById('saveOrderBtn').addEventListener('click', window.saveOrder);
    document.getElementById('updateOrderBtn').addEventListener('click', window.updateOrder);
    document.getElementById('exportOrdersBtn').addEventListener('click', window.exportOrdersToExcel);
    document.getElementById('exportProductsBtn').addEventListener('click', window.exportProductsToExcel);
    document.getElementById('deleteAllOrdersBtn').addEventListener('click', window.deleteAllOrders);
    document.getElementById('deleteAllProductsBtn').addEventListener('click', window.deleteAllProducts);
    document.getElementById('importExcelBtn').addEventListener('click', function() {
      document.getElementById('importExcel').click();
    });
    document.getElementById('importExcel').addEventListener('change', window.importProductsFromExcel);
    
    // Ù…Ø³ØªÙ…Ø¹ÙŠ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¨Ø­Ø«
    const searchOrders = document.getElementById('searchOrders');
    const searchProducts = document.getElementById('searchProducts');
    if (searchOrders) searchOrders.addEventListener('input', renderOrders);
    if (searchProducts) searchProducts.addEventListener('input', renderProducts);
    
    // Ù…Ø³ØªÙ…Ø¹ÙŠ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ù„Ø·Ù„Ø¨Ø§Øª
    document.getElementById('flashToggle').addEventListener('click', window.toggleFlash);
    document.getElementById('focusCamera').addEventListener('click', window.focusCamera);
    
    // Ù…Ø³ØªÙ…Ø¹ÙŠ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª
    document.getElementById('productFlashToggle').addEventListener('click', window.toggleProductFlash);
    document.getElementById('focusProductCamera').addEventListener('click', window.focusProductCamera);
    document.getElementById('applyBarcode').addEventListener('click', window.applyScannedBarcode);
    document.getElementById('scanBarcodeForProduct').addEventListener('click', window.scanBarcodeForProduct);
    
    // ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ù‚Ø³Ù… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    document.getElementById('barcodeToggle').addEventListener('click', function() {
      const content = document.getElementById('barcodeContent');
      const isVisible = content.style.display === 'block';
      content.style.display = isVisible ? 'none' : 'block';
      this.classList.toggle('active', !isVisible);
      
      if (!isVisible) {
        // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚Ø³Ù…
        setTimeout(() => {
          window.startBarcodeScanner();
        }, 500);
      } else {
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø³Ù…
        window.stopBarcodeScanner();
      }
    });
    
    document.getElementById('productBarcodeToggle').addEventListener('click', function() {
      const content = document.getElementById('productBarcodeContent');
      const isVisible = content.style.display === 'block';
      content.style.display = isVisible ? 'none' : 'block';
      this.classList.toggle('active', !isVisible);
      
      if (!isVisible) {
        // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù‚Ø³Ù…
        setTimeout(() => {
          window.startProductBarcodeScanner();
        }, 500);
      } else {
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¹Ù†Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø³Ù…
        window.stopProductBarcodeScanner();
      }
    });
  });

  // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ø§Ø®ØªØ¨Ø± Ø§Ù„Ø§ØªØµØ§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
  onAuthStateChanged(auth, user => {
    if (user) {
      document.getElementById('login').style.display = 'none';
      document.querySelector('.sidebar').style.display = 'block';
      document.getElementById('menuBtn').style.display = window.innerWidth <= 992 ? 'block' : 'none';
      window.showPage('dashboard');
      setInterval(() => {
        const currentTime = document.getElementById('currentTime');
        if (currentTime) {
          currentTime.innerText = new Date().toLocaleString('ar-EG');
        }
      }, 1000);
      
      // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
      connectionTestInterval = setInterval(() => {
        autoTestFirebaseConnection();
      }, 5 * 60 * 1000); // 5 Ø¯Ù‚Ø§Ø¦Ù‚
      
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
      window.loadProducts();
      window.loadOrders();
      
    } else {
      hideEverythingExceptLogin();
      if (connectionTestInterval) {
        clearInterval(connectionTestInterval);
        connectionTestInterval = null;
      }
    }
  });
  
</script>

</body>
</html>
